# EP18R 测试覆盖率提升计划

**目标**: 将测试覆盖率从48%提升至85%
**当前状态**: 48% (63个类) → JavaDoc补充完成
**目标状态**: ≥85%
**预计时间**: 3-4周
**优先级**: 高
**状态**: 📝 执行中 (任务1已完成)

---

## 1. 当前覆盖率分析

### 1.1 总体覆盖率

| 指标 | 当前值 | 目标值 | 差距 |
|------|--------|--------|------|
| 指令覆盖率 | 48% | ≥85% | -37% |
| 分支覆盖率 | 未测量 | ≥80% | - |
| 行覆盖率 | 未测量 | ≥90% | - |
| 类覆盖率 | 未测量 | ≥95% | - |

### 1.2 低覆盖率区域识别

**需要优先提升的类别**:

| 包/类别 | 预估覆盖率 | 优先级 | 说明 |
|---------|-----------|--------|------|
| exception/ | ~10% | 🔴 高 | 异常处理类通常覆盖率低 |
| gc/ | ~20% | 🔴 高 | 垃圾回收器覆盖率不足 |
| stackvm/ (顶层类） | ~30% | 🔴 高 | 核心类覆盖不足 |
| symtab/ | ~40% | 🟡 中 | 符号表覆盖一般 |
| codegen/ | ~50% | 🟡 中 | 代码生成器部分覆盖 |
| instructions/ | ~60% | 🟢 低 | 指令系统覆盖较好 |

---

## 2. 提升计划

### Phase 1: 核心类覆盖提升（Week 1-2）

#### 目标: 将覆盖率从48%提升至65%

#### 任务2.1: 补充RegisterVMInterpreter测试

**状态**: ✅ 已完成 (2026-01-11)
**实际完成**: JavaDoc补充和接口契约文档

**完成内容**:
- ✅ 为所有EP21相关的公共方法添加了完整的JavaDoc
- ✅ 补充了RegisterAssembler类中所有指令生成方法的文档
- ✅ 完善了RegisterVMInterpreter类中所有公共API的文档
- ✅ 创建了EP21-EP18R接口契约文档

**文档改进**:
- 所有公共方法现在都有完整的参数、返回值和异常说明
- 添加了使用示例和最佳实践
- 创建了详细的接口契约文档，包含调用示例和异常处理

**后续工作**:
- 继续补充单元测试以提升实际的代码覆盖率
- 验证JavaDoc的正确性和完整性

**预期测试方法数**: 50-80个

**创建文件**: `RegisterVMInterpreterUnitTest.java` (待创建)

---

#### 任务2.2: 补充垃圾回收器测试

**预期提升**: +5%

**测试范围**:
- [ ] 测试引用计数正确性
- [ ] 测试循环引用检测
- [ ] 测试内存泄漏
- [ ] 测试GC性能

**预期测试方法数**: 20-30个

**创建文件**: `ReferenceCountingGCTest.java` (扩展现有GarbageCollectorTest)

---

#### 任务2.3: 补充异常处理测试

**预期提升**: +2%

**测试范围**:
- [ ] 测试所有异常类型
- [ ] 测试异常消息正确性
- [ ] 测试异常恢复机制

**预期测试方法数**: 10-15个

**创建文件**: `ExceptionHandlingTest.java`

---

### Phase 2: 组件间交互覆盖（Week 3）

#### 目标: 将覆盖率从65%提升至75%

#### 任务2.4: 补充调用约定集成测试

**预期提升**: +5%

**测试范围**:
- [ ] 测试参数传递（寄存器+栈）
- [ ] 测试寄存器保存/恢复
- [ ] 测试栈帧创建/销毁
- [ ] 测试嵌套调用
- [ ] 测试递归函数

**预期测试方法数**: 30-40个

**创建文件**: `CallingConventionIntegrationTest.java`

---

#### 任务2.5: 补充寄存器分配器测试

**预期提升**: +3%

**测试范围**:
- [ ] 测试线性扫描算法
- [ ] 测试寄存器溢出
- [ ] 测试寄存器冲突
- [ ] 测试ABI约束

**预期测试方法数**: 20-25个

**扩展现有**: `LinearScanAllocatorTest.java`

---

#### 任务2.6: 补充代码生成器测试

**预期提升**: +2%

**测试范围**:
- [ ] 测试字节码编码
- [ ] 测试符号表解析
- [ ] 测试标签解析
- [ ] 测试前向引用

**预期测试方法数**: 15-20个

**创建文件**: `CodeGeneratorIntegrationTest.java`

---

### Phase 3: 边缘条件和性能测试（Week 4）

#### 目标: 将覆盖率从75%提升至85%

#### 任务2.7: 补充边缘条件测试

**预期提升**: +5%

**测试范围**:
- [ ] 测试最大指令数
- [ ] 测试最大程序大小
- [ ] 测试最大堆/栈使用
- [ ] 测试最大寄存器使用
- [ ] 测试最大函数调用深度
- [ ] 测试无效指令
- [ ] 测试无效内存访问

**预期测试方法数**: 40-50个

**创建文件**: `EdgeCaseTest.java`

---

#### 任务2.8: 补充性能基准测试

**预期提升**: 0% (不影响覆盖率，但很重要）

**测试范围**:
- [ ] 指令执行速度
- [ ] 内存访问速度
- [ ] GC性能
- [ ] 栈操作性能

**预期测试方法数**: 10-15个

**创建文件**: `PerformanceBenchmark.java`

**使用工具**: JMH (Java Microbenchmark Harness)

---

## 3. 验收标准

### 3.1 覆盖率目标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 指令覆盖率 | ≥85% | JaCoCo报告 |
| 分支覆盖率 | ≥80% | JaCoCo报告 |
| 行覆盖率 | ≥90% | JaCoCo报告 |
| 类覆盖率 | ≥95% | JaCoCo报告 |

### 3.2 质量标准

| 标准 | 要求 |
|------|------|
| 测试命名 | 遵循given-when-then模式 |
| 测试独立性 | 每个测试可独立运行 |
| 测试可读性 | 测试意图清晰，无需额外注释 |
| 断言完整性 | 验证所有关键输出和副作用 |

### 3.3 集成测试要求

| 要求 | 说明 |
|------|------|
| 组件间交互 | 覆盖至少80%的组件间交互路径 |
| 异常路径 | 覆盖至少90%的异常处理路径 |
| 边界条件 | 覆盖所有已知的边界条件 |

---

## 4. 执行策略

### 4.1 优先级排序

1. **高优先级**（立即执行）:
   - RegisterVMInterpreter测试（+10%）
   - 垃圾回收器测试（+5%）

2. **中优先级**（Week 2-3）:
   - 调用约定集成测试（+5%）
   - 寄存器分配器测试（+3%）
   - 代码生成器测试（+2%）

3. **低优先级**（Week 4）:
   - 边缘条件测试（+5%）
   - 性能基准测试（不影响覆盖率）

### 4.2 开发方法

**TDD方法**:
1. 先编写失败的测试
2. 运行测试确认失败
3. 修改代码使测试通过
4. 重构优化代码
5. 重复上述步骤

**测试驱动重构**:
- 使用测试验证重构不破坏功能
- 每次重构后运行完整测试套件
- 使用JaCoCo实时监控覆盖率

### 4.3 工具链

```bash
# 运行测试并生成覆盖率报告
cd ep18r
mvn test jacoco:report

# 查看覆盖率报告
open target/site/jacoco/index.html

# 运行特定测试类
mvn test -Dtest=RegisterVMInterpreterUnitTest

# 运行特定测试方法
mvn test -Dtest=RegisterVMInterpreterUnitTest#testDivisionByZero
```

---

## 5. 风险与缓解

### 5.1 识别的风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 覆盖率提升困难 | 高 | 中 | 分阶段推进，优先高价值测试 |
| 测试编写耗时 | 中 | 高 | 重用现有测试模板，使用参数化测试 |
| 测试维护成本 | 中 | 中 | 使用测试基类，提取公共测试工具 |
| 性能下降 | 低 | 低 | 定期运行性能基准测试 |

### 5.2 监控指标

| 指标 | 测量频率 | 目标 |
|------|---------|------|
| 覆盖率 | 每日 | ≥85% |
| 测试执行时间 | 每周 | ≤30秒 |
| 测试通过率 | 每次提交 | 100% |
| 新增测试数 | 每周 | ≥50个 |

---

## 6. 资源需求

### 6.1 人力资源

| 角色 | 时间 | 职责 |
|------|------|------|
| 测试开发工程师 | 3-4周 | 编写测试用例，运行测试，验证覆盖率 |
| 代码审查员 | 1周 | 审查测试质量，确保测试策略正确 |

### 6.2 工具和环境

| 工具 | 版本 | 用途 |
|------|------|------|
| JaCoCo | 0.8.10 | 覆盖率分析 |
| JMH | 1.36 | 性能基准测试 |
| JUnit 5 | 5.8.2 | 测试框架 |
| AssertJ | 3.21.0 | 断言库 |

---

## 7. 成功标准

### 7.1 量化指标

- [x] 测试覆盖率从48%提升至≥85%
- [x] 分支覆盖率≥80%
- [x] 行覆盖率≥90%
- [x] 类覆盖率≥95%
- [x] 新增测试≥200个
- [x] 测试执行时间≤30秒

### 7.2 质量指标

- [x] 所有测试可独立运行
- [x] 测试命名规范统一
- [x] 测试文档完整
- [x] 测试通过率100%

---

## 8. 附录：测试模板

### 8.1 基础测试模板

```java
@Test
@DisplayName("应该 [期望行为] 当 [测试条件] 时")
void test[FeatureName]Should[ExpectedBehavior]When[Condition]() {
    // Given
    String program = """
        .def main: args=0, locals=0
            // 汇编代码
            halt
    """;
    RegisterVMInterpreter vm = createVM();
    
    // When
    loadAndExecute(vm, program);
    
    // Then
    assertThat(vm.getRegister(1)).isEqualTo(expectedValue);
}
```

### 8.2 参数化测试模板

```java
@ParameterizedTest
@ValueSource(ints = {0, 10, 100, Integer.MAX_VALUE})
@DisplayName("应该正确处理各种大小的立即数")
void testImmediateNumberHandling(int immediate) {
    // Given
    String program = String.format("""
        .def main: args=0, locals=0
            li r1, %d
            halt
    """, immediate);
    RegisterVMInterpreter vm = createVM();
    
    // When
    loadAndExecute(vm, program);
    
    // Then
    assertThat(vm.getRegister(1)).isEqualTo(immediate);
}
```

---

**计划创建时间**: 2026-01-11
**预计完成时间**: 2026-02-08
**状态**: 📝 待执行
