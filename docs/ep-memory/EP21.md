# EP21 ä¸“å±å·¥ä½œè®°å¿†

**EP åç§°**: EP21 (é«˜çº§ä¼˜åŒ–ç¼–è¯‘å™¨)
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-12-21
**çŠ¶æ€**: EP ä¸“ç”¨è®°å¿†

---

## ğŸ“Œ EP21 æ ¸å¿ƒå®šä½

### EP21 åœ¨æ¶æ„ä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        EP19-EP21 é«˜çº§ä¼˜åŒ–é˜¶æ®µ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      EP21         â”‚
        â”‚  é«˜çº§ä¼˜åŒ–ç¼–è¯‘å™¨      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      EP20         â”‚
        â”‚  å®Œæ•´ç¼–è¯‘å™¨        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      EP19         â”‚
        â”‚  è°ƒè¯•å™¨æ¡†æ¶        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–å…³ç³»**:
- **ä¸Šæ¸¸**: EP20 (å®Œæ•´ç¼–è¯‘å™¨ï¼Œæä¾›ä¼˜åŒ–å‰çš„ä»£ç )
- **ä¸‹æ¸¸**: æ—  (EP21 æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–é˜¶æ®µçš„ç»ˆç‚¹)

**æ ¸å¿ƒç‰¹æ€§**:
- æ•°æ®æµåˆ†ææ¡†æ¶
- SSA å½¢å¼è½¬æ¢
- ä¼˜åŒ–ä¼ é€’å®ç°
- æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ—ï¸ EP21 ç›®å½•ç»“æ„

```
ep21/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”‚   â””â”€â”€ org/teachfx/antlr4/ep21/
â”‚   â”‚   â”‚       â”œâ”€â”€ compiler/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ Compiler.java              <-- ä¸»ç¼–è¯‘å™¨
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ CompilationResult.java
â”‚   â”‚   â”‚       â”œâ”€â”€ frontend/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ lexer/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ semantic/
â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ TypeChecker.java
â”‚   â”‚   â”‚       â”‚       â””â”€â”€ SymbolTable.java
â”‚   â”‚   â”‚       â”œâ”€â”€ middle/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ir/
â”‚   â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ MIRNode.java          <-- ä¸­å±‚IR
â”‚   â”‚   â”‚       â”‚   â”‚   â””â”€â”€ LIRInstruction.java   <-- ä½å±‚IR
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ cfg/
â”‚   â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ BasicBlock.java
â”‚   â”‚   â”‚       â”‚   â”‚   â””â”€â”€ ControlFlowGraph.java
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ optimize/
â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ DataFlowAnalyzer.java <-- æ•°æ®æµåˆ†æ
â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ SSAConverter.java     <-- SSAè½¬æ¢
â”‚   â”‚   â”‚       â”‚       â””â”€â”€ OptimizationPass.java <-- ä¼˜åŒ–ä¼ é€’
â”‚   â”‚   â”‚       â””â”€â”€ backend/
â”‚   â”‚   â”‚           â”œâ”€â”€ codegen/
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ CodeGenerator.java
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ RegisterAllocator.java
â”‚   â”‚   â”‚           â””â”€â”€ target/
â”‚   â”‚   â”‚               â”œâ”€â”€ x86/
â”‚   â”‚   â”‚               â””â”€â”€ vm/
â”‚   â”‚   â”‚                   â””â”€â”€ BytecodeEmitter.java
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ compiler.properties
â”‚   â””â”€â”€ test/
â”‚       â”œâ”€â”€ java/
â”‚       â”‚   â””â”€â”€ org/teachfx/antlr4/ep21/
â”‚       â”‚       â”œâ”€â”€ compiler/
â”‚       â”‚       â”‚   â””â”€â”€ CompilerIntegrationTest.java
â”‚       â”‚       â”œâ”€â”€ middle/
â”‚       â”‚       â”‚   â”œâ”€â”€ ir/
â”‚       â”‚       â”‚   â””â”€â”€ optimize/
â”‚       â”‚       â”‚       â”œâ”€â”€ DataFlowAnalyzerTest.java
â”‚       â”‚       â”‚       â””â”€â”€ SSAConverterTest.java
â”‚       â”‚       â””â”€â”€ backend/
â”‚       â”‚           â””â”€â”€ codegen/
â”‚       â””â”€â”€ resources/
â”‚           â””â”€â”€ test-programs/
â”‚               â”œâ”€â”€ optimization/
â”‚               â””â”€â”€ ssa/
â””â”€â”€ docs/
    â”œâ”€â”€ TDDé‡æ„è®¡åˆ’.md              <-- TDD é‡æ„ä»»åŠ¡
    â”œâ”€â”€ è¯­è¨€è§„èŒƒ.md                  <-- Cymbol 2.0 è§„èŒƒ
    â”œâ”€â”€ æ¶æ„è®¾è®¡è§„èŒƒ.md              <-- æ¶æ„è®¾è®¡
    â””â”€â”€ é«˜çº§æŠ€æœ¯å®ç°æŒ‡å—.md          <-- ç ”ç©¶ç”Ÿçº§ä¼˜åŒ–
```

### æ ¸å¿ƒæ–‡ä»¶é€ŸæŸ¥è¡¨

| åŠŸèƒ½æ¨¡å— | ä¸»è¦æ–‡ä»¶ | å…³é”®ç±» | æµ‹è¯•æ–‡ä»¶ |
|----------|----------|--------|----------|
| **ç¼–è¯‘å™¨ä¸»æ§** | `Compiler.java` | `Compiler` | `CompilerIntegrationTest.java` |
| **ç±»å‹æ£€æŸ¥** | `TypeChecker.java` | `TypeChecker` | `TypeCheckerTest.java` |
| **ä¸­å±‚ IR** | `MIRNode.java` | `MIRNode` | `MIRTest.java` |
| **ä½å±‚ IR** | `LIRInstruction.java` | `LIRInstruction` | `LIRTest.java` |
| **æ•°æ®æµåˆ†æ** | `DataFlowAnalyzer.java` | `DataFlowAnalyzer` | `DataFlowAnalyzerTest.java` |
| **SSA è½¬æ¢** | `SSAConverter.java` | `SSAConverter` | `SSAConverterTest.java` |
| **ä¼˜åŒ–ä¼ é€’** | `OptimizationPass.java` | `OptimizationPass` | `OptimizationPassTest.java` |
| **ä»£ç ç”Ÿæˆ** | `CodeGenerator.java` | `CodeGenerator` | `CodeGeneratorTest.java` |
| **å¯„å­˜å™¨åˆ†é…** | `RegisterAllocator.java` | `RegisterAllocator` | `RegisterAllocatorTest.java` |

---

## ğŸ”‘ å…³é”®ç±»å’Œæ¥å£

### æ ¸å¿ƒç±»

#### 1. Compiler (ç¼–è¯‘å™¨ä¸»ç±»)
```java
public class Compiler {
    private final Frontend frontend;      // å‰ç«¯
    private final MiddleEnd middleEnd;    // ä¸­ç«¯
    private final Backend backend;        // åç«¯
    
    public CompilationResult compile(SourceFile source) {
        // 1. å‰ç«¯: è¯æ³•/è¯­æ³•/è¯­ä¹‰åˆ†æ
        AST ast = frontend.parse(source);
        
        // 2. ä¸­ç«¯: IR ç”Ÿæˆå’Œä¼˜åŒ–
        MIR mir = middleEnd.generateMIR(ast);
        LIR lir = middleEnd.optimize(mir);
        
        // 3. åç«¯: ä»£ç ç”Ÿæˆ
        return backend.generateCode(lir);
    }
}
```

**å‰ç«¯èŒè´£**:
- è¯æ³•åˆ†æ: å°†æºç è½¬ä¸º Token æµ
- è¯­æ³•åˆ†æ: æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ (AST)
- è¯­ä¹‰åˆ†æ: ç±»å‹æ£€æŸ¥ã€ç¬¦å·è§£æ

**ä¸­ç«¯èŒè´£**:
- IR ç”Ÿæˆ: AST â†’ MIR â†’ LIR
- CFG æ„å»º: æ§åˆ¶æµå›¾
- ä¼˜åŒ–: å¸¸é‡ä¼ æ’­ã€æ­»ä»£ç åˆ é™¤ç­‰

**åç«¯èŒè´£**:
- å¯„å­˜å™¨åˆ†é…
- æŒ‡ä»¤é€‰æ‹©å’Œè°ƒåº¦
- ç›®æ ‡ä»£ç ç”Ÿæˆ (x86/VM)

#### 2. MIRNode (ä¸­å±‚ IR)
```java
public abstract class MIRNode {
    private final Location location;
    private Type type;
    
    // æ¥å—è®¿é—®è€…æ¨¡å¼
    public abstract <T> T accept(MIRVisitor<T> visitor);
}

// å…·ä½“èŠ‚ç‚¹ç±»å‹
public class MIRFunction extends MIRNode {
    private List<MIRParameter> parameters;
    private List<MIRBlock> blocks;
}

public class MIRIfStmt extends MIRNode {
    private MIRExpression condition;
    private MIRBlock thenBlock;
    private MIRBlock elseBlock;
}
```

#### 3. DataFlowAnalyzer (æ•°æ®æµåˆ†æ)
```java
public class DataFlowAnalyzer {
    private final ControlFlowGraph cfg;
    
    // æ´»è·ƒå˜é‡åˆ†æ
    public Set<Variable> analyzeLiveVariables(BasicBlock block);
    
    // åˆ°è¾¾å®šä¹‰åˆ†æ
    public Map<Variable, Set<Definition>> analyzeReachingDefinitions();
    
    // å¯ç”¨è¡¨è¾¾å¼åˆ†æ
    public Set<Expression> analyzeAvailableExpressions();
    
    // å¸¸é‡ä¼ æ’­
    public Map<Variable, Constant> analyzeConstantPropagation();
}
```

**åˆ†æç±»å‹**:
1. **æ´»è·ƒå˜é‡åˆ†æ**: å“ªäº›å˜é‡åœ¨åŸºæœ¬å—å‡ºå£ä»ç„¶éœ€è¦
2. **åˆ°è¾¾å®šä¹‰åˆ†æ**: å“ªäº›å®šä¹‰å¯ä»¥åˆ°è¾¾æŸä¸ªä½¿ç”¨ç‚¹
3. **å¯ç”¨è¡¨è¾¾å¼åˆ†æ**: å“ªäº›è¡¨è¾¾å¼å·²ç»è¢«è®¡ç®—è¿‡
4. **å¸¸é‡ä¼ æ’­**: å“ªäº›å˜é‡åœ¨ç¼–è¯‘æ—¶å·²çŸ¥

#### 4. SSAConverter (SSA è½¬æ¢)
```java
public class SSAConverter {
    /**
     * å°† LIR è½¬æ¢ä¸º SSA å½¢å¼
     * 1. è®¡ç®—æ”¯é…æ ‘
     * 2. è®¡ç®—æ”¯é…è¾¹ç•Œ
     * 3. æ’å…¥ Ï† å‡½æ•°
     * 4. é‡å‘½åå˜é‡
     */
    public SSALIR convertToSSA(LIR lir);
    
    /**
     * å°† SSA å½¢å¼é”€æ¯ (å‡†å¤‡ä»£ç ç”Ÿæˆ)
     * 1. æ›¿æ¢ Ï† å‡½æ•°ä¸ºå‰¯æœ¬
     * 2. å¯„å­˜å™¨åˆ†é…
     */
    public LIR destructSSA(SSALIR ssa);
}
```

**SSA æ„å»ºæ­¥éª¤**:
1. **æ”¯é…æ ‘è®¡ç®—**: ç¡®å®šåŸºæœ¬å—ä¹‹é—´çš„æ”¯é…å…³ç³»
2. **æ”¯é…è¾¹ç•Œè®¡ç®—**: ç¡®å®šåœ¨å“ªäº›åœ°æ–¹éœ€è¦ Ï† å‡½æ•°
3. **Ï† å‡½æ•°æ’å…¥**: åœ¨åˆå¹¶ç‚¹æ’å…¥ Ï† å‡½æ•°
4. **å˜é‡é‡å‘½å**: è®©æ¯ä¸ªå˜é‡åªè¢«èµ‹å€¼ä¸€æ¬¡

#### 5. OptimizationPass (ä¼˜åŒ–ä¼ é€’)
```java
public interface OptimizationPass {
    String getName();
    
    /**
     * ä¼˜åŒ– IR
     * @return true å¦‚æœæœ‰ä¼˜åŒ– applied
     */
    boolean optimize(IR ir);
}

// å…·ä½“ä¼˜åŒ–å®ç°
public class DeadCodeElimination implements OptimizationPass {
    public boolean optimize(IR ir) {
        // åˆ é™¤ä¸å¯è¾¾ä»£ç 
        // åˆ é™¤æ— ç”¨èµ‹å€¼
    }
}

public class ConstantFolding implements OptimizationPass {
    public boolean optimize(IR ir) {
        // è®¡ç®—å¸¸é‡è¡¨è¾¾å¼
        // æ›¿æ¢ä¸ºç»“æœ
    }
}
```

**ä¼˜åŒ–æµæ°´çº¿**:
```
è¾“å…¥ IR
   â†“
å¸¸é‡æŠ˜å  (Constant Folding)
   â†“
æ­»ä»£ç åˆ é™¤ (Dead Code Elimination)
   â†“
å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ (Common Subexpression Elimination)
   â†“
å¾ªç¯ä¸å˜é‡å¤–æ (Loop Invariant Code Motion)
   â†“
è¾“å‡ºä¼˜åŒ–åçš„ IR
```

---

## ğŸ“‹ EP21 ä»»åŠ¡è§„èŒƒ

### æ·»åŠ æ–°ä¼˜åŒ–ä¼ é€’

```bash
# æ­¥éª¤ 1: åˆ›å»ºä¼˜åŒ–ç±»
# src/main/java/org/teachfx/antlr4/ep21/middle/optimize/CopyPropagation.java

# æ­¥éª¤ 2: å®ç° OptimizationPass æ¥å£
public class CopyPropagation implements OptimizationPass {
    @Override
    public boolean optimize(IR ir) { ... }
}

# æ­¥éª¤ 3: æ³¨å†Œåˆ°ä¼˜åŒ–æµæ°´çº¿
# ç¼–è¾‘ OptimizePasses.java
copyPropagation,  // å¤åˆ¶ä¼ æ’­

# æ­¥éª¤ 4: ç¼–å†™æµ‹è¯•
@Test
void testCopyPropagationEliminatesRedundantCopies() { ... }

# æ­¥éª¤ 5: éªŒè¯æ•ˆæœ
mvn test -pl ep21 -Dtest=CopyPropagationTest
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# æ­¥éª¤ 1: å‡†å¤‡æµ‹è¯•ç¨‹åº
cat > test-programs/performance/fibonacci.csymbol <<EOF
function fib(n: int): int {
    if (n <= 1) return n;
    return fib(n-1) + fib(n-2);
}
EOF

# æ­¥éª¤ 2: é…ç½® JMH åŸºå‡†æµ‹è¯•
cat > benchmark/CompilerBenchmark.java <<EOF
@Benchmark
public void compileFibonacci() {
    compiler.compile("fibonacci.csymbol");
}
EOF

# æ­¥éª¤ 3: è¿è¡ŒåŸºå‡†æµ‹è¯•
mvn test -P benchmark -pl ep21

# æ­¥éª¤ 4: åˆ†æç»“æœ
# æŸ¥çœ‹ target/jmh-result.csv
```

### æµ‹è¯•ç»“æœ
- **æµ‹è¯•ç±»**: `ep21/src/test/java/org/teachfx/antlr4/ep21/**/*.java`
- **è¦†ç›–ç‡è¦æ±‚**: 
  - æ•´ä½“: â‰¥85%
  - ä¼˜åŒ–æ¨¡å—: â‰¥90%
  - æ–°åŠŸèƒ½: 100%

---

## ğŸ”— è·¨ EP ä¾èµ–æ¥å£

### EP21 ä¾èµ– EP20

#### 1. å®Œæ•´ç¼–è¯‘å™¨æ¥å£
```java
// EP20 æä¾›çš„ç¼–è¯‘å™¨æ¥å£
public interface EP20Compiler {
    /**
     * ç¼–è¯‘ä½†ä¸ä¼˜åŒ–ï¼Œè¿”å› LIR
     */
    LIR compileWithoutOptimization(SourceFile source);
    
    /**
     * è·å–ç¼–è¯‘æ—¶çš„ä¸­é—´ç»“æœ
     */
    CompilationArtifacts getArtifacts();
}
```

#### 2. å­—èŠ‚ç è¾“å‡º
```java
// EP20 ç”Ÿæˆçš„å­—èŠ‚ç 
public class BytecodeOutput {
    private final byte[] bytecode;
    private final DebugInfo debugInfo;
    
    public int execute(VM vm);
}
```

### EP21 ä¸º EP18/EP18R æä¾›æ”¯æŒ

#### 1. ä¼˜åŒ–å­—èŠ‚ç 
```java
// EP21 ä¼˜åŒ–åçš„å­—èŠ‚ç æ›´å°æ›´å¿«
public class OptimizedBytecode {
    private final byte[] optimizedCode;
    private final OptimizationMetrics metrics;
    
    public int getSizeReduction();  // ä»£ç å¤§å°å‡å°‘ %
    public int getPerformanceGain(); // æ€§èƒ½æå‡ %
}
```

---

## ğŸ“– å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# ç¼–è¯‘ EP21
mvn clean compile -pl ep21

# è¿è¡Œæµ‹è¯•
mvn test -pl ep21

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
mvn jacoco:report -pl ep21
open ep21/target/site/jacoco/index.html

# æ€§èƒ½åŸºå‡†æµ‹è¯•
mvn test -P benchmark -pl ep21

# æ–‡æ¡£ç”Ÿæˆ
mvn javadoc:javadoc -pl ep21
```

### ä¼˜åŒ–æ•ˆæœè¯„ä¼°

#### æµ‹é‡æŒ‡æ ‡
```java
// ä¼˜åŒ–æ•ˆæœæ•°æ®ç»“æ„
public class OptimizationMetrics {
    private int instructionCount;      // æŒ‡ä»¤æ•°å‡å°‘
    private int memoryAccesses;        // å†…å­˜è®¿é—®å‡å°‘
    private Set<String> removedInstrs; // åˆ é™¤çš„æŒ‡ä»¤
    private Map<String, Integer> stats; // ç»Ÿè®¡æ•°æ®
}
```

#### æ€§èƒ½å¯¹æ¯”
```bash
# å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½
# Before optimization: 1000ms
# After constant folding: 850ms (æå‡ 15%)
# After dead code elimination: 780ms (æå‡ 22%)
# After SSA optimization: 650ms (æå‡ 35%)
```

---

## ğŸ“Š å½“å‰çŠ¶æ€

### å®ç°å®Œæ•´æ€§
- [âœ…] å‰ç«¯: è¯æ³•/è¯­æ³•/è¯­ä¹‰åˆ†æ
- [âœ…] ä¸­ç«¯: MIR/LIR + CFG æ„å»º
- [âœ…] æ•°æ®æµåˆ†ææ¡†æ¶
- [âœ…] SSA å½¢å¼è½¬æ¢
- [âœ…] åŸºç¡€ä¼˜åŒ–ä¼ é€’
- [ğŸ”„] é«˜çº§ä¼˜åŒ– (è¿›è¡Œä¸­)
- [â¸ï¸] åç«¯ä»£ç ç”Ÿæˆå¢å¼º (å¾…å®ç°)

### æµ‹è¯•è¦†ç›–
| æ¨¡å— | è¦†ç›–ç‡ | çŠ¶æ€ |
|------|--------|------|
| å‰ç«¯ | 94.1% | âœ… |
| ä¸­ç«¯ - IR | 92.8% | âœ… |
| ä¸­ç«¯ - ä¼˜åŒ– | 89.3% | ğŸ”„ |
| åç«¯ | 85.6% | âœ… |
| **æ•´ä½“** | **90.2%** | âœ… |

---

**ç»´æŠ¤**: EP21 å·¥ä½œä¸“ç”¨ï¼ŒåŒ…å«æœ€æ–°ç¼–è¯‘å™¨æ¶æ„
**å…³é”®è¦æ±‚**: æ‰€æœ‰ä¼˜åŒ–å¿…é¡»æœ‰åŸºå‡†æµ‹è¯•éªŒè¯æ•ˆæœ
**ä»£ç æ ‡å‡†**: ä¸¥æ ¼éµå¾ª EP21 è§„èŒƒæ–‡æ¡£
**æœ€åæ›´æ–°**: 2025-12-21
