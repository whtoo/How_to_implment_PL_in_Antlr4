# EP11: è¡¨è¾¾å¼ASTæ„å»ºä¸æ±‚å€¼ - æ•™å­¦æ–‡æ¡£

**ç¼–è¯‘å™¨æ„é€ é˜¶æ®µ**: å‰ç«¯åˆ°ä¸­ç«¯è¿‡æ¸¡
**éš¾åº¦ç­‰çº§**: â­â­ åˆçº§-ä¸­çº§
**é¢„è®¡å­¦æ—¶**: 4å°æ—¶
**å‰ç½®çŸ¥è¯†**: EP3ï¼ˆParseTreeæ„å»ºï¼‰

---

## ğŸ—ï¸ ç¬¬ä¸€å±‚ï¼šæ¶æ„å…¨æ™¯

### 1.1 EP11åœ¨ç¼–è¯‘ç®¡çº¿ä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´ç¼–è¯‘ç®¡çº¿                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  EP3: ParseTree  â”‚  EP11: è‡ªå®šä¹‰AST  â”‚  EP16: çº¿æ€§IR     â”‚
â”‚  (åŒ…å«è¯­æ³•å™ªéŸ³)   â”‚  (è¯­ä¹‰å¹²å‡€çš„æ ‘)    â”‚  (ä¸­é—´è¡¨ç¤º)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     EP11çš„ä½ç½®                            â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  ParseTree  â”‚   è¯­ä¹‰æŠ½è±¡ + ç±»å‹å®‰å…¨    â”‚   è‡ªå®šä¹‰AST      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚   çš„è¡¨è¾¾å¼å±‚æ¬¡ç»“æ„      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹ç‚¹**:
- **è¯­ä¹‰æŠ½è±¡**: å»é™¤è¯­æ³•å™ªéŸ³ï¼Œåªä¿ç•™è¯­ä¹‰ä¿¡æ¯
- **ç±»å‹å®‰å…¨**: é€šè¿‡ç»§æ‰¿å±‚æ¬¡ç»“æ„å®ç°ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- **çµæ´»æ‰©å±•**: å¯æ·»åŠ è¯­ä¹‰å±æ€§ï¼ˆç±»å‹ã€å€¼ã€ä½œç”¨åŸŸç­‰ï¼‰
- **åŒé‡Visitoråº”ç”¨**: BuildAstVisitor (æ„å»º) + EvalExprVisitor (æ±‚å€¼)

### 1.2 å››å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: åº”ç”¨ç¼–æ’å±‚ (Application)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Calc: å®Œæ•´çš„ç¼–è¯‘å™¨å‰ç«¯æµç¨‹                     â”‚  â”‚
â”‚  â”‚  - åˆ›å»ºLexer/Parser                            â”‚  â”‚
â”‚  â”‚  - BuildAstVisitoræ„å»ºAST                      â”‚  â”‚
â”‚  â”‚  - EvalExprVisitoræ±‚å€¼                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: å…·ä½“å®ç°å±‚ (Concrete Implementation)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  èŠ‚ç‚¹å®ç°:                                      â”‚  â”‚
â”‚  â”‚  - AdditionNode, SubtractionNode, ...          â”‚  â”‚
â”‚  â”‚  - NumberNode, NegateNode                      â”‚  â”‚
â”‚  â”‚                                                â”‚  â”‚
â”‚  â”‚  Visitorå®ç°:                                   â”‚  â”‚
â”‚  â”‚  - BuildAstVisitor (ParseTree â†’ AST)           â”‚  â”‚
â”‚  â”‚  - EvalExprVisitor (AST â†’ Double)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: æŠ½è±¡ä¸­é—´å±‚ (Abstract Intermediate)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  InfixExpressionNode: äºŒå…ƒè¡¨è¾¾å¼åŸºç±»            â”‚  â”‚
â”‚  â”‚  - å°è£…left/rightå­æ ‘                          â”‚  â”‚
â”‚  â”‚  - æä¾›ç»Ÿä¸€çš„getteræ–¹æ³•                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: æ¡†æ¶å±‚ (Framework)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ExpressionNode: æ‰€æœ‰èŠ‚ç‚¹çš„æŠ½è±¡åŸºç±»             â”‚  â”‚
â”‚  â”‚  ASTVisitor<T>: Visitoræ¥å£                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
```

### 1.3 æ„é€ é€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EP11çš„å››é˜¶æ®µæ„é€ é€»è¾‘                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ1: ASTèŠ‚ç‚¹å±‚æ¬¡å®šä¹‰ (Node Hierarchy Definition)
    â†“
    å®šä¹‰ ExpressionNode (æŠ½è±¡åŸºç±»)
    å®šä¹‰ InfixExpressionNode (äºŒå…ƒè¡¨è¾¾å¼åŸºç±»)
    å®šä¹‰å…·ä½“èŠ‚ç‚¹ç±»å‹ (Number, Addition, Subtraction, ...)
    â†“
é˜¶æ®µ2: Visitoræ¡†æ¶å®šä¹‰ (Visitor Framework Definition)
    â†“
    å®šä¹‰ ASTVisitor<T> æ¥å£
    æä¾›visit(ExpressionNode)åˆ†å‘æ–¹æ³•
    æ”¯æŒæ³›å‹è¿”å›å€¼
    â†“
é˜¶æ®µ3: ASTæ„å»ºVisitor (AST Builder Visitor)
    â†“
    BuildAstVisitor extends MathBaseVisitor<ExpressionNode>
    è®¿é—®ParseTreeçš„æ¯ä¸ªèŠ‚ç‚¹
    åˆ›å»ºå¯¹åº”çš„è‡ªå®šä¹‰ASTèŠ‚ç‚¹
    è¿”å›å®Œæ•´çš„ASTæ ‘
    â†“
é˜¶æ®µ4: ASTæ±‚å€¼Visitor (AST Evaluator Visitor)
    â†“
    EvalExprVisitor implements ASTVisitor<Double>
    é€’å½’éå†ASTèŠ‚ç‚¹
    æ‰§è¡Œå¯¹åº”çš„è¿ç®—
    è¿”å›è®¡ç®—ç»“æœ
```

### 1.4 ä¾èµ–å…³ç³»å›¾

```
ç»§æ‰¿å…³ç³» (extends):

ExpressionNode (æŠ½è±¡åŸºç±»)
    â†“
    â”œâ”€â”€ InfixExpressionNode (äºŒå…ƒè¡¨è¾¾å¼åŸºç±»)
    â”‚     â†“
    â”‚     â”œâ”€â”€ AdditionNode
    â”‚     â”œâ”€â”€ SubtractionNode
    â”‚     â”œâ”€â”€ MultiplicationNode
    â”‚     â””â”€â”€ DivisionNode
    â”‚
    â”œâ”€â”€ NegateNode (ä¸€å…ƒå–è´Ÿ)
    â””â”€â”€ NumberNode (å¶å­èŠ‚ç‚¹)

ä½¿ç”¨å…³ç³» (uses):

BuildAstVisitor
    â†’ åˆ›å»º â†’ AdditionNode, SubtractionNode, ...

EvalExprVisitor
    â†’ éå† â†’ ExpressionNodeå±‚æ¬¡ç»“æ„
    â†’ è°ƒç”¨ â†’ visit(AdditionNode), visit(SubtractionNode), ...
```

### 1.5 å­¦ä¹ è·¯å¾„å¯¼èˆª

```
å­¦ä¹ é¡ºåº (æŒ‰ä¾èµ–å…³ç³»):

Topic 1: ASTèŠ‚ç‚¹å±‚æ¬¡è®¾è®¡
    â†“ æä¾›åŸºç¡€
Topic 2: Visitoræ¡†æ¶å®šä¹‰
    â†“ æä¾›æ¥å£
Topic 3: ParseTreeåˆ°ASTè½¬æ¢
    â†“ ç”ŸæˆAST
Topic 4: ASTæ±‚å€¼å®ç°
    â†“ è®¡ç®—ç»“æœ
Topic 5: ç»¼åˆåº”ç”¨ - å®Œæ•´çš„è¡¨è¾¾å¼è§£é‡Šå™¨
```

---

## ğŸ“š ç†è®ºæ•™æç´¢å¼•

### å¯¹åº”ã€Šç¼–è¯‘åŸç†ã€‹ï¼ˆé¾™ä¹¦ç¬¬äºŒç‰ˆï¼‰

**å¯¹åº”ç« èŠ‚**: ç¬¬5ç« ï¼šè¯­æ³•åˆ¶å¯¼ç¿»è¯‘ + ç¬¬6ç« ï¼šä¸­é—´ä»£ç ç”Ÿæˆ

**å…³é”®ç†è®ºæ¦‚å¿µ**:
- **æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰**: å»é™¤è¯­æ³•å™ªéŸ³ã€ä¿ç•™è¯­ä¹‰ä¿¡æ¯çš„æ ‘å½¢è¡¨ç¤º
- **ç±»å‹å®‰å…¨çš„ASTè®¾è®¡**: é€šè¿‡ç»§æ‰¿å±‚æ¬¡å®ç°ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- **ç»„åˆæ¨¡å¼**: å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„è¡¨ç¤º"éƒ¨åˆ†-æ•´ä½“"å±‚æ¬¡
- **è®¿é—®è€…æ¨¡å¼**: åˆ†ç¦»ç®—æ³•å’Œå¯¹è±¡ç»“æ„ï¼Œæ”¯æŒå¤šç§éå†æ“ä½œ
- **è§£é‡Šå™¨æ¨¡å¼**: å°†è¯­æ³•è§„åˆ™è¡¨ç¤ºä¸ºç±»ï¼Œè§£é‡Šå™¨é€šè¿‡éå†è¿™äº›ç±»æ‰§è¡Œç¨‹åº

**ç†è®ºå®è·µå¯¹ç…§**:
| é¾™ä¹¦æ¦‚å¿µ | æœ¬EPå®ç° | å­¦ä¹ è¦ç‚¹ |
|---------|---------|---------|
| æŠ½è±¡è¯­æ³•æ ‘ | ExpressionNodeå±‚æ¬¡ç»“æ„ | ç†è®ºï¼šè¯­ä¹‰æŠ½è±¡ â†’ å®è·µï¼šè‡ªå®šä¹‰ASTèŠ‚ç‚¹ |
| è¯­æ³•æ ‘ vs AST | ParseTree â†’ ASTè½¬æ¢ | ç†è®ºï¼šå»é™¤è¯­æ³•å™ªéŸ³ â†’ å®è·µï¼šBuildAstVisitor |
| ç±»å‹æ£€æŸ¥ | ASTVisitor<Double>ç±»å‹ç³»ç»Ÿ | ç†è®ºï¼šç±»å‹å®‰å…¨ â†’ å®è·µï¼šJavaæ³›å‹ |
| è¯­æ³•åˆ¶å¯¼ç¿»è¯‘ | EvalExprVisitoré€’å½’æ±‚å€¼ | ç†è®ºï¼šå±æ€§æ–‡æ³• â†’ å®è·µï¼šè®¿é—®è€…æ¨¡å¼ |
| è¡¨è¾¾å¼æ±‚å€¼ | visit()æ–¹æ³•å®ç° | ç†è®ºï¼šè¯­ä¹‰åŠ¨ä½œ â†’ å®è·µï¼šé€’å½’ç®—æ³• |

**æ¨èå­¦ä¹ è·¯å¾„**:
1. é˜…è¯»é¾™ä¹¦ç¬¬5.4èŠ‚ï¼ˆ2å°æ—¶ï¼‰- ç†è§£ASTçš„æ„é€ å’Œè®¾è®¡
2. é˜…è¯»é¾™ä¹¦ç¬¬6.1-6.3èŠ‚ï¼ˆ3å°æ—¶ï¼‰- ç†è§£ä¸­é—´è¡¨ç¤ºçš„ç±»å‹å’Œä½œç”¨
3. å®Œæˆæœ¬EPå®è·µï¼ˆ4å°æ—¶ï¼‰- å®ç°è‡ªå®šä¹‰ASTå’ŒVisitor
4. å¯¹æ¯”æ€»ç»“ï¼ˆ1å°æ—¶ï¼‰- ParseTree vs ASTçš„æœ¬è´¨åŒºåˆ«

**è¡¥å……é˜…è¯»**:
- **è®¾è®¡æ¨¡å¼**: ç»„åˆæ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼ã€è§£é‡Šå™¨æ¨¡å¼ï¼ˆGoFè®¾è®¡æ¨¡å¼ï¼‰
- **SSAå½¢å¼**: Cytron et al. 1991è®ºæ–‡ - "Efficiently Computing Static Single Assignment Form and the Control Dependence Graph"
- **LLVMæ–‡æ¡£**: LLVM IRè®¾è®¡ç†å¿µ - ç°ä»£ç¼–è¯‘å™¨çš„ä¸­é—´è¡¨ç¤ºè®¾è®¡

**å­¦ä¹ æç¤º**:
- é¾™ä¹¦ç¬¬6ç« é‡ç‚¹ä»‹ç»ä¸‰åœ°å€ç ï¼Œè€Œæœ¬EPçš„è‡ªå®šä¹‰ASTæ˜¯æ›´æŠ½è±¡çš„ä¸­é—´è¡¨ç¤º
- EP11çš„ASTæ˜¯å‰ç«¯åˆ°ä¸­ç«¯çš„è¿‡æ¸¡ï¼Œåç»­ä¼šè½¬æ¢ä¸ºçº¿æ€§IRï¼ˆEP16ï¼‰
- ç»„åˆæ¨¡å¼å’Œè®¿é—®è€…æ¨¡å¼çš„ç»“åˆæ˜¯ASTè®¾è®¡çš„ç»å…¸æ¨¡å¼
- ç†è§£BuildAstVisitorï¼ˆParseTreeâ†’ASTï¼‰å’ŒEvalExprVisitorï¼ˆASTâ†’å€¼ï¼‰çš„åŒé‡åº”ç”¨
- ç±»å‹å®‰å…¨çš„è®¾è®¡ä½¿å¾—å¾ˆå¤šé”™è¯¯åœ¨ç¼–è¯‘æ—¶å°±èƒ½å‘ç°ï¼Œè¿™æ˜¯å®è·µä¼˜äºç†è®ºä¼ªä»£ç çš„åœ°æ–¹

---

## ğŸ“š ç¬¬äºŒå±‚ï¼šä¸»é¢˜å•å…ƒ

### ä¸»é¢˜1: ASTèŠ‚ç‚¹å±‚æ¬¡è®¾è®¡

#### ğŸ“ åœ¨EP11ä¸­çš„ä½ç½®
```
Layer 1-2: Framework + Abstract Intermediate
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic 1: èŠ‚ç‚¹å±‚æ¬¡è®¾è®¡     â”‚
â”‚  â”œâ”€ ExpressionNode         â”‚
â”‚  â”œâ”€ InfixExpressionNode    â”‚
â”‚  â””â”€ å…·ä½“èŠ‚ç‚¹ç±»å‹           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ æä¾›æ•°æ®ç»“æ„
   Topic 3/4: Visitoræ“ä½œ
```

#### ğŸ”— ä¾èµ–å…³ç³»
- **å‰ç½®ä¾èµ–**: Javaç»§æ‰¿ã€å¤šæ€ã€EP3 (ParseTree)
- **åç»­åº”ç”¨**: Topic 2 (Visitoræ¥å£)ã€Topic 3 (ASTæ„å»º)ã€Topic 4 (ASTæ±‚å€¼)

#### 1.1 æ ¸å¿ƒæ¦‚å¿µ

**æ¦‚å¿µ1: ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ASTï¼Ÿ**

| ç»´åº¦ | ANTLR4 ParseTree | è‡ªå®šä¹‰AST |
|------|-----------------|-----------|
| **è¯­æ³•å™ªéŸ³** | åŒ…å«æ‹¬å·ã€é€—å·ç­‰ | å»é™¤å™ªéŸ³ |
| **èŠ‚ç‚¹ç±»å‹** | å›ºå®šï¼ˆç”±è¯­æ³•å†³å®šï¼‰ | çµæ´»ï¼ˆè¯­ä¹‰é©±åŠ¨ï¼‰ |
| **è¯­ä¹‰å±æ€§** | éš¾ä»¥æ·»åŠ  | æ˜“äºæ·»åŠ ï¼ˆç±»å‹ã€å€¼ã€ä½œç”¨åŸŸï¼‰ |
| **ç±»å‹å®‰å…¨** | å¼±ï¼ˆContextç±»å‹ï¼‰ | å¼ºï¼ˆç»§æ‰¿å±‚æ¬¡ï¼‰ |
| **åç»­å¤„ç†** | ä¸è¯­æ³•è€¦åˆ | ä¸å‰ç«¯è§£è€¦ |

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
**ParseTree vs ASTçš„æœ¬è´¨åŒºåˆ«**:
ParseTreeæ˜¯"è¯­æ³•å¯¼å‘"çš„ï¼Œå¿ å®è®°å½•è§£æè¿‡ç¨‹ï¼›ASTæ˜¯"è¯­ä¹‰å¯¼å‘"çš„ï¼Œçªå‡ºç¨‹åºç»“æ„ã€‚

ç±»æ¯”ï¼šParseTreeåƒ"å½•éŸ³è®°å½•"ï¼Œå®Œæ•´è®°å½•è¯´è¯è¿‡ç¨‹ï¼›ASTåƒ"ä¼šè®®çºªè¦"ï¼Œæç‚¼å…³é”®ä¿¡æ¯ã€‚
`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

**æ¦‚å¿µ2: ç»„åˆæ¨¡å¼åœ¨ASTä¸­çš„åº”ç”¨**

ç»„åˆæ¨¡å¼ï¼ˆComposite Patternï¼‰çš„æ ¸å¿ƒæ€æƒ³ï¼š
- å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„è¡¨ç¤º"éƒ¨åˆ†-æ•´ä½“"å±‚æ¬¡ç»“æ„
- ç»Ÿä¸€å¯¹å¾…å•ä¸ªå¯¹è±¡ï¼ˆNumberNodeï¼‰å’Œç»„åˆå¯¹è±¡ï¼ˆAdditionNodeï¼‰

```
ç»Ÿä¸€æ¥å£:
ExpressionNode
    â”œâ”€â”€ NumberNode (å¶å­)
    â””â”€â”€ AdditionNode (å¤åˆ)
        â”œâ”€â”€ NumberNode (å¶å­)
        â””â”€â”€ MultiplicationNode (å¤åˆ)
            â”œâ”€â”€ NumberNode (å¶å­)
            â””â”€â”€ NumberNode (å¶å­)
```

#### 1.2 å®ç°åŸç†

**é˜¶æ®µä¸€: å®šä¹‰æŠ½è±¡åŸºç±»**

**å…³é”®ä»£ç ** (`ExpressionNode.java`):

```java
package com.blitz.cymbol.ep11.ast;

/**
 * æ‰€æœ‰è¡¨è¾¾å¼èŠ‚ç‚¹çš„æŠ½è±¡åŸºç±»
 * è®¾è®¡æ¨¡å¼: Composite Pattern (Component)
 */
public abstract class ExpressionNode {
    // å¯æ·»åŠ é€šç”¨å±æ€§
    // private Type type;
    // private int lineNumber;

    // åŸºç±»å¯ä»¥ä¸ºç©ºï¼Œä»…ä½œä¸ºç±»å‹æ ‡è®°
}
```

**ä»£ç è§£æ**:
- **ç¬¬7è¡Œ**: `abstract` å…³é”®å­—è¡¨ç¤ºä¸èƒ½ç›´æ¥å®ä¾‹åŒ–
- **ç¬¬9-10è¡Œ**: å¯æ·»åŠ é€šç”¨å±æ€§ï¼ˆç±»å‹ã€è¡Œå·ç­‰ï¼‰
- **è®¾è®¡æ¨¡å¼**: **ç»„åˆæ¨¡å¼**çš„Componentè§’è‰²

**é˜¶æ®µäºŒ: å®šä¹‰å¶å­èŠ‚ç‚¹**

**å…³é”®ä»£ç ** (`NumberNode.java`):

```java
package com.blitz.cymbol.ep11.ast;

public class NumberNode extends ExpressionNode {
    private final double value;

    public NumberNode(double value) {
        this.value = value;
    }

    public double getValue() {
        return value;
    }

    @Override
    public String toString() {
        return String.valueOf(value);
    }
}
```

**ä»£ç è§£æ**:
- **ç¬¬5è¡Œ**: ç»§æ‰¿ `ExpressionNode`
- **ç¬¬7è¡Œ**: `final` ç¡®ä¿å€¼ä¸å¯å˜ï¼ˆä¸å¯å˜å¯¹è±¡ï¼‰
- **ç¬¬9-11è¡Œ**: æ„é€ å‡½æ•°å°è£…å€¼
- **ç¬¬16è¡Œ**: `toString()` ç”¨äºè°ƒè¯•å’Œè¾“å‡º

**é˜¶æ®µä¸‰: å®šä¹‰å¤åˆèŠ‚ç‚¹åŸºç±»**

**å…³é”®ä»£ç ** (`InfixExpressionNode.java`):

```java
package com.blitz.cymbol.ep11.ast;

/**
 * äºŒå…ƒè¡¨è¾¾å¼èŠ‚ç‚¹çš„æŠ½è±¡åŸºç±»
 * è®¾è®¡æ¨¡å¼: Composite Pattern (Composite)
 */
public abstract class InfixExpressionNode extends ExpressionNode {
    protected ExpressionNode left;
    protected ExpressionNode right;

    // æ— å‚æ„é€ ï¼ˆç”¨äºæŸäº›ç‰¹æ®Šæƒ…å†µï¼‰
    public InfixExpressionNode() {
        this.left = null;
        this.right = null;
    }

    // å¸¦å‚æ•°æ„é€ ï¼ˆæ³¨å…¥å·¦å³å­æ ‘ï¼‰
    public InfixExpressionNode(ExpressionNode left, ExpressionNode right) {
        this.left = left;
        this.right = right;
    }

    // Getteræ–¹æ³•
    public ExpressionNode getLeft() { return left; }
    public ExpressionNode getRight() { return right; }

    // Setteræ–¹æ³•ï¼ˆå¯é€‰ï¼Œç”¨äºå»¶è¿Ÿæ„å»ºï¼‰
    public void setLeft(ExpressionNode left) { this.left = left; }
    public void new ExpressionNode right) { this.right = right; }
}
```

**ä»£ç è§£æ**:
- **ç¬¬12-13è¡Œ**: `protected` è®¿é—®çº§åˆ«ï¼Œå­ç±»å¯ç›´æ¥è®¿é—®
- **ç¬¬18-20è¡Œ**: æ— å‚æ„é€ ï¼Œæ”¯æŒå»¶è¿Ÿåˆå§‹åŒ–
- **ç¬¬23-26è¡Œ**: å¸¦å‚æ„é€ ï¼Œç›´æ¥æ³¨å…¥å­æ ‘
- **ç¬¬29-30è¡Œ**: Getteræ–¹æ³•ç”¨äºéå†
- **è®¾è®¡æ¨¡å¼**: **ç»„åˆæ¨¡å¼**çš„Compositeè§’è‰²

**é˜¶æ®µå››: å®šä¹‰å…·ä½“è¿ç®—èŠ‚ç‚¹**

**å…³é”®ä»£ç ** (`AdditionNode.java`):

```java
package com.blitz.cymbol.ep11.ast;

public class AdditionNode extends InfixExpressionNode {
    public AdditionNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }

    @Override
    public String toString() {
        return "(" + left + " + " + right + ")";
    }
}
```

**ä»£ç è§£æ**:
- **ç¬¬5è¡Œ**: ç»§æ‰¿ `InfixExpressionNode`
- **ç¬¬7è¡Œ**: è°ƒç”¨çˆ¶ç±»æ„é€ ï¼Œæ³¨å…¥å·¦å³å­æ ‘
- **ç¬¬11-13è¡Œ**: `toString()` ç”¨äºæ‰“å°è¡¨è¾¾å¼ç»“æ„

**å…¶ä»–è¿ç®—èŠ‚ç‚¹**:
```java
// SubtractionNode
public class SubtractionNode extends InfixExpressionNode {
    public SubtractionNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}

// MultiplicationNode
public class MultiplicationNode extends InfixExpressionNode {
    public MultiplicationNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}

// DivisionNode
public class DivisionNode extends InfixExpressionNode {
    public DivisionNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}

// NegateNode (ä¸€å…ƒå–è´Ÿ)
public class NegateNode extends ExpressionNode {
    private ExpressionNode expr;

    public NegateNode(ExpressionNode expr) {
        this.expr = expr;
    }

    public ExpressionNode getExpr() { return expr; }
}
```

#### 1.3 å®è·µç»ƒä¹ 

**ç»ƒä¹ : æ·»åŠ æ¯”è¾ƒè¿ç®—èŠ‚ç‚¹**

**ä»»åŠ¡**: æ‰©å±•ASTå±‚æ¬¡ï¼Œæ”¯æŒæ¯”è¾ƒè¿ç®—ï¼ˆ<, >, <=, >=, ==, !=ï¼‰

**æç¤º**:
```java
// 1. å®šä¹‰æ¯”è¾ƒè¿ç®—åŸºç±»
public abstract class ComparisonNode extends InfixExpressionNode {
    public ComparisonNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}

// 2. å®šä¹‰å…·ä½“æ¯”è¾ƒèŠ‚ç‚¹
public class LessThanNode extends ComparisonNode {
    public LessThanNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}

public class GreaterThanNode extends ComparisonNode {
    public GreaterThanNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}

// ... å…¶ä»–æ¯”è¾ƒè¿ç®—
```

**æµ‹è¯•ä»£ç **:
```java
// æ„å»ºæ¯”è¾ƒè¡¨è¾¾å¼AST
ExpressionNode comparison = new LessThanNode(
    new NumberNode(3),
    new NumberNode(5)
);
System.out.println(comparison);  // è¾“å‡º: (3.0 < 5.0)
```

---

#### ğŸ”„ ä»æœ¬ä¸»é¢˜åˆ°ä¸‹ä¸€ä¸»é¢˜

**è¿æ¥ä»£ç **:

```java
// Topic 1 æä¾›: ASTèŠ‚ç‚¹å±‚æ¬¡ç»“æ„
ExpressionNode node = new AdditionNode(
    new NumberNode(3),
    new MultiplicationNode(
        new NumberNode(5),
        new NumberNode(2)
    )
);

// â†’ Topic 2 ä½¿ç”¨: å®šä¹‰Visitoræ¥å£éå†è¿™äº›èŠ‚ç‚¹
public interface ASTVisitor<T> {
    T visit(AdditionNode node);
    T visit(MultiplicationNode node);
    T visit(NumberNode node);
    // ...
}
```

**å…³ç³»è¯´æ˜**:
- Topic 1 çš„ `ExpressionNode` å±‚æ¬¡æ˜¯æ•°æ®ç»“æ„
- Topic 2 çš„ `ASTVisitor` æ˜¯æ“ä½œè¿™äº›æ•°æ®çš„æ¥å£
- åˆ†ç¦»æ•°æ®ç»“æ„å’Œæ“ä½œï¼ˆ**è®¿é—®è€…æ¨¡å¼**ï¼‰

---

### ä¸»é¢˜2: Visitoræ¡†æ¶å®šä¹‰

#### ğŸ“ åœ¨EP11ä¸­çš„ä½ç½®
```
Layer 1: Framework Layer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic 2: Visitoræ¡†æ¶      â”‚
â”‚  â””â”€ ASTVisitor<T>          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ å®šä¹‰æ¥å£
         â†“ Topic 3/4å®ç°
Topic 3: BuildAstVisitor
Topic 4: EvalExprVisitor
```

#### ğŸ”— ä¾èµ–å…³ç³»
- **å‰ç½®ä¾èµ–**: Topic 1 (ExpressionNodeå±‚æ¬¡)
- **åç»­åº”ç”¨**: Topic 3 (BuildAstVisitorå®ç°)ã€Topic 4 (EvalExprVisitorå®ç°)

#### 2.1 æ ¸å¿ƒæ¦‚å¿µ

**æ¦‚å¿µ1: è®¿é—®è€…æ¨¡å¼çš„æœ¬è´¨**

è®¿é—®è€…æ¨¡å¼ï¼ˆVisitor Patternï¼‰çš„æ ¸å¿ƒæ€æƒ³ï¼š
- **åˆ†ç¦»ç®—æ³•å’Œå¯¹è±¡ç»“æ„**
- åœ¨ä¸æ”¹å˜ç±»ç»“æ„çš„å‰æä¸‹å®šä¹‰æ–°æ“ä½œ
- é€šè¿‡**åŒé‡åˆ†å‘**å®ç°ç±»å‹å®‰å…¨

```
ä¼ ç»Ÿæ–¹æ³•: åœ¨èŠ‚ç‚¹ç±»ä¸­æ·»åŠ æ“ä½œ
class AdditionNode {
    double eval() { ... }
    void print() { ... }
    Type checkType() { ... }
    // æ¯æ·»åŠ æ–°æ“ä½œéƒ½è¦ä¿®æ”¹æ‰€æœ‰èŠ‚ç‚¹ç±»
}

è®¿é—®è€…æ¨¡å¼: æ“ä½œç‹¬ç«‹æˆVisitor
class EvalExprVisitor implements ASTVisitor<Double> {
    public Double visit(AdditionNode node) { ... }
}

class PrintVisitor implements ASTVisitor<String> {
    public String visit(AdditionNode node) { ... }
}
// æ·»åŠ æ–°æ“ä½œåªéœ€æ–°å¢Visitorï¼Œä¸ä¿®æ”¹èŠ‚ç‚¹ç±»
```

**æ¦‚å¿µ2: åŒé‡åˆ†å‘æœºåˆ¶**

**ç¬¬ä¸€é‡åˆ†å‘**: æ ¹æ® `ExpressionNode` çš„å…·ä½“ç±»å‹åˆ†å‘åˆ°ä¸åŒçš„ `visit()` é‡è½½æ–¹æ³•
**ç¬¬äºŒé‡åˆ†å‘**: æ ¹æ®å…·ä½“çš„ `Visitor` ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ

```
è°ƒç”¨: visitor.visit(node)
       â†“
ç¬¬ä¸€é‡: nodeçš„ç±»å‹åˆ†å‘
       â†“
    - AdditionNode â†’ visit(AdditionNode)
    - MultiplicationNode â†’ visit(MultiplicationNode)
    - NumberNode â†’ visit(NumberNode)
       â†“
ç¬¬äºŒé‡: visitorçš„ç±»å‹åˆ†å‘
       â†“
    - EvalExprVisitor â†’ è¿”å›Double
    - PrintVisitor â†’ è¿”å›String
    - TypeChecker â†’ è¿”å›Type
```

#### 2.2 å®ç°åŸç†

**é˜¶æ®µä¸€: å®šä¹‰Visitoræ¥å£**

**å…³é”®ä»£ç ** (`ASTVisitor.java`):

```java
package com.blitz.cymbol.ep11.ast;

/**
 * ASTè®¿é—®è€…æ¥å£
 * è®¾è®¡æ¨¡å¼: Visitor Pattern
 *
 * @param <T> è®¿é—®æ–¹æ³•çš„è¿”å›å€¼ç±»å‹
 */
public interface ASTVisitor<T> {
    // å¶å­èŠ‚ç‚¹
    T visit(NumberNode node);

    // ä¸€å…ƒè¡¨è¾¾å¼
    T visit(NegateNode node);

    // äºŒå…ƒè¡¨è¾¾å¼
    T visit(AdditionNode node);
    T visit(SubtractionNode node);
    T visit(MultiplicationNode node);
    T visit(DivisionNode node);

    // é€šç”¨åˆ†å‘æ–¹æ³•
    T visit(ExpressionNode node);
}
```

**ä»£ç è§£æ**:
- **ç¬¬11è¡Œ**: æ³›å‹ `<T>` æ”¯æŒä¸åŒçš„è¿”å›å€¼ç±»å‹
- **ç¬¬14-21è¡Œ**: ä¸ºæ¯ç§èŠ‚ç‚¹ç±»å‹å®šä¹‰ `visit()` æ–¹æ³•
- **ç¬¬24è¡Œ**: é€šç”¨åˆ†å‘æ–¹æ³•ï¼Œä½¿ç”¨ `instanceof` åˆ¤æ–­ç±»å‹

**é˜¶æ®µäºŒ: å®ç°é€šç”¨åˆ†å‘æ–¹æ³•**

**å…³é”®ä»£ç ** (æŠ½è±¡ç±»å®ç°):

```java
public abstract class AbstractASTVisitor<T> implements ASTVisitor<T> {
    @Override
    public T visit(ExpressionNode node) {
        // ä½¿ç”¨instanceofåˆ¤æ–­å…·ä½“ç±»å‹å¹¶åˆ†å‘
        if (node instanceof NumberNode) {
            return visit((NumberNode) node);
        } else if (node instanceof NegateNode) {
            return visit((NegateNode) node);
        } else if (node instanceof AdditionNode) {
            return visit((AdditionNode) node);
        } else if (node instanceof SubtractionNode) {
            return visit((SubtractionNode) node);
        } else if (node instanceof MultiplicationNode) {
            return visit((MultiplicationNode) node);
        } else if (node instanceof DivisionNode) {
            return visit((DivisionNode) node);
        }

        throw new RuntimeException("Unknown node type: " + node.getClass());
    }
}
```

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
**åŒé‡åˆ†å‘çš„å®ç°**:
```java
// è°ƒç”¨é“¾
visitor.visit(expressionNode)
  â†’ visit(ExpressionNode node)
    â†’ instanceofåˆ¤æ–­
    â†’ visit(AdditionNode node)
      â†’ å…·ä½“çš„Visitorå®ç°

ä¾‹å¦‚: EvalExprVisitor
  visitor.visit(node)
    â†’ instanceof AdditionNode
    â†’ visit((AdditionNode) node)
    â†’ EvalExprVisitor.visit(AdditionNode)
    â†’ è¿”å› Double
```
è¿™æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥æ˜¯å¦å®ç°äº†æ‰€æœ‰ `visit()` æ–¹æ³•ã€‚
`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

#### 2.3 å®è·µç»ƒä¹ 

**ç»ƒä¹ : æ·»åŠ ç±»å‹æ£€æŸ¥Visitor**

**ä»»åŠ¡**: å®šä¹‰ `TypeChecker` Visitorï¼Œæ£€æŸ¥è¡¨è¾¾å¼ç±»å‹æ˜¯å¦æ­£ç¡®

**æç¤º**:
```java
public class TypeChecker implements ASTVisitor<Type> {
    @Override
    public Type visit(NumberNode node) {
        return Type.NUMBER;
    }

    @Override
    public Type visit(AdditionNode node) {
        Type leftType = visit(node.getLeft());
        Type rightType = visit(node.getRight());

        if (leftType != Type.NUMBER || rightType != Type.NUMBER) {
            throw new TypeError("Addition requires NUMBER operands");
        }

        return Type.NUMBER;
    }

    // ... å…¶ä»–visitæ–¹æ³•
}
```

**æµ‹è¯•ç”¨ä¾‹**:
```java
// ç±»å‹æ­£ç¡®çš„è¡¨è¾¾å¼
ExpressionNode expr1 = new AdditionNode(
    new NumberNode(3),
    new NumberNode(5)
);

TypeChecker checker = new TypeChecker();
Type type = checker.visit(expr1);  // è¿”å› Type.NUMBER

// ç±»å‹é”™è¯¯çš„è¡¨è¾¾å¼ï¼ˆå‡è®¾æ·»åŠ äº†StringNodeï¼‰
ExpressionNode expr2 = new AdditionNode(
    new NumberNode(3),
    new StringNode("hello")
);

checker.visit(expr2);  // æŠ›å‡º TypeError
```

---

#### ğŸ”„ ä»æœ¬ä¸»é¢˜åˆ°ä¸‹ä¸€ä¸»é¢˜

**è¿æ¥ä»£ç **:

```java
// Topic 2 æä¾›: Visitoræ¥å£
public interface ASTVisitor<T> {
    T visit(AdditionNode node);
    T visit(NumberNode node);
    // ...
}

// â†’ Topic 3 ä½¿ç”¨: å®ç°ASTæ„å»ºVisitor
public class BuildAstVisitor extends MathBaseVisitor<ExpressionNode> {
    // è®¿é—®ParseTreeï¼Œåˆ›å»ºè‡ªå®šä¹‰ASTèŠ‚ç‚¹
    @Override
    public ExpressionNode visitAddSubExpr(MathParser.AddSubExprContext ctx) {
        ExpressionNode left = visit(ctx.expr(0));
        ExpressionNode right = visit(ctx.expr(1));

        if (ctx.op.getType() == MathParser.ADD) {
            return new AdditionNode(left, right);  // ä½¿ç”¨Topic 1çš„èŠ‚ç‚¹
        } else {
            return new SubtractionNode(left, right);
        }
    }
}
```

**å…³ç³»è¯´æ˜**:
- Topic 2 çš„ `ASTVisitor` æ˜¯æ¥å£
- Topic 3 çš„ `BuildAstVisitor` å®ç°è¯¥æ¥å£ï¼Œæ„å»ºAST
- Topic 4 çš„ `EvalExprVisitor` å®ç°è¯¥æ¥å£ï¼Œæ±‚å€¼AST

---

### ä¸»é¢˜3: ParseTreeåˆ°ASTè½¬æ¢

#### ğŸ“ åœ¨EP11ä¸­çš„ä½ç½®
```
Layer 3: Concrete Implementation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic 3: ASTæ„å»º          â”‚
â”‚  â””â”€ BuildAstVisitor        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ å®ç°Topic 2æ¥å£
         â†“ è½¬æ¢Topic 1çš„èŠ‚ç‚¹
         â†“ ä½¿ç”¨EP3çš„ParseTree
```

#### ğŸ”— ä¾èµ–å…³ç³»
- **å‰ç½®ä¾èµ–**: Topic 1 (ExpressionNodeèŠ‚ç‚¹)ã€Topic 2 (ASTVisitoræ¥å£)ã€EP3 (ParseTree)
- **åç»­åº”ç”¨**: Topic 4 (EvalExprVisitoræ±‚å€¼)

#### 3.1 æ ¸å¿ƒæ¦‚å¿µ

**æ¦‚å¿µ1: Visitoræ¨¡å¼çš„åŒé‡åº”ç”¨**

EP11å±•ç¤ºäº†Visitoræ¨¡å¼çš„ä¸¤ä¸ªå…¸å‹åº”ç”¨ï¼š

**åº”ç”¨1: æ„å»ºAST** (`BuildAstVisitor`)
- **è¾“å…¥**: ANTLR4 ParseTree
- **è¾“å‡º**: è‡ªå®šä¹‰AST
- **æ“ä½œ**: æ ¹æ®ParseTreeèŠ‚ç‚¹ç±»å‹åˆ›å»ºå¯¹åº”çš„ASTèŠ‚ç‚¹

**åº”ç”¨2: éå†AST** (`EvalExprVisitor`)
- **è¾“å…¥**: è‡ªå®šä¹‰AST
- **è¾“å‡º**: è®¡ç®—ç»“æœ
- **æ“ä½œ**: é€’å½’éå†ASTèŠ‚ç‚¹å¹¶æ‰§è¡Œè®¡ç®—

```
æ•°æ®æµ:
æºä»£ç 
  â†“ [EP3: è¯æ³•/è¯­æ³•åˆ†æ]
ParseTree (ANTLR4)
  â†“ [BuildAstVisitor - Visitoråº”ç”¨1]
è‡ªå®šä¹‰AST
  â†“ [EvalExprVisitor - Visitoråº”ç”¨2]
è®¡ç®—ç»“æœ
```

**æ¦‚å¿µ2: å·¥å‚æ¨¡å¼çš„èåˆ**

`BuildAstVisitor` å®é™…ä¸Šèåˆäº†**è®¿é—®è€…æ¨¡å¼**å’Œ**å·¥å‚æ¨¡å¼**ï¼š
- Visitor: éå†ParseTree
- Factory: æ ¹æ®æ“ä½œç¬¦ç±»å‹åˆ›å»ºå¯¹åº”èŠ‚ç‚¹

```java
// å·¥å‚æ¨¡å¼çš„ä½“ç°
switch (op) {
    case "+": return new AdditionNode(left, right);
    case "-": return new SubtractionNode(left, right);
    case "*": return new MultiplicationNode(left, right);
    case "/": return new DivisionNode(left, right);
}
```

#### 3.2 å®ç°åŸç†

**é˜¶æ®µä¸€: å¤„ç†äºŒå…ƒè¡¨è¾¾å¼**

**å…³é”®ä»£ç ** (`BuildAstVisitor.java:64-97`):

```java
@Override
public ExpressionNode visitInfixExpr(MathParser.InfixExprContext ctx) {
    // å¤„ç†äºŒå…ƒè¡¨è¾¾å¼: expr op expr

    // é€’å½’è®¿é—®å·¦å³å­è¡¨è¾¾å¼ï¼Œæ„å»ºå­æ ‘
    ExpressionNode left = visit(ctx.expr(0));
    ExpressionNode right = visit(ctx.expr(1));

    // æ ¹æ®æ“ä½œç¬¦ç±»å‹åˆ›å»ºä¸åŒçš„ASTèŠ‚ç‚¹
    String op = ctx.op.getText();
    switch (op) {
        case "+":
            return new AdditionNode(left, right);
        case "-":
            return new SubtractionNode(left, right);
        case "*":
            return new MultiplicationNode(left, right);
        case "/":
            return new DivisionNode(left, right);
        default:
            throw new RuntimeException("Unknown operator: " + op);
    }
}
```

**ä»£ç è§£æ**:
- **ç¬¬6-7è¡Œ**: é€’å½’è°ƒç”¨ `visit()` æ„å»ºå·¦å³å­æ ‘
- **ç¬¬10è¡Œ**: è·å–æ“ä½œç¬¦æ–‡æœ¬
- **ç¬¬12-21è¡Œ**: ä½¿ç”¨**å·¥å‚æ¨¡å¼**æ ¹æ®æ“ä½œç¬¦åˆ›å»ºä¸åŒèŠ‚ç‚¹
- **å…³é”®ç‚¹**: åˆ©ç”¨å¤šæ€ï¼Œè¿”å›ç±»å‹ç»Ÿä¸€ä¸º `ExpressionNode`

**é˜¶æ®µäºŒ: å¤„ç†ä¸€å…ƒè¡¨è¾¾å¼**

**å…³é”®ä»£ç ** (`BuildAstVisitor.java:89-97`):

```java
@Override
public ExpressionNode visitUnaryExpr(MathParser.UnaryExprContext ctx) {
    // å¤„ç†ä¸€å…ƒè¡¨è¾¾å¼: (-|+) expr

    ExpressionNode expr = visit(ctx.expr());
    String op = ctx.op.getText();

    if (op.equals("-")) {
        return new NegateNode(expr);
    } else {
        return expr;  // ä¸€å…ƒ+ï¼Œç›´æ¥è¿”å›åŸèŠ‚ç‚¹
    }
}
```

**ä»£ç è§£æ**:
- **ç¬¬6è¡Œ**: é€’å½’è®¿é—®å­è¡¨è¾¾å¼
- **ç¬¬7è¡Œ**: è·å–æ“ä½œç¬¦
- **ç¬¬10-12è¡Œ**: ä¸€å…ƒå–è´Ÿåˆ›å»º `NegateNode`
- **ç¬¬14è¡Œ**: ä¸€å…ƒåŠ ç›´æ¥è¿”å›åŸèŠ‚ç‚¹ï¼ˆä¼˜åŒ–ï¼‰

**é˜¶æ®µä¸‰: å¤„ç†å¶å­èŠ‚ç‚¹**

**å…³é”®ä»£ç **:

```java
@Override
public ExpressionNode visitIntExpr(MathParser.IntExprContext ctx) {
    // INT
    String intText = ctx.INT().getText();
    double value = Double.parseDouble(intText);
    return new NumberNode(value);
}

@Override
public ExpressionNode visitIdExpr(MathParser.IdExprContext ctx) {
    // ID (å˜é‡å¼•ç”¨)
    String varName = ctx.ID().getText();
    // åœ¨å®Œæ•´å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥åˆ›å»ºVariableNode
    // å½“å‰ç®€åŒ–ä¸ºæŠ›å‡ºå¼‚å¸¸
    throw new UnsupportedOperationException("Variables not implemented yet");
}
```

**ä»£ç è§£æ**:
- **ç¬¬3-5è¡Œ**: è§£ææ•´æ•°æ–‡æœ¬å¹¶è½¬æ¢ä¸º `double`
- **ç¬¬6è¡Œ**: åˆ›å»º `NumberNode` å¶å­èŠ‚ç‚¹
- **ç¬¬11-17è¡Œ**: å˜é‡å¼•ç”¨å¤„ç†ï¼ˆå½“å‰æœªå®ç°ï¼‰

#### 3.3 å®è·µç»ƒä¹ 

**ç»ƒä¹ : æ‰©å±•BuildAstVisitoræ”¯æŒå˜é‡**

**ä»»åŠ¡**: æ·»åŠ  `VariableNode`ï¼Œæ”¯æŒå˜é‡å¼•ç”¨

**è¾“å…¥**:
```
x = 10
y = 20
x + y
```

**è¾“å‡º**: åŒ…å« `VariableNode` çš„AST

**æç¤º**:
```java
// 1. æ·»åŠ VariableNodeç±»
public class VariableNode extends ExpressionNode {
    private String name;

    public VariableNode(String name) {
        this.name = name;
    }

    public String getName() { return name; }
}

// 2. æ‰©å±•BuildAstVisitor
@Override
public ExpressionNode visitIdExpr(MathParser.IdExprContext ctx) {
    String varName = ctx.ID().getText();
    return new VariableNode(varName);
}

// 3. æ‰©å±•EvalExprVisitoræ”¯æŒå˜é‡æŸ¥æ‰¾
public class EvalExprVisitor implements ASTVisitor<Double> {
    private Map<String, Double> symbolTable = new HashMap<>();

    @Override
    public Double visit(VariableNode node) {
        String name = node.getName();
        if (!symbolTable.containsKey(name)) {
            throw new RuntimeException("Undefined variable: " + name);
        }
        return symbolTable.get(name);
    }
}
```

---

#### ğŸ”„ ä»æœ¬ä¸»é¢˜åˆ°ä¸‹ä¸€ä¸»é¢˜

**è¿æ¥ä»£ç **:

```java
// Topic 3 æä¾›: ASTæ„å»º
BuildAstVisitor astBuilder = new BuildAstVisitor();
ParseTree parseTree = parser.compileUnit();
ExpressionNode ast = astBuilder.visit(parseTree);
//      â†“
// ast æ˜¯ä¸€æ£µè‡ªå®šä¹‰ASTæ ‘ï¼Œä¾‹å¦‚:
//      AdditionNode
//     /          \
// NumberNode(3)  MultiplicationNode
//                /          \
//          NumberNode(5)  NumberNode(2)

// â†’ Topic 4 ä½¿ç”¨: ASTæ±‚å€¼
EvalExprVisitor evaluator = new EvalExprVisitor();
double result = evaluator.visit(ast);  // è¿”å› 13.0
```

**å…³ç³»è¯´æ˜**:
- Topic 3 çš„ `BuildAstVisitor` ç”ŸæˆAST
- Topic 4 çš„ `EvalExprVisitor` æ¶ˆè´¹AST
- ASTæ˜¯ä¸¤è€…ä¹‹é—´çš„ä¸­é—´æ•°æ®ç»“æ„

---

### ä¸»é¢˜4: ASTæ±‚å€¼å®ç°

#### ğŸ“ åœ¨EP11ä¸­çš„ä½ç½®
```
Layer 3: Concrete Implementation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic 4: ASTæ±‚å€¼          â”‚
â”‚  â””â”€ EvalExprVisitor        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ å®ç°Topic 2æ¥å£
         â†“ éå†Topic 3çš„AST
```

#### ğŸ”— ä¾èµ–å…³ç³»
- **å‰ç½®ä¾èµ–**: Topic 1 (ExpressionNodeèŠ‚ç‚¹)ã€Topic 2 (ASTVisitoræ¥å£)ã€Topic 3 (BuildAstVisitorç”ŸæˆAST)
- **åç»­åº”ç”¨**: Topic 5 (å®Œæ•´åº”ç”¨)

#### 4.1 æ ¸å¿ƒæ¦‚å¿µ

**æ¦‚å¿µ1: é€’å½’æ±‚å€¼ç®—æ³•**

è¡¨è¾¾å¼æ±‚å€¼é‡‡ç”¨**ååºéå†**ç­–ç•¥ï¼š
1. å…ˆè®¡ç®—å·¦å­æ ‘
2. å†è®¡ç®—å³å­æ ‘
3. æœ€åæ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„è¿ç®—

```
æ±‚å€¼è¿‡ç¨‹:
      AdditionNode
     /          \
   visit(left)  visit(right)
      â†“             â†“
   NumberNode(3)  MultiplicationNode
                     â†“
              visit(left)  visit(right)
                   â†“             â†“
              NumberNode(5)  NumberNode(2)
                   â†“             â†“
                   5.0  *  2.0  =  10.0
                     â†“
              3.0  +  10.0  =  13.0
```

**æ¦‚å¿µ2: è§£é‡Šå™¨æ¨¡å¼**

è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreter Patternï¼‰çš„æ ¸å¿ƒï¼š
- å°†è¯­æ³•è§„åˆ™è¡¨ç¤ºä¸ºç±»
- è§£é‡Šå™¨é€šè¿‡éå†è¿™äº›ç±»æ¥"è§£é‡Š"ï¼ˆæ‰§è¡Œï¼‰ç¨‹åº

EP11çš„ASTå±‚æ¬¡ + EvalExprVisitor = è§£é‡Šå™¨æ¨¡å¼çš„ç»å…¸å®ç°

#### 4.2 å®ç°åŸç†

**é˜¶æ®µä¸€: å®ç°åŸºæœ¬ç®—æœ¯è¿ç®—**

**å…³é”®ä»£ç ** (`EvalExprVisitor.java:6-52`):

```java
public class EvalExprVisitor implements ASTVisitor<Double> {
    @Override
    public Double visit(AdditionNode node) {
        // é€’å½’è®¡ç®—å·¦å³å­æ ‘çš„å€¼
        double leftVal = visit(node.getLeft());
        double rightVal = visit(node.getRight());

        // æ‰§è¡ŒåŠ æ³•è¿ç®—
        return leftVal + rightVal;
    }

    @Override
    public Double visit(SubtractionNode node) {
        double leftVal = visit(node.getLeft());
        double rightVal = visit(node.getRight());

        return leftVal - rightVal;
    }

    @Override
    public Double visit(MultiplicationNode node) {
        double leftVal = visit(node.getLeft());
        double rightVal = visit(node.getRight());

        return leftVal * rightVal;
    }

    @Override
    public Double visit(DivisionNode node) {
        double leftVal = visit(node.getLeft());
        double rightVal = visit(node.getRight());

        // é™¤é›¶æ£€æŸ¥
        if (rightVal == 0.0) {
            throw new ArithmeticException("Division by zero");
        }

        return leftVal / rightVal;
    }

    @Override
    public Double visit(NegateNode node) {
        // ä¸€å…ƒå–è´Ÿ
        return -visit(node.getExpr());
    }

    @Override
    public Double visit(NumberNode node) {
        // å¶å­èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›å€¼
        return node.getValue();
    }

    // é€šç”¨è®¿é—®æ–¹æ³• - ä½¿ç”¨ç±»å‹åˆ†å‘
    @Override
    public Double visit(ExpressionNode node) {
        // ä½¿ç”¨instanceofåˆ¤æ–­èŠ‚ç‚¹ç±»å‹
        if (node instanceof AdditionNode) {
            return visit((AdditionNode) node);
        } else if (node instanceof SubtractionNode) {
            return visit((SubtractionNode) node);
        } else if (node instanceof MultiplicationNode) {
            return visit((MultiplicationNode) node);
        } else if (node instanceof DivisionNode) {
            return visit((DivisionNode) node);
        } else if (node instanceof NegateNode) {
            return visit((NegateNode) node);
        } else if (node instanceof NumberNode) {
            return visit((NumberNode) node);
        }
        throw new RuntimeException("Unknown node type: " + node.getClass());
    }
}
```

**ä»£ç è§£æ**:
- **ç¬¬4-8è¡Œ**: **é€’å½’æ±‚å€¼** - å…ˆè®¡ç®—å­æ ‘ï¼Œå†æ‰§è¡Œæ“ä½œ
- **ç¬¬38-40è¡Œ**: **è¿è¡Œæ—¶é”™è¯¯æ£€æŸ¥** - é™¤é›¶ä¿æŠ¤
- **ç¬¬68-81è¡Œ**: **ç±»å‹åˆ†å‘** - ä½¿ç”¨ `instanceof` åˆ¤æ–­ç±»å‹å¹¶è°ƒç”¨é‡è½½æ–¹æ³•

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
**é€’å½’æ±‚å€¼çš„æœ¬è´¨**:
```java
visit(AdditionNode)
  â”œâ”€â”€ visit(NumberNode) â†’ 3.0
  â””â”€â”€ visit(MultiplicationNode)
        â”œâ”€â”€ visit(NumberNode) â†’ 5.0
        â””â”€â”€ visit(NumberNode) â†’ 2.0
        â†’ 5.0 * 2.0 = 10.0
  â†’ 3.0 + 10.0 = 13.0
```

æ¯ä¸ª `visit()` æ–¹æ³•åªåšä¸¤ä»¶äº‹ï¼š
1. é€’å½’è®¡ç®—å­èŠ‚ç‚¹ï¼ˆå§”æ‰˜ï¼‰
2. æ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„è¿ç®—ï¼ˆè´£ä»»ï¼‰
`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

**é˜¶æ®µäºŒ: æ·»åŠ é”™è¯¯å¤„ç†**

**å¢å¼ºç‰ˆ DivisionNode æ±‚å€¼**:

```java
@Override
public Double visit(DivisionNode node) {
    double leftVal = visit(node.getLeft());
    double rightVal = visit(node.getRight());

    // é”™è¯¯æ£€æŸ¥
    if (rightVal == 0.0) {
        // æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        throw new ArithmeticException(
            "Division by zero: " + leftVal + " / " + rightVal
        );
    }

    // æ£€æŸ¥ç»“æœæ˜¯å¦æº¢å‡º
    double result = leftVal / rightVal;
    if (Double.isInfinite(result)) {
        throw new ArithmeticException("Division result overflow");
    }

    return result;
}
```

#### 4.3 å®è·µç»ƒä¹ 

**ç»ƒä¹ 1: æ·»åŠ å¹‚è¿ç®—æ”¯æŒ**

**ä»»åŠ¡**: æ‰©å±•ASTå’ŒVisitorï¼Œæ”¯æŒå¹‚è¿ç®— (`**`)

**è¯­æ³•è§„åˆ™**:
```antlr
expr: expr '**' expr   # PowerExpr
    | ...
    ;
```

**ASTèŠ‚ç‚¹**:
```java
public class PowerNode extends InfixExpressionNode {
    public PowerNode(ExpressionNode left, ExpressionNode right) {
        super(left, right);
    }
}
```

**Visitorå®ç°**:
```java
@Override
public Double visit(PowerNode node) {
    double base = visit(node.getLeft());
    double exponent = visit(node.getRight());

    // ä½¿ç”¨ Math.pow å®ç°å¹‚è¿ç®—
    return Math.pow(base, exponent);
}
```

**æµ‹è¯•**:
```
è¾“å…¥: 2 ** 3 ** 2
é¢„æœŸ: 512 (ä»å³åˆ°å·¦ç»“åˆ: 2 ** (3 ** 2) = 2 ** 9 = 512)
```

**ç»ƒä¹ 2: æ·»åŠ å†…ç½®å‡½æ•°æ”¯æŒ**

**ä»»åŠ¡**: æ”¯æŒ `sqrt()` å’Œ `abs()` ç­‰å†…ç½®å‡½æ•°

**ASTèŠ‚ç‚¹**:
```java
public class FunctionCallNode extends ExpressionNode {
    private String functionName;
    private List<ExpressionNode> arguments;

    public FunctionCallNode(String name, List<ExpressionNode> args) {
        this.functionName = name;
        this.arguments = args;
    }
}
```

**Visitorå®ç°**:
```java
@Override
public Double visit(FunctionCallNode node) {
    String name = node.getFunctionName();
    List<ExpressionNode> args = node.getArguments();

    switch (name) {
        case "sqrt":
            if (args.size() != 1) {
                throw new RuntimeException("sqrt() requires exactly 1 argument");
            }
            double value = visit(args.get(0));
            return Math.sqrt(value);

        case "abs":
            if (args.size() != 1) {
                throw new RuntimeException("abs() requires exactly 1 argument");
            }
            return Math.abs(visit(args.get(0)));

        default:
            throw new RuntimeException("Unknown function: " + name);
    }
}
```

**æµ‹è¯•**:
```
è¾“å…¥: sqrt(16) + abs(-5)
é¢„æœŸ: 9.0
```

---

#### ğŸ”„ ä»æœ¬ä¸»é¢˜åˆ°ç»¼åˆåº”ç”¨

**è¿æ¥ä»£ç **:

```java
// å®Œæ•´çš„ç®¡çº¿:
// 1. è¯æ³•/è¯­æ³•åˆ†æ (EP3)
MathLexer lexer = new MathLexer(CharStreams.fromString("3 + 5 * 2"));
CommonTokenStream tokens = new CommonTokenStream(lexer);
MathParser parser = new MathParser(tokens);
ParseTree parseTree = parser.compileUnit();

// 2. ASTæ„å»º (Topic 3)
BuildAstVisitor astBuilder = new BuildAstVisitor();
ExpressionNode ast = astBuilder.visit(parseTree);

// 3. ASTæ±‚å€¼ (Topic 4)
EvalExprVisitor evaluator = new EvalExprVisitor();
double result = evaluator.visit(ast);

System.out.println("Result: " + result);  // è¾“å‡º: 13.0
```

**å…³ç³»è¯´æ˜**:
- Topic 3 å’Œ Topic 4 å¯ä»¥**ä¸²è”ä½¿ç”¨**
- BuildAstVisitor ç”ŸæˆAST
- EvalExprVisitor æ¶ˆè´¹AST
- è¿™ç§è®¾è®¡å®ç°äº†**å…³æ³¨ç‚¹åˆ†ç¦»**

---

### ä¸»é¢˜5: ç»¼åˆåº”ç”¨ - å®Œæ•´çš„è¡¨è¾¾å¼è§£é‡Šå™¨

#### ğŸ“ åœ¨EP11ä¸­çš„ä½ç½®
```
Layer 4: Application Layer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic 5: ç»¼åˆåº”ç”¨         â”‚
â”‚  â””â”€ Calc                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ ç»„åˆTopic 1-4
         â†“ å®Œæ•´åº”ç”¨
```

#### ğŸ”— ä¾èµ–å…³ç³»
- **å‰ç½®ä¾èµ–**: Topic 1-4 (æ‰€æœ‰ä¸»é¢˜)
- **åŠŸèƒ½**: æ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œå±•ç¤ºå®Œæ•´çš„è¡¨è¾¾å¼è§£é‡Šå™¨

#### 5.1 æ ¸å¿ƒæ¦‚å¿µ

**æ¦‚å¿µ1: ç¼–è¯‘å™¨å‰ç«¯çš„å®Œæ•´ç®¡çº¿**

```
æºä»£ç : "3 + 5 * 2"
  â†“ [è¯æ³•åˆ†æ]
Tokenæµ: [INT(3), +, INT(5), *, INT(2)]
  â†“ [è¯­æ³•åˆ†æ]
ParseTree: (è®°å½•è§£æè¿‡ç¨‹)
  â†“ [ASTæ„å»º]
è‡ªå®šä¹‰AST: (è¯­ä¹‰å¹²å‡€çš„æ ‘)
  â†“ [è¯­ä¹‰æ±‚å€¼]
ç»“æœ: 13.0
```

**æ¦‚å¿µ2: è®¾è®¡æ¨¡å¼çš„ååŒ**

EP11ç»¼åˆè¿ç”¨äº†å¤šç§è®¾è®¡æ¨¡å¼ï¼š
- **ç»„åˆæ¨¡å¼**: ASTèŠ‚ç‚¹å±‚æ¬¡ç»“æ„
- **è®¿é—®è€…æ¨¡å¼**: BuildAstVisitor + EvalExprVisitor
- **å·¥å‚æ¨¡å¼**: åˆ›å»ºä¸åŒç±»å‹çš„ASTèŠ‚ç‚¹
- **è§£é‡Šå™¨æ¨¡å¼**: é€’å½’æ±‚å€¼ç®—æ³•
- **ç­–ç•¥æ¨¡å¼**: ä¸åŒVisitorå®ç°ä¸åŒç®—æ³•

#### 5.2 å®ç°åŸç†

**å®Œæ•´åº”ç”¨ç¤ºä¾‹** (`Calc.java`):

```java
public class Calc {
    public static void main(String[] args) throws IOException {
        // ========== é˜¶æ®µ1: è¯æ³•å’Œè¯­æ³•åˆ†æ ==========
        System.out.println("=== é˜¶æ®µ1: è¯æ³•å’Œè¯­æ³•åˆ†æ ===");

        String input = "3 + 5 * 2";

        // 1.1 åˆ›å»ºLexer
        MathLexer lexer = new MathLexer(CharStreams.fromString(input));

        // 1.2 åˆ›å»ºParser
        CommonTokenStream tokens = new CommonTokenStream(lexer);
        MathParser parser = new MathParser(tokens);

        // 1.3 è§£æç¨‹åº
        ParseTree parseTree = parser.compileUnit();
        System.out.println("ParseTreeæ„å»ºå®Œæˆ");

        // ========== é˜¶æ®µ2: ASTæ„å»º ==========
        System.out.println("\n=== é˜¶æ®µ2: ASTæ„å»º ===");

        BuildAstVisitor astBuilder = new BuildAstVisitor();
        ExpressionNode ast = astBuilder.visit(parseTree);
        System.out.println("ASTæ„å»ºå®Œæˆ: " + ast);

        // ========== é˜¶æ®µ3: è¯­ä¹‰æ±‚å€¼ ==========
        System.out.println("\n=== é˜¶æ®µ3: è¯­ä¹‰æ±‚å€¼ ===");

        EvalExprVisitor evaluator = new EvalExprVisitor();
        double result = evaluator.visit(ast);

        System.out.println("æœ€ç»ˆç»“æœ: " + result);
    }
}
```

**ä»£ç è§£æ**:
- **ç¬¬10-16è¡Œ**: åˆ›å»ºLexerå’ŒParser
- **ç¬¬19è¡Œ**: è§£æç”ŸæˆParseTree
- **ç¬¬26-27è¡Œ**: ä½¿ç”¨BuildAstVisitoræ„å»ºè‡ªå®šä¹‰AST
- **ç¬¬33-34è¡Œ**: ä½¿ç”¨EvalExprVisitoræ±‚å€¼

#### 5.3 å®è·µç»ƒä¹ 

**ç»¼åˆç»ƒä¹ : æ„å»ºæ”¯æŒå˜é‡çš„è¡¨è¾¾å¼è§£é‡Šå™¨**

**ä»»åŠ¡**: æ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œå®ç°æ”¯æŒå˜é‡çš„è®¡ç®—å™¨

**åŠŸèƒ½éœ€æ±‚**:
1. å˜é‡å®šä¹‰å’Œèµ‹å€¼
2. å››åˆ™è¿ç®—å’Œæ‹¬å·
3. å†…ç½®å‡½æ•°ï¼ˆsqrt, absï¼‰
4. é”™è¯¯æ£€æµ‹ï¼ˆæœªå®šä¹‰å˜é‡ã€é™¤é›¶é”™è¯¯ï¼‰

**æµ‹è¯•è¾“å…¥**:
```
x = 10
y = 20
z = x + y * 2
sqrt(z)
```

**é¢„æœŸè¾“å‡º**:
```
ç¬¦å·è¡¨: {x=10, y=20, z=50}
ç»“æœ: 7.0710678118654755
```

**å®ç°æ¡†æ¶**:
```java
public class AdvancedCalculator {
    private Map<String, Double> symbolTable = new HashMap<>();
    private Map<String, Function> functionTable = new HashMap<>();

    public double evaluate(String input) {
        // 1. è¯æ³•/è¯­æ³•åˆ†æ
        MathLexer lexer = new MathLexer(CharStreams.fromString(input));
        MathParser parser = new MathParser(new CommonTokenStream(lexer));
        ParseTree tree = parser.compileUnit();

        // 2. ASTæ„å»º
        BuildAstVisitor builder = new BuildAstVisitor();
        ExpressionNode ast = builder.visit(tree);

        // 3. è¯­ä¹‰æ±‚å€¼
        EvalExprVisitor evaluator = new EvalExprVisitor();
        evaluator.setSymbolTable(symbolTable);
        evaluator.setFunctionTable(functionTable);

        return evaluator.visit(ast);
    }

    public static void main(String[] args) throws IOException {
        AdvancedCalculator calc = new AdvancedCalculator();

        // å¤„ç†å¤šè¡Œè¾“å…¥
        calc.evaluate("x = 10");
        calc.evaluate("y = 20");
        calc.evaluate("z = x + y * 2");
        double result = calc.evaluate("sqrt(z)");

        System.out.println("ç»“æœ: " + result);
    }
}
```

---

## ğŸ¯ ç¬¬ä¸‰å±‚ï¼šç»¼åˆå®æˆ˜é¡¹ç›®

### é¡¹ç›®: æ„å»ºå®Œæ•´çš„è¡¨è¾¾å¼è§£é‡Šå™¨

**é¡¹ç›®æè¿°**: ç»¼åˆè¿ç”¨EP11çš„æ‰€æœ‰çŸ¥è¯†ï¼Œæ„å»ºä¸€ä¸ªæ”¯æŒå˜é‡ã€å‡½æ•°ã€æ§åˆ¶æµçš„è¡¨è¾¾å¼è§£é‡Šå™¨

**åŠŸèƒ½éœ€æ±‚**:
1. [ ] å˜é‡å®šä¹‰å’Œå¼•ç”¨
2. [ ] å››åˆ™è¿ç®—å’Œæ‹¬å·
3. [ ] å†…ç½®å‡½æ•°ï¼ˆsqrt, abs, min, maxï¼‰
4. [ ] ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°
5. [ ] é”™è¯¯æ£€æµ‹å’Œå¤„ç†

**æŠ€æœ¯è¦æ±‚**:
- æ‰©å±•ASTèŠ‚ç‚¹å±‚æ¬¡ï¼ˆVariableNode, FunctionCallNode, ...ï¼‰
- å®ç°BuildAstVisitoræ”¯æŒæ–°è¯­æ³•
- å®ç°EvalExprVisitoræ”¯æŒæ–°è¯­ä¹‰
- ç¬¦å·è¡¨ç®¡ç†å˜é‡å’Œå‡½æ•°

**å®ç°æ­¥éª¤**:

**é˜¶æ®µ1: æ‰©å±•ASTèŠ‚ç‚¹**
```java
// å˜é‡èŠ‚ç‚¹
public class VariableNode extends ExpressionNode {
    private String name;
    public VariableNode(String name) { this.name = name; }
    public String getName() { return name; }
}

// å‡½æ•°è°ƒç”¨èŠ‚ç‚¹
public class FunctionCallNode extends ExpressionNode {
    private String functionName;
    private List<ExpressionNode> arguments;
    public FunctionCallNode(String name, List<ExpressionNode> args) {
        this.functionName = name;
        this.arguments = args;
    }
}
```

**é˜¶æ®µ2: æ‰©å±•BuildAstVisitor**
```java
@Override
public ExpressionNode visitIdExpr(MathParser.IdExprContext ctx) {
    String varName = ctx.ID().getText();
    return new VariableNode(varName);
}

@Override
public ExpressionNode visitFuncCall(MathParser.FuncCallContext ctx) {
    String funcName = ctx.ID().getText();
    List<ExpressionNode> args = new ArrayList<>();

    if (ctx.argList() != null) {
        for (MathParser.ExprContext exprCtx : ctx.argList().expr()) {
            args.add(visit(exprCtx));
        }
    }

    return new FunctionCallNode(funcName, args);
}
```

**é˜¶æ®µ3: æ‰©å±•EvalExprVisitor**
```java
public class EvalExprVisitor implements ASTVisitor<Double> {
    private Map<String, Double> symbolTable = new HashMap<>();
    private Map<String, MathFunction> functions = new HashMap<>();

    public EvalExprVisitor() {
        // æ³¨å†Œå†…ç½®å‡½æ•°
        functions.put("sqrt", Math::sqrt);
        functions.put("abs", Math::abs);
        functions.put("min", args -> Arrays.stream(args).min().orElse(0.0));
        functions.put("max", args -> Arrays.stream(args).max().orElse(0.0));
    }

    @Override
    public Double visit(VariableNode node) {
        String name = node.getName();
        if (!symbolTable.containsKey(name)) {
            throw new RuntimeException("Undefined variable: " + name);
        }
        return symbolTable.get(name);
    }

    @Override
    public Double visit(FunctionCallNode node) {
        String name = node.getFunctionName();
        MathFunction func = functions.get(name);

        if (func == null) {
            throw new RuntimeException("Unknown function: " + name);
        }

        double[] args = node.getArguments().stream()
            .map(arg -> visit(arg))
            .mapToDouble(Double::doubleValue)
            .toArray();

        return func.apply(args);
    }
}
```

**é˜¶æ®µ4: æ•´åˆå’Œæµ‹è¯•**
```java
public class ExpressionInterpreter {
    public static void main(String[] args) throws IOException {
        ExpressionInterpreter interpreter = new ExpressionInterpreter();

        // æµ‹è¯•ç”¨ä¾‹
        interpreter.evaluate("x = 10");
        interpreter.evaluate("y = 20");
        interpreter.evaluate("z = x + y * 2");

        double result = interpreter.evaluate("sqrt(z) + abs(-5)");
        System.out.println("ç»“æœ: " + result);  // é¢„æœŸ: 12.0710678118654755
    }
}
```

**æµ‹è¯•ç”¨ä¾‹**:
```
// æµ‹è¯•1: åŸºæœ¬è¿ç®—
è¾“å…¥: 3 + 5 * 2
é¢„æœŸ: 13.0

// æµ‹è¯•2: å˜é‡
è¾“å…¥: x = 10; y = 20; x + y
é¢„æœŸ: 30.0

// æµ‹è¯•3: å†…ç½®å‡½æ•°
è¾“å…¥: sqrt(16) + abs(-5)
é¢„æœŸ: 9.0

// æµ‹è¯•4: å¤åˆè¡¨è¾¾å¼
è¾“å…¥: min(10, 5) + max(3, 7)
é¢„æœŸ: 12.0
```

---

## ğŸ“– è®¾è®¡æ¨¡å¼æ€»ç»“

æœ¬EPæ¶‰åŠçš„æ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼š

1. **Composite Pattern**:
   - `ExpressionNode` å±‚æ¬¡ç»“æ„
   - ç»Ÿä¸€å¯¹å¾…å¶å­èŠ‚ç‚¹å’Œå¤åˆèŠ‚ç‚¹

2. **Visitor Pattern** (åŒé‡åº”ç”¨):
   - `BuildAstVisitor`: ParseTree â†’ AST
   - `EvalExprVisitor`: AST â†’ è®¡ç®—ç»“æœ

3. **Factory Pattern**:
   - æ ¹æ®æ“ä½œç¬¦ç±»å‹åˆ›å»ºä¸åŒçš„è¡¨è¾¾å¼èŠ‚ç‚¹

4. **Interpreter Pattern**:
   - é€’å½’æ±‚å€¼æ˜¯è§£é‡Šå™¨æ¨¡å¼çš„å…¸å‹åº”ç”¨

5. **Strategy Pattern**:
   - ä¸åŒVisitorå®ç°ä¸åŒç®—æ³•ï¼ˆæ±‚å€¼ã€ç±»å‹æ£€æŸ¥ã€æ‰“å°ç­‰ï¼‰

---

## âœ… æ£€æŸ¥ç‚¹

å®Œæˆæœ¬EPåï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰AST
- [ ] è®¾è®¡ç±»å‹å®‰å…¨çš„ASTèŠ‚ç‚¹å±‚æ¬¡
- [ ] å®ç°Visitorå°†ParseTreeè½¬æ¢ä¸ºAST
- [ ] å®ç°é€’å½’æ±‚å€¼ç®—æ³•
- [ ] åº”ç”¨è®¿é—®è€…æ¨¡å¼å’Œç»„åˆæ¨¡å¼
- [ ] ç†è§£ç¼–è¯‘å™¨å‰ç«¯çš„å®Œæ•´æµç¨‹
- [ ] ç†è§£å››å±‚æ¶æ„çš„è®¾è®¡æ€æƒ³
- [ ] ç»¼åˆè¿ç”¨å¤šç§è®¾è®¡æ¨¡å¼

---

## ğŸ“ ä¸‹ä¸€æ­¥

- **ç»§ç»­å­¦ä¹ **: [EP16_æ•™å­¦æ–‡æ¡£.md](./EP16_æ•™å­¦æ–‡æ¡£.md) - çº¿æ€§ä¸­é—´è¡¨ç¤ºï¼ˆLIRï¼‰
- **æ·±å…¥ç ”ç©¶**: [EP12_æ•™å­¦æ–‡æ¡£.md](./EP12_æ•™å­¦æ–‡æ¡£.md) - SSAå½¢å¼
- **å®Œæ•´é¡¹ç›®**: å®ç°ä¸€ä¸ªæ”¯æŒå˜é‡ã€å‡½æ•°ã€æ§åˆ¶æµçš„è®¡ç®—å™¨è¯­è¨€

---

*ç‰ˆæœ¬: v3.0-three-layer | EP11æ•™å­¦æ–‡æ¡£ | 2025-12-27*
