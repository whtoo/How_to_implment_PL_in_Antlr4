# EP18 æµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•ä½¿ç”¨EP18 TDDé‡æ„é˜¶æ®µ1å»ºç«‹çš„å„ç§æµ‹è¯•å’Œè´¨é‡ä¿è¯å·¥å…·ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘å’Œæµ‹è¯•
```bash
# ç¼–è¯‘é¡¹ç›®
mvn clean compile

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
mvn test

# ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š
mvn test jacoco:report

# æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š (åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€)
open target/site/jacoco/index.html
```

---

## ğŸ§ª æµ‹è¯•æ¡†æ¶

### JUnit 5 + AssertJ

#### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
mvn test -Dtest=VMInterpreterTest

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
mvn test -Dtest=VMInterpreterTest#testSimpleProgram

# è¿è¡ŒåŒ¹é…æ¨¡å¼çš„æµ‹è¯•
mvn test -Dtest="*Test"
```

#### ç¼–å†™æµ‹è¯•ç¤ºä¾‹

```java
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.DisplayName;
import static org.assertj.core.api.Assertions.*;

class MyVMTest extends VMTestBase {

    @Test
    @DisplayName("Should correctly add two numbers")
    void testAddition() throws Exception {
        // Given
        byte[] bytecode = createBytecode(new int[]{
            encodeInstruction(1, 10),  // iconst 10
            encodeInstruction(1, 20),  // iconst 20
            encodeInstruction(2),      // iadd
            encodeInstruction(0)       // halt
        });

        // When & Then
        assertExecutionResult(bytecode, 30);
    }

    @Test
    @DisplayName("Should throw exception for invalid bytecode")
    void testInvalidBytecode() {
        byte[] invalidBytecode = new byte[]{0, 1, 2, 3};

        assertExecutionFails(invalidBytecode);
    }
}
```

### ä½¿ç”¨æµ‹è¯•å¤¹å…·

```java
import static org.teachfx.antlr4.ep18.VMTestFixtures.*;

class ProgramTest extends VMTestBase {

    @Test
    void testFibonacci() throws Exception {
        String fibonacciProgram = getProgram("fibonacci");

        // æ‰§è¡Œç¨‹åº
        int result = executeProgram(fibonacciProgram);

        // éªŒè¯ç»“æœ
        assertThat(result).isGreaterThan(0);
    }

    @Test
    void testAllSimplePrograms() throws Exception {
        // è·å–æ‰€æœ‰æµ‹è¯•ç¨‹åº
        List<String> programs = getAllProgramNames();

        for (String program : programs) {
            System.out.println("Testing: " + program);
            String programCode = getProgram(program);

            // éªŒè¯ç¨‹åºå¯æ‰§è¡Œ
            assertThatCode(() -> executeProgram(programCode))
                .as("Program: " + program)
                .doesNotThrowAnyException();
        }
    }
}
```

### æ€§èƒ½æµ‹è¯•

```java
class PerformanceTest extends VMTestBase {

    @Test
    @DisplayName("Should execute within performance budget")
    void testPerformance() throws Exception {
        byte[] bytecode = createBytecode(new int[]{
            encodeInstruction(1, 10),
            encodeInstruction(1, 20),
            encodeInstruction(2),
            encodeInstruction(0)
        });

        // éªŒè¯æ‰§è¡Œæ—¶é—´ < 1000 çº³ç§’
        assertExecutionTime(bytecode, 1000);

        // æ‰“å°æ€§èƒ½æŒ‡æ ‡
        System.out.println(getTestMetrics());
    }
}
```

---

## ğŸ“Š ä»£ç è¦†ç›–ç‡

### JaCoCoä½¿ç”¨

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
mvn clean test jacoco:report

# æŸ¥çœ‹æŠ¥å‘Š
open target/site/jacoco/index.html

# ç”ŸæˆHTMLæŠ¥å‘Šå¹¶æŸ¥çœ‹
firefox target/site/jacoco/index.html
```

### è¦†ç›–ç‡ç›®æ ‡
- **æ€»ä½“è¦†ç›–ç‡**: â‰¥ 85%
- **æ ¸å¿ƒæ¨¡å—**: â‰¥ 90%
- **æ–°åŠŸèƒ½**: 100%

### åœ¨IDEä¸­æŸ¥çœ‹è¦†ç›–ç‡
1. **IntelliJ IDEA**: Run with Coverage
2. **Eclipse**: Coverage As â†’ JUnit Test

---

## ğŸ” é™æ€åˆ†æ

### Checkstyleä»£ç é£æ ¼

```bash
# è¿è¡ŒCheckstyleæ£€æŸ¥
mvn checkstyle:check

# ç”ŸæˆæŠ¥å‘Š
mvn checkstyle:checkstyle
open target/site/checkstyle.html
```

#### å¸¸è§Checkstyleé”™è¯¯

**1. è¡Œé•¿åº¦è¶…è¿‡120å­—ç¬¦**
```java
// âŒ é”™è¯¯
String veryLongString = "This is a very long string that exceeds the maximum line length of 120 characters which is not allowed";

// âœ… æ­£ç¡®
String veryLongString = "This is a very long string that exceeds the "
        + "maximum line length of 120 characters which is not allowed";
```

**2. å˜é‡å‘½åä¸è§„èŒƒ**
```java
// âŒ é”™è¯¯
int MyVariable = 10;

// âœ… æ­£ç¡®
int myVariable = 10;
```

**3. ç¼ºå°‘Javadoc**
```java
// âŒ é”™è¯¯
public class MyClass { }

// âœ… æ­£ç¡®
/**
 * MyClass description
 */
public class MyClass { }
```

### SpotBugsé™æ€åˆ†æ

```bash
# è¿è¡ŒSpotBugsæ£€æŸ¥
mvn spotbugs:check

# ç”ŸæˆæŠ¥å‘Š
mvn spotbugs:spotbugs
open target/spotbugsXml.html
```

#### å¸¸è§SpotBugsé—®é¢˜

**1. ç©ºæŒ‡é’ˆå¼‚å¸¸**
```java
// âŒ é”™è¯¯
public void process(String str) {
    if (str.equals("test")) { // å¦‚æœsträ¸ºnullä¼šæŠ›å¼‚å¸¸
        // ...
    }
}

// âœ… æ­£ç¡®
public void process(String str) {
    if ("test".equals(str)) {
        // ...
    }
}
```

**2. èµ„æºæ³„æ¼**
```java
// âŒ é”™è¯¯
public void readFile() throws IOException {
    FileReader reader = new FileReader("file.txt");
    reader.read(); // å¦‚æœå¼‚å¸¸ï¼Œreaderä¸ä¼šè¢«å…³é—­
}

// âœ… æ­£ç¡®
public void readFile() throws IOException {
    try (FileReader reader = new FileReader("file.txt")) {
        reader.read();
    }
}
```

---

## âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•

### è¿è¡ŒJMHåŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
mvn clean integration-test

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
mvn test -Dtest=InstructionExecutionBenchmark

# ä½¿ç”¨JMHæ’ä»¶
mvn jmh:benchmark

# è¿è¡Œç‰¹å®šåŸºå‡†æ–¹æ³•
mvn jmh:benchmark -Djmh.include=InstructionExecutionBenchmark.benchmarkSimpleAdd
```

### è‡ªå®šä¹‰JMHå‚æ•°

```bash
# æŒ‡å®šè¿è¡Œæ—¶é—´
mvn jmh:benchmark -Djmh.timeIterations=10s

# æŒ‡å®šé¢„çƒ­æ—¶é—´
mvn jmh:benchmark -Djmh.warmupIterations=10

# æŒ‡å®šæµ‹é‡è¿­ä»£
mvn jmh:benchmark -Djmh.measurementIterations=20

# æŒ‡å®šçº¿ç¨‹æ•°
mvn jmh:benchmark -Djmh.threads=4
```

### åŸºå‡†æµ‹è¯•ç»“æœè§£è¯»

```
Benchmark                                          Mode  Cnt     Score     Error   Units
InstructionExecutionBenchmark.benchmarkSimpleAdd   avgt   10   152.341 Â±  12.456  ns/op
```

- **Benchmark**: æµ‹è¯•æ–¹æ³•å
- **Mode**: æµ‹è¯•æ¨¡å¼ (avgt = å¹³å‡æ—¶é—´)
- **Cnt**: è¿­ä»£æ¬¡æ•°
- **Score**: å¹³å‡æ—¶é—´ (ns/op = æ¯æ“ä½œçº³ç§’æ•°)
- **Error**: è¯¯å·®èŒƒå›´
- **Units**: æ—¶é—´å•ä½

### æ€§èƒ½ç›®æ ‡

| æ“ä½œç±»å‹ | ç›®æ ‡æ€§èƒ½ |
|----------|----------|
| æ ˆæ“ä½œæŒ‡ä»¤ | < 30 ns |
| ç®—æœ¯æŒ‡ä»¤ | < 40 ns |
| æ§åˆ¶æµæŒ‡ä»¤ | < 50 ns |
| å†…å­˜è®¿é—®æŒ‡ä»¤ | < 100 ns |
| å‡½æ•°è°ƒç”¨ | < 200 ns |

---

## ğŸ”§ æ„å»ºå’Œéƒ¨ç½²

### å®Œæ•´æ„å»º

```bash
# å®Œæ•´æ„å»ºåŒ…æ‹¬æ‰€æœ‰æ£€æŸ¥
mvn clean verify

# è¿™å°†è¿è¡Œ:
# 1. ç¼–è¯‘æºä»£ç 
# 2. è¿è¡ŒCheckstyleæ£€æŸ¥
# 3. è¿è¡ŒSpotBugsæ£€æŸ¥
# 4. è¿è¡Œæ‰€æœ‰æµ‹è¯•
# 5. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
# 6. æ‰“åŒ…JARæ–‡ä»¶
```

### å¿«é€Ÿç¼–è¯‘å’Œæµ‹è¯•

```bash
# å¿«é€Ÿç¼–è¯‘å’Œæµ‹è¯•ï¼ˆè·³è¿‡é™æ€åˆ†æï¼‰
mvn clean compile test
```

### ç”Ÿæˆç«™ç‚¹æŠ¥å‘Š

```bash
# ç”Ÿæˆæ‰€æœ‰æŠ¥å‘Š
mvn site

# æŸ¥çœ‹æŠ¥å‘Š
open target/site/index.html
```

---

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å
```java
@Test
@DisplayName("Should correctly add two positive integers")
void shouldAddTwoPositiveIntegers() { }
```

### 2. Given-When-Thenæ¨¡å¼
```java
@Test
void testAddition() {
    // Given - å‡†å¤‡æµ‹è¯•æ•°æ®
    int a = 10;
    int b = 20;

    // When - æ‰§è¡Œæ“ä½œ
    int result = vm.add(a, b);

    // Then - éªŒè¯ç»“æœ
    assertThat(result).isEqualTo(30);
}
```

### 3. å¼‚å¸¸æµ‹è¯•
```java
@Test
void shouldThrowExceptionForInvalidInput() {
    // Given
    byte[] invalidBytecode = createInvalidBytecode();

    // When & Then
    assertThatThrownBy(() -> vm.execute(invalidBytecode))
        .isInstanceOf(VMException.class)
        .hasMessageContaining("Invalid bytecode");
}
```

### 4. æ€§èƒ½æµ‹è¯•
```java
@Test
void shouldMeetPerformanceRequirement() throws Exception {
    // Given
    byte[] bytecode = createSimpleBytecode();

    // When
    long start = System.nanoTime();
    vm.execute(bytecode);
    long end = System.nanoTime();

    long duration = end - start;

    // Then
    assertThat(duration)
        .as("Execution should complete within 1000 ns")
        .isLessThan(1000);
}
```

---

## ğŸ†˜ æ•…éšœæ’é™¤

### æµ‹è¯•å¤±è´¥

**1. æµ‹è¯•æ–¹æ³•æ‰¾ä¸åˆ°**
```bash
# ç¡®ä¿æµ‹è¯•ç±»ä»¥Testç»“å°¾
# è¿è¡Œæ‰€æœ‰æµ‹è¯•çœ‹è¯¦ç»†ä¿¡æ¯
mvn test -X
```

**2. ä¾èµ–ç¼ºå¤±**
```bash
# æ¸…ç†å¹¶é‡æ–°ä¸‹è½½ä¾èµ–
mvn clean install -U
```

**3. æµ‹è¯•è¶…æ—¶**
```bash
# å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–æµ‹è¯•
mvn test -Dtest.timeout=300
```

### é™æ€åˆ†æé”™è¯¯

**1. Checkstyleå¤±è´¥**
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
mvn checkstyle:check -X

# è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
mvn spotless:apply
```

**2. SpotBugså‘ç°Bug**
```bash
# æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
mvn spotbugs:spotbugsXml

# æŸ¥çœ‹GUIå·¥å…·
mvn spotbugs:gui
```

### æ€§èƒ½åŸºå‡†é—®é¢˜

**1. åŸºå‡†æµ‹è¯•ä¸ç¨³å®š**
- å¢åŠ é¢„çƒ­è¿­ä»£æ¬¡æ•°
- å¢åŠ æµ‹é‡è¿­ä»£æ¬¡æ•°
- ç¡®ä¿ç³»ç»Ÿè´Ÿè½½ä½

**2. GCå½±å“ç»“æœ**
```bash
# ä½¿ç”¨G1GC
mvn jmh:benchmark -J-XX:+UseG1GC
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [JUnit 5 ç”¨æˆ·æŒ‡å—](https://junit.org/junit5/docs/current/user-guide/)
- [AssertJ æŒ‡å—](https://assertj.github.io/doc/)
- [JMH æ•™ç¨‹](https://www.baeldung.com/java-microbenchmark-harness)
- [Checkstyle é…ç½®](https://checkstyle.org/config.html)
- [SpotBugs è§„åˆ™](https://spotbugs.readthedocs.io/en/latest/filter.html)

---

## â“ å¸¸è§é—®é¢˜

**Q: å¦‚ä½•è·³è¿‡æŸä¸ªæµ‹è¯•ï¼Ÿ**
A: ä½¿ç”¨ `@Disabled` æ³¨è§£æˆ–å‘½ä»¤è¡Œå‚æ•° `-Dtest.exclude=*MyTest*`

**Q: å¦‚ä½•åªè¿è¡Œå•å…ƒæµ‹è¯•ï¼Œè·³è¿‡é›†æˆæµ‹è¯•ï¼Ÿ**
A: ä½¿ç”¨ `-Dtest.groups=unit` å‚æ•°

**Q: å¦‚ä½•åœ¨å¤±è´¥æ—¶ç»§ç»­è¿è¡Œå…¶ä»–æµ‹è¯•ï¼Ÿ**
A: Maven Surefireé»˜è®¤ä¼šç»§ç»­è¿è¡Œï¼Œä½¿ç”¨ `-Dmaven.test.failure.ignore=false` å¯ä»¥è®¾ç½®å¤±è´¥æ—¶åœæ­¢

**Q: å¦‚ä½•è°ƒè¯•æµ‹è¯•ï¼Ÿ**
A: åœ¨IDEä¸­è®¾ç½®æ–­ç‚¹ï¼Œå³é”®æµ‹è¯•ç±»é€‰æ‹©"Debug"è¿è¡Œ

---

**æ›´æ–°æ—¥æœŸ**: 2025-12-20
**ç‰ˆæœ¬**: v1.0.0
**ç»´æŠ¤è€…**: EP18 TDDé‡æ„å›¢é˜Ÿ
