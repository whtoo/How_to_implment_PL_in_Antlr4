# EP21 改进计划 2025

## 📋 目录

1. [项目现状分析](#项目现状分析)
2. [核心问题识别](#核心问题识别)
3. [改进目标](#改进目标)
4. [详细TODO计划](#详细TODO计划)
5. [实施优先级](#实施优先级)
6. [预期成果](#预期成果)

---

## 1. 项目现状分析

### 1.1 已实现功能

✅ **编译器基础设施**
- 完整的词法/语法分析（ANTLR4）
- AST构建和序列化
- 符号表和作用域管理
- 三地址码（TAC）生成

✅ **中间表示体系**
- MIR（Medium-level IR）基础框架
- LIR（Low-level IR）基础框架
- 分层IR设计模式

✅ **控制流分析**
- CFG构建和可视化（DOT/Mermaid）
- 基本块划分和优化
- 活跃变量分析
- SSA图生成（部分实现）

✅ **代码生成**
- 汇编代码生成框架
- 虚拟机指令发射器

### 1.2 当前结构

```
ep21/
├── src/main/java/org/teachfx/antlr4/ep21/
│   ├── analysis/          # 分析框架（数据流、SSA）
│   ├── ast/               # AST节点
│   ├── ir/                # 中间表示
│   │   ├── lir/           # 低层IR
│   │   └── mir/           # 中层IR
│   ├── pass/              # 编译pass
│   │   ├── ast/           # AST构建
│   │   ├── cfg/           # CFG构建
│   │   ├── codegen/       # 代码生成
│   │   ├── ir/            # IR生成
│   │   └── sematic/       # 语义分析
│   ├── symtab/            # 符号表
│   └── utils/             # 工具类
└── src/test/java/         # 测试代码
```

---

## 2. 核心问题识别

### 2.1 🐛 技术债务

1. **测试覆盖严重不足**
   - 仅1个正式测试类（MIRTest）
   - 无集成测试
   - 无性能基准测试
   - 测试代码行数 < 1% 生产代码

2. **调试代码污染**
   - 15+ 处DEBUG输出语句混杂在生产代码
   - System.out.println 替代日志框架
   - 性能影响未知

3. **未完成的功能**
   - SSA实现不完整（TODO标记）
   - MIR/LIR转换逻辑缺失
   - 优化器框架不完整

### 2.2 🏗️ 架构问题

1. **MIR/LIR体系不完整**
   - 缺少MIR到LIR的转换器
   - MIR/LIR节点类型不完整
   - 无统一的IR访问者接口

2. **优化框架薄弱**
   - 仅1个优化器（ControlFlowAnalysis）
   - 缺少基础优化：常量折叠、死代码消除、复制传播
   - 优化pass管理混乱

3. **代码生成器简单**
   - 仅支持基本指令
   - 无寄存器分配
   - 无指令选择优化

### 2.3 📚 文档缺失

1. **用户文档**
   - 无快速开始指南
   - 无示例代码
   - 无API文档（Javadoc缺失）

2. **开发文档**
   - 架构演进说明缺失
   - 缺少贡献指南
   - 测试策略未文档化

### 2.4 🔧 工程实践不足

1. **构建和CI**
   - 无GitHub Actions工作流
   - 无自动化测试
   - 无代码覆盖率检查

2. **代码质量**
   - 无统一代码风格
   - 缺少静态分析
   - 异常处理不一致

---

## 3. 改进目标

### 3.1 短期目标（1-2周）

1. **提升测试覆盖率到60%+**
2. **清理调试代码**
3. **补充基础文档**
4. **修复已知BUG**

### 3.2 中期目标（3-6周）

1. **完善MIR/LIR体系**
   - 实现MIR到LIR转换器
   - 补全IR节点类型
   - 优化IR表示

2. **增强优化框架**
   - 实现5+个基础优化器
   - 优化pass管理
   - 性能基准测试

3. **完善SSA实现**
   - 完成Φ函数插入
   - 实现变量重命名
   - SSA破坏和恢复

### 3.3 长期目标（7-12周）

1. **完善代码生成**
   - 寄存器分配算法
   - 指令选择优化
   - 支持更多目标

2. **高级优化**
   - 循环优化
   - 向量化
   - 内联优化

3. **生产就绪**
   - 完整的错误处理
   - 性能调优
   - 用户工具链

---

## 4. 详细TODO计划

### P0: 紧急修复（本周）

#### 4.1.1 清理调试代码
- [ ] 删除所有System.out.println DEBUG输出
- [ ] 统一使用Log4j2日志框架
- [ ] 审查日志级别（DEBUG/INFO/WARN/ERROR）
- [ ] 移除调试标志变量

#### 4.1.2 修复已知问题
- [ ] 修复SSAGraph中的TODO（处理其他指令类型）
- [ ] 审查并修复所有FIXME标记
- [ ] 处理空指针异常风险

#### 4.1.3 补充基础测试
- [ ] 为每个主要模块创建测试套件
  - [ ] AST节点测试（20+测试用例）
  - [ ] IR生成测试（15+测试用例）
  - [ ] CFG构建测试（10+测试用例）
  - [ ] 符号表测试（10+测试用例）
- [ ] 至少1个端到端集成测试
- [ ] 代码覆盖率目标：60%

**文件清单**：
```
ep21/src/test/java/org/teachfx/antlr4/ep21/
├── ast/
│   └── ASTNodeTest.java
├── ir/
│   ├── IRGenerationTest.java
│   └── BasicBlockTest.java
├── cfg/
│   └── CFGBuilderTest.java  (扩展)
├── symtab/
│   └── SymbolTableTest.java
└── integration/
    └── EndToEndCompilationTest.java
```

### P1: 核心功能完善（第2-4周）

#### 4.2.1 MIR/LIR体系完善

**4.2.1.1 补全MIR节点**
- [ ] 实现MIRStmt接口的所有子类
  - [ ] MIRIfStmt
  - [ ] MIRWhileStmt
  - [ ] MIRCallStmt
  - [ ] MIRReturnStmt
- [ ] 实现MIRExpr接口的所有子类
  - [ ] MIRBinaryExpr
  - [ ] MIRUnaryExpr
  - [ ] MIRCallExpr
  - [ ] MIRLiteral
- [ ] 完整的MIR访问者模式

**4.2.1.2 补全LIR节点**
- [ ] 实现LIRInstruction接口
  - [ ] LIRALU（算术逻辑运算）
  - [ ] LIRLoad（加载指令）
  - [ ] LIRStore（存储指令）
  - [ ] LIRBranch（分支指令）
  - [ ] LIRCall（调用指令）
- [ ] 机器相关属性（寄存器、内存偏移）

**4.2.1.3 实现MIR→LIR转换器**
- [ ] 创建MIRToLIRConverter类
- [ ] 指令选择算法
- [ ] 寄存器压力分析
- [ ] 调用约定处理

**文件清单**：
```
ep21/src/main/java/org/teachfx/antlr4/ep21/
├── ir/mir/
│   ├── MIRIfStmt.java
│   ├── MIRWhileStmt.java
│   ├── MIRCallStmt.java
│   ├── MIRReturnStmt.java
│   ├── MIRBinaryExpr.java
│   ├── MIRUnaryExpr.java
│   └── MIRCallExpr.java
├── ir/lir/
│   ├── LIRALU.java
│   ├── LIRLoad.java
│   ├── LIRStore.java
│   ├── LIRBranch.java
│   └── LIRCall.java
└── pass/conversion/
    └── MIRToLIRConverter.java
```

#### 4.2.2 优化框架增强

**4.2.2.1 基础优化器实现**
- [ ] 常量折叠（Constant Folding）
- [ ] 死代码消除（Dead Code Elimination）
- [ ] 复制传播（Copy Propagation）
- [ ] 公共子表达式消除（CSE）
- [ ] 强度削弱（Strength Reduction）

**4.2.2.2 优化Pass管理**
- [ ] 创建OptimizationPassManager
- [ ] Pass依赖关系管理
- [ ] 迭代优化直到收敛
- [ ] 优化统计和调试输出

**4.2.2.3 性能基准测试**
- [ ] 编译时间基准测试
- [ ] 生成代码质量评估
- [ ] 优化效果对比分析

**文件清单**：
```
ep21/src/main/java/org/teachfx/antlr4/ep21/
├── optimizer/
│   ├── ConstantFolder.java
│   ├── DeadCodeEliminator.java
│   ├── CopyPropagator.java
│   ├── CSEOptimizer.java
│   └── StrengthReducer.java
└── pass/
    └── OptimizationPassManager.java
```

#### 4.2.3 SSA实现完善

**4.2.3.1 完整SSA构建**
- [ ] 支配树计算
- [ ] 严格支配分析
- [ ] 支配边界计算
- [ ] Φ函数插入算法

**4.2.3.2 变量重命名**
- [ ] 版本号管理
- [ ] 栈管理重命名算法
- [ ] 使用-定义链维护
- [ ] SSA验证器

**4.2.3.3 SSA破坏性操作**
- [ ] 寄存器分配前的SSA破坏
- [ ] 复制插入
- [ ] 颜色算法的SSA处理

**文件清单**：
```
ep21/src/main/java/org/teachfx/antlr4/ep21/
└── analysis/ssa/
    ├── DominatorTree.java
    ├── PhiFunctionInserter.java
    ├── SSARenamer.java
    └── SSADeconstructor.java
```

### P2: 文档和工程实践（第5-6周）

#### 4.3.1 文档完善

**4.3.1.1 API文档**
- [ ] 为所有public类添加Javadoc
- [ ] 关键方法的详细说明
- [ ] 参数和返回值的完整描述
- [ ] 示例代码嵌入

**4.3.1.2 用户指南**
- [ ] 快速开始教程
- [ ] 语言特性说明
- [ ] 编译选项详解
- [ ] 常见问题解答

**4.3.1.3 开发者文档**
- [ ] 架构设计文档
- [ ] 如何添加新的优化Pass
- [ ] IR扩展指南
- [ ] 测试策略说明

#### 4.3.2 工程实践

**4.3.2.1 CI/CD设置**
- [ ] GitHub Actions工作流
  - [ ] 自动编译
  - [ ] 测试运行
  - [ ] 代码覆盖率检查（目标80%）
- [ ] PR模板配置
- [ ] Issue模板配置

**4.3.2.2 代码质量工具**
- [ ] Checkstyle配置
- [ ] FindBugs/SpotBugs集成
- [ ] PMD静态分析
- [ ] 代码格式化（统一风格）

**4.3.2.3 发布流程**
- [ ] Maven发布配置
- [ ] 版本管理策略
- [ ] 发布说明模板

### P3: 高级功能（第7-10周）

#### 4.4.1 循环优化

**4.4.1.1 循环分析**
- [ ] 自然循环识别
- [ ] 循环层次分析
- [ ] 归纳变量识别
- [ ] 循环不变式检测

**4.4.1.2 循环变换**
- [ ] 循环展开
- [ ] 循环合并
- [ ] 循环分裂
- [ ] 循环交换

**4.4.1.3 向量化**
- [ ] 数据依赖分析
- [ ] SIMD指令生成
- [ ] 向量化因子选择

#### 4.4.2 寄存器分配

**4.4.2.1 图着色分配器**
- [ ] 干涉图构建
- [ ] 图着色算法
- [ ] 溢出处理
- [ ] 寄存器合并

**4.4.2.2 线性扫描分配器**
- [ ] 活跃区间计算
- [ ] 区间分配算法
- [ ] 溢出代码插入

**4.4.2.3 高级技术**
- [ ] 寄存器压力重调度
- [ ] 调用约定处理
- [ ] 特殊寄存器管理

#### 4.4.3 指令选择

**4.4.3.1 模式匹配**
- [ ] 树文法定义
- [ ] 动态规划算法
- [ ] 代价模型评估

**4.4.3.2 窥孔优化**
- [ ] 指令序列模式匹配
- [ ] 局部优化规则
- [ ] 目标特定优化

### P4: 性能调优和生产就绪（第11-12周）

#### 4.5.1 性能优化

**4.5.1.1 编译器性能**
- [ ] Profile分析
- [ ] 热点优化
- [ ] 内存使用优化
- [ ] 并行编译支持

**4.5.1.2 生成代码质量**
- [ ] SPEC CPU测试
- [ ] 与GCC/Clang对比
- [ ] 微优化调整

#### 4.5.2 错误处理和诊断

**4.5.2.1 错误恢复**
- [ ] 语法错误恢复
- [ ] 语义错误报告
- [ ] 多错误收集

**4.5.2.2 诊断信息**
- [ ] 详细错误信息
- [ ] 源代码位置追踪
- [ ] 错误建议

#### 4.5.3 工具链完善

**4.5.3.1 命令行工具**
- [ ] 完整的CLI选项
- [ ] 优化级别控制
- [ ] 调试信息生成
- [ ] 链接支持

**4.5.3.2 调试支持**
- [ ] DWARF信息生成
- [ ] 源码级调试
- [ ] 调试符号维护

---

## 5. 实施优先级

### 5.1 第一阶段：基础稳固（第1-2周）

**优先级：P0**
- [ ] 清理所有调试代码
- [ ] 修复已知BUG
- [ ] 补充基础测试（覆盖率>60%）
- [ ] 基础文档（快速开始、API概览）

**验收标准**：
- 无System.out.println在生产代码
- 所有测试通过
- 代码覆盖率>60%
- 基础文档完整

### 5.2 第二阶段：核心增强（第3-6周）

**优先级：P1**
- [ ] 完整MIR/LIR实现
- [ ] 5+基础优化器
- [ ] 完善SSA
- [ ] 中等规模测试套件
- [ ] 开发者文档

**验收标准**：
- MIR→LIR转换器工作
- 优化器都能正确运行
- SSA通过验证测试
- 文档覆盖所有核心模块

### 5.3 第三阶段：工程成熟（第7-8周）

**优先级：P2**
- [ ] CI/CD配置
- [ ] 代码质量工具
- [ ] 完整用户文档
- [ ] 性能基准测试

**验收标准**：
- GitHub Actions通过
- 覆盖率>80%
- 所有文档发布
- 性能基准稳定

### 5.4 第四阶段：高级功能（第9-12周）

**优先级：P3/P4**
- [ ] 循环优化
- [ ] 寄存器分配
- [ ] 指令优化
- [ ] 生产级错误处理

**验收标准**：
- 循环优化有实际效果
- 寄存器分配算法验证
- 生成代码质量提升
- 完整的错误提示

---

## 6. 预期成果

### 6.1 技术成果

1. **功能完整性**
   - ✅ 完整的MIR/LIR体系
   - ✅ 5-8个生产级优化器
   - ✅ 完整的SSA支持
   - ✅ 基本循环优化
   - ✅ 寄存器分配算法

2. **代码质量**
   - ✅ 100%公共API文档
   - ✅ 80%+测试覆盖率
   - ✅ 自动化CI/CD
   - ✅ 代码风格统一
   - ✅ 静态分析通过

3. **文档完整性**
   - ✅ 用户教程（10+示例）
   - ✅ 开发者指南
   - ✅ API文档（Javadoc）
   - ✅ 性能基准报告
   - ✅ 架构设计说明

### 6.2 可交付成果

1. **代码仓库**
   - 清理后的生产代码
   - 完整测试套件
   - 自动化构建

2. **文档集合**
   - README.md（更新）
   - 用户指南（docs/user-guide.md）
   - 开发者文档（docs/developer-guide.md）
   - API文档（Javadoc）
   - 性能报告（docs/performance.md）

3. **工具和脚本**
   - 构建脚本
   - 测试脚本
   - 性能测试套件
   - 示例代码集

### 6.3 量化指标

| 指标 | 当前状态 | 目标状态 |
|------|---------|---------|
| 测试覆盖率 | ~1% | >80% |
| 代码行数 | ~15,000 | ~25,000 |
| 文档页数 | 50页 | 150+页 |
| 优化器数量 | 1个 | 6-8个 |
| 测试用例数 | 10个 | 200+个 |
| 构建时间 | N/A | <5分钟 |
| 性能提升 | N/A | 20-50% |

---

## 附录

### A. 相关文件

- **当前TODO.md** - 短期任务跟踪
- **单元概要.md** - 模块说明
- **详细设计.md** - 架构文档
- **README.md** - 项目介绍
- **README_EN.md** - 英文介绍

### B. 术语表

- **MIR**: Medium-level Intermediate Representation（中层中间表示）
- **LIR**: Low-level Intermediate Representation（低层中间表示）
- **SSA**: Static Single Assignment（静态单赋值）
- **CFG**: Control Flow Graph（控制流图）
- **TAC**: Three Address Code（三地址码）

### C. 参考资料

- 《编译器设计》（龙书）
- 《现代编译器实现》（虎书）
- LLVM官方文档
- ANTLR4文档

---

**创建日期**: 2025-11-27  
**版本**: 1.0  
**作者**: EP21改进团队
