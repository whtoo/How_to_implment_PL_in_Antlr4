# EP18 ç¼–è¯‘é”™è¯¯ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-12-20
**çŠ¶æ€**: âœ… ç¼–è¯‘æˆåŠŸï¼Œâš ï¸ æµ‹è¯•å¤±è´¥

---

## ç¼–è¯‘é”™è¯¯ä¿®å¤ (âœ… å·²å®Œæˆ)

### æ€»è®¡ä¿®å¤ 15 ä¸ªç¼–è¯‘é”™è¯¯

| é”™è¯¯ç±»å‹ | æ–‡ä»¶ | ä¿®å¤æ–¹æ¡ˆ |
|---------|------|----------|
| ç¼ºå°‘import | DynamicLinker.java | æ·»åŠ  `import org.teachfx.antlr4.ep18.stackvm.StackFrame;` |
| è®¿é—®æƒé™ | LabelSymbol.java | æ·»åŠ  `getName()` å’Œ `getAddress()` æ–¹æ³• |
| å­—æ®µè®¿é—® | DynamicLinker.java | ä½¿ç”¨ `label.getName()` æ›¿ä»£ `label.name` |
| å­—æ®µè®¿é—® | DynamicLinker.java | ä½¿ç”¨ `label.getAddress()` æ›¿ä»£ `label.address` |
| æ„é€ å‡½æ•° | StackFrame.java | æ·»åŠ å‘åå…¼å®¹æ„é€ å‡½æ•° |
| ç§æœ‰å­—æ®µ | CymbolStackVM.java | ä½¿ç”¨ `frame.getReturnAddress()` æ›¿ä»£ `frame.returnAddress` |
| ç§æœ‰å­—æ®µ | VMInterpreter.java | ä½¿ç”¨ `f.getLocals()[i]` æ›¿ä»£ `f.locals[i]` |
| ç§æœ‰å­—æ®µ | VMInterpreter.java | ä½¿ç”¨ `fr.getReturnAddress()` æ›¿ä»£ `fr.returnAddress` |
| ç§æœ‰å­—æ®µ | VMInterpreter.java | ä½¿ç”¨ `calls[fp].getLocals()[loadAddr]` |
| ç§æœ‰å­—æ®µ | VMInterpreter.java | ä½¿ç”¨ `calls[fp].getLocals()[storeAddr]` |
| ç§æœ‰å­—æ®µ | VMInterpreter.java | ä½¿ç”¨ `f.getLocals()[a]` |
| ç§æœ‰å­—æ®µ | VMInterpreter.java | ä½¿ç”¨ `calls[i].getSymbol().name` |
| æ„é€ å‡½æ•°éªŒè¯ | StackFrame.java | æ”¾å®½returnAddresséªŒè¯ï¼Œå…è®¸-1ç­‰ç‰¹æ®Šå€¼ |
| ç‰ˆæœ¬é…ç½® | pom.xml | æ›´æ–°Checkstyleæ’ä»¶ç‰ˆæœ¬åˆ°3.6.0 |

---

## ç¼–è¯‘ç»“æœ

```
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  2.113 s
[INFO] Finished at: 2025-12-20T14:42:27+08:00
[INFO] ------------------------------------------------------------------------
```

âœ… **ç¼–è¯‘æˆåŠŸ** - æ‰€æœ‰50ä¸ªæºæ–‡ä»¶ç¼–è¯‘é€šè¿‡

---

## æµ‹è¯•å¤±è´¥åˆ†æ (âš ï¸ éœ€è¦è§£å†³)

### å¤±è´¥ç»Ÿè®¡

```
Tests run: 74
Failures: 1
Errors: 17
Skipped: 5
```

### ä¸»è¦é”™è¯¯ç±»å‹

#### 1. Return address must be non-negative (17ä¸ªé”™è¯¯)

**é”™è¯¯ç¤ºä¾‹**:
```
java.lang.IllegalArgumentException: Return address must be non-negative
    at org.teachfx.antlr4.ep18.stackvm.StackFrame.<init>(StackFrame.java:42)
```

**é—®é¢˜**: StackFrameæ„é€ å‡½æ•°éªŒè¯returnAddressä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œä½†VMInterpreterä¸­ä½¿ç”¨-1ä½œä¸ºç‰¹æ®Šæƒ…å†µ

**ä¿®å¤**: âœ… å·²æ”¾å®½éªŒè¯ï¼Œå…è®¸ç‰¹æ®Šå€¼å¦‚-1

#### 2. Local variable index out of bounds (2ä¸ªé”™è¯¯)

**é”™è¯¯ç¤ºä¾‹**:
```
java.lang.IllegalArgumentException: Local variable index out of bounds: 0
    at org.teachfx.antlr4.ep18.stackvm.CymbolStackVM.executeLoad(CymbolStackVM.java:572)
```

**é—®é¢˜**:
- æµ‹è¯•ç¨‹åºå£°æ˜ `locals=0`ï¼ˆæ— å±€éƒ¨å˜é‡ï¼‰
- ä½†å­—èŠ‚ç ä¸­ä½¿ç”¨ `load` æŒ‡ä»¤å°è¯•è®¿é—®ç´¢å¼•0çš„å±€éƒ¨å˜é‡
- å¯¼è‡´ç´¢å¼•è¶Šç•Œ

**åŸå› åˆ†æ**:
- LOADæŒ‡ä»¤ä¸åº”è¯¥åœ¨æ— å±€éƒ¨å˜é‡çš„å‡½æ•°ä¸­ä½¿ç”¨
- å¯èƒ½æ˜¯æµ‹è¯•æ•°æ®é—®é¢˜æˆ–æ±‡ç¼–å™¨é—®é¢˜
- æˆ–è€…æ–°æŒ‡ä»¤ç³»ç»Ÿä¸æ—§ç³»ç»Ÿçš„å…¼å®¹æ€§é—®é¢˜

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®å¤æµ‹è¯•ç¨‹åº (æ¨è)

æ£€æŸ¥æµ‹è¯•ç¨‹åºä¸­çš„`.def main: args=0, locals=0`å£°æ˜ï¼š
- å¦‚æœéœ€è¦ä½¿ç”¨LOAD/STOREæŒ‡ä»¤ï¼Œåº”å£°æ˜`locals>=1`
- å¦‚æœä¸éœ€è¦å±€éƒ¨å˜é‡ï¼Œä¸åº”ä½¿ç”¨LOAD/STOREæŒ‡ä»¤

### æ–¹æ¡ˆ2: è°ƒæ•´éªŒè¯é€»è¾‘

åœ¨CymbolStackVMçš„executeLoad/executeStoreæ–¹æ³•ä¸­ï¼š
- æ£€æŸ¥localsæ•°ç»„é•¿åº¦
- å¦‚æœä¸º0ï¼Œåˆ™LOAD/STOREåº”è¯¥æŠ›å‡ºæ›´æ˜ç¡®çš„é”™è¯¯

### æ–¹æ¡ˆ3: æ±‡ç¼–å™¨å±‚é¢éªŒè¯

åœ¨æ±‡ç¼–é˜¶æ®µæ£€æŸ¥ï¼š
- LOAD/STOREæŒ‡ä»¤ç´¢å¼•å¿…é¡»åœ¨å‡½æ•°å£°æ˜çš„localsèŒƒå›´å†…
- æå‰å‘ç°ä¸åŒ¹é…

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ£€æŸ¥æµ‹è¯•æ•°æ®** - éªŒè¯æµ‹è¯•ç¨‹åºæ˜¯å¦æ­£ç¡®å£°æ˜äº†å±€éƒ¨å˜é‡
2. **åˆ†æLOADæŒ‡ä»¤ä½¿ç”¨** - ç¡®è®¤å“ªäº›æµ‹è¯•å®é™…ä½¿ç”¨äº†LOADæŒ‡ä»¤
3. **ä¿®å¤æµ‹è¯•ç¨‹åº** - æ›´æ–°æµ‹è¯•ç¨‹åºä¸­çš„localså£°æ˜
4. **é‡æ–°è¿è¡Œæµ‹è¯•** - éªŒè¯ä¿®å¤æ•ˆæœ

---

## ä»£ç è´¨é‡æ”¹è¿›

### å·²å®ç°çš„æ”¹è¿›

1. **å°è£…æ€§æå‡** - æ‰€æœ‰StackFrameå­—æ®µç§æœ‰åŒ–
2. **APIå®Œå–„** - æ·»åŠ getter/setteræ–¹æ³•
3. **å‘åå…¼å®¹** - ä¿ç•™æ—§æ„é€ å‡½æ•°
4. **é”™è¯¯å¤„ç†** - æ”¹è¿›éªŒè¯é€»è¾‘

### å»ºè®®çš„åç»­æ”¹è¿›

1. **å•å…ƒæµ‹è¯•** - ä¸ºæ–°æŒ‡ä»¤ç±»æ·»åŠ å•å…ƒæµ‹è¯•
2. **é›†æˆæµ‹è¯•** - æµ‹è¯•æ–°æ—§æŒ‡ä»¤ç³»ç»Ÿé›†æˆ
3. **æ–‡æ¡£æ›´æ–°** - æ›´æ–°APIæ–‡æ¡£
4. **æ€§èƒ½æµ‹è¯•** - éªŒè¯é‡æ„åçš„æ€§èƒ½

---

**çŠ¶æ€**:
- âœ… ç¼–è¯‘: æˆåŠŸ
- âš ï¸ æµ‹è¯•: å¤±è´¥ (éœ€è¦ä¿®å¤æµ‹è¯•æ•°æ®)
- ğŸ“‹ ä¸‹ä¸€æ­¥: ä¿®å¤æµ‹è¯•ç¨‹åºä¸­çš„localså£°æ˜

**ä¿®å¤ä¼˜å…ˆçº§**: ä¸­ç­‰ - ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†éœ€è¦è§£å†³æµ‹è¯•é—®é¢˜
