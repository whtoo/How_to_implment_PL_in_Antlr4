# EP18 专属工作记忆

**EP 名称**: EP18 (栈式虚拟机)
**文档版本**: v1.0
**最后更新**: 2025-12-20
**状态**: EP 专用记忆

---

## 📌 EP18 核心定位

### EP18 在架构中的位置

```
┌─────────────────────────────────────────┐
│           EP16-EP18 虚拟机栈              │
└─────────────────────────────────────────┘
                  ↓
        ┌─────────▼─────────┐
        │      EP18         │
        │  栈式虚拟机实现      │
        └─────────┬─────────┘
                  ↓
        ┌─────────▼─────────┐
        │   EP17 字节码      │
        └─────────┬─────────┘
                  ↓
        ┌─────────▼─────────┐
        │   EP16 代码生成    │
        └─────────────────────┘
```

**依赖关系**:
- **上游**: EP16 (代码生成器产生字节码) 和 EP17 (字节码格式)
- **下游**: 无 (EP18 是虚拟机栈的终点)

---

## 🏗️ EP18 目录结构

```
ep18/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── org/teachfx/antlr4/ep18/
│   │   │       ├── vm/
│   │   │       │   ├── CymbolStackVM.java       <-- 核心虚拟机
│   │   │       │   ├── VMConfig.java            <-- VM 配置
│   │   │       │   └── ExecutionContext.java    <-- 执行上下文
│   │   │       ├── bytecode/
│   │   │       │   ├── Instruction.java         <-- 指令定义
│   │   │       │   ├── OpCode.java              <-- 操作码枚举
│   │   │       │   └── BytecodeValidator.java   <-- 字节码验证
│   │   │       ├── runtime/
│   │   │       │   ├── OperandStack.java        <-- 操作数栈
│   │   │       │   ├── CallStack.java           <-- 调用栈
│   │   │       │   └── HeapMemory.java          <-- 堆内存
│   │   │       └── types/
│   │   │           └── VMTypes.java             <-- VM 类型系统
│   │   └── resources/
│   │       └── log4j2.xml
│   └── test/
│       ├── java/
│       │   └── org/teachfx/antlr4/ep18/
│       │       ├── vm/
│       │       │   ├── CymbolStackVMTest.java
│       │       │   └── ExecutionContextTest.java
│       │       ├── bytecode/
│       │       │   └── InstructionTest.java
│       │       └── runtime/
│       │           ├── OperandStackTest.java
│       │           └── HeapMemoryTest.java
│       └── resources/
│           └── test-programs/
└── docs/
    ├── EP18_ABI_设计文档.md      <-- ABI 规范
    ├── EP18_核心设计文档.md      <-- 核心设计
    └── TDD_重构优化方案.md       <-- TDD 计划
```

### 核心文件速查表

| 功能模块 | 主要文件 | 关键类 | 测试文件 |
|----------|----------|--------|----------|
| **虚拟机引擎** | `CymbolStackVM.java` | `CymbolStackVM` | `CymbolStackVMTest.java` |
| **指令系统** | `Instruction.java` | `Instruction` | `InstructionTest.java` |
| **操作数栈** | `OperandStack.java` | `OperandStack` | `OperandStackTest.java` |
| **调用栈** | `CallStack.java` | `CallStack` | `CallStackTest.java` |
| **堆内存** | `HeapMemory.java` | `HeapMemory` | `HeapMemoryTest.java` |
| **字节码验证** | `BytecodeValidator.java` | `BytecodeValidator` | `BytecodeValidatorTest.java` |

---

## 🔑 关键类和接口

### 核心类

#### 1. CymbolStackVM (虚拟机主类)
```java
public class CymbolStackVM {
    private final OperandStack operandStack;
    private final CallStack callStack;
    private final HeapMemory heapMemory;
    private final Instruction[] code;
    private int pc;  // 程序计数器
    
    public void execute(Instruction[] code);
    private void executeInstruction(Instruction instr);
    public int getStackTop();
}
```

#### 2. Instruction (指令表示)
```java
public class Instruction {
    private final OpCode opcode;
    private final int[] operands;
    
    public void execute(CymbolStackVM vm);
}
```

#### 3. OperandStack (操作数栈)
```java
public class OperandStack {
    private int[] stack;
    private int sp;  // 栈指针
    
    public void push(int value);
    public int pop();
    public int peek();
}
```

#### 4. CallStack (调用栈)
```java
public class CallStack {
    private StackFrame[] frames;
    private int framePointer;
    
    public void pushFrame(StackFrame frame);
    public StackFrame popFrame();
    public StackFrame getCurrentFrame();
}
```

#### 5. HeapMemory (堆内存)
```java
public class HeapMemory {
    private int[] heap;
    private int heapPtr;
    
    public int allocate(int size);
    public void free(int address);
}
```

---

## 📋 任务规范

### 添加新指令流程
```bash
# 1. 在 OpCode.java 添加操作码
INVOKE_VIRTUAL(45)

# 2. 在 Instruction.java 实现执行逻辑
case INVOKE_VIRTUAL -> executeInvokeVirtual(vm)

# 3. 编写测试
@Test
void testInvokeVirtual() { ... }

# 4. 运行测试
mvn test -pl ep18
```

### 测试结果
- 测试类：`ep18/src/test/java/org/teachfx/antlr4/ep18/...`
- 覆盖率报告：`ep18/target/site/jacoco/index.html`
- 覆盖率要求：≥85%

---

## 🔗 跨 EP 接口

### EP18 依赖 EP16/EP17
- **字节码格式**: EP17 定义的字节码格式
- **指令集**: EP16 生成的指令

### EP18 为 EP19 提供支持
- **VM 执行接口**: `CymbolStackVM.execute()`
- **内存检查接口**: `HeapMemory.getUsage()`

---

## 📊 当前状态

### 已实现功能
- [✅] 基础指令集 (42条)
- [✅] 栈帧管理
- [✅] 堆内存分配
- [✅] 调用约定

### 测试中
- [🔄] GC 集成
- [⏸️] 调试支持

---

**维护**: EP18 工作专用，不加载其他 EP 实现细节
**最后更新**: 2025-12-20
