# EP18R-EP21 联动计划执行协调报告

**日期**: 2026-01-11
**状态**: 📝 协调计划制定中
**相关文档**: [EP18R-EP21联动融合计划](EP18R-EP21联动融合计划.md)

---

## 1. 当前状态分析

### 1.1 EP18R 状态

| 维度 | 当前状态 | 状态 |
|------|----------|------|
| **核心功能** | ✅ 完成 | Phase 6-9完成 |
| **测试通过率** | 100% (131/131) | ✅ 稳定 |
| **寄存器分配** | 成熟LinearScanAllocator | ✅ 可复用 |
| **调用约定** | 完整实现 | ✅ 可复用 |
| **接口抽象** | 3个核心接口定义 | ✅ EP21可使用 |
| **代码质量** | 25%重复率，48%覆盖率 | ⚠️ 需改进 |

### 1.2 EP21 状态

| 维度 | 当前状态 | 状态 |
|------|----------|------|
| **核心功能** | ✅ 完成 | 编译器完整 |
| **测试通过率** | 100% (563/563) | ✅ 稳定 |
| **寄存器分配** | 简单round-robin | ⚠️ 待改进 |
| **代码生成** | StackVMGenerator + RegisterVMGenerator | ⚠️ 待集成 |
| **接口抽象** | ICodeGenerator接口 | ✅ 已存在 |
| **EP18R集成** | 无直接依赖 | ⚠️ 待实现 |

### 1.3 联动障碍分析

| 障碍 | 影响 | 优先级 |
|------|------|--------|
| **EP18R Phase 10-11未完成** | 代码质量和文档不完整 | 🔴 高 |
| **EP21未使用LinearScanAllocator** | 寄存器分配质量低 | 🔴 高 |
| **无端到端集成测试** | 无法验证集成效果 | 🔴 高 |
| **接口契约不明确** | EP21调用EP18R的接口未定义 | 🟡 中 |
| **测试基础设施未共享** | 重复开发测试工具 | 🟢 低 |

---

## 2. 联动计划执行协调

### 2.1 立即行动（Week 1）

#### 行动2.1.1: 评估EP18R Phase 10-11影响

**目标**: 确定Phase 10-11未完成对EP21联动的具体影响

**分析**:
1. **测试覆盖率不足（48% vs 85%）**:
   - 影响: EP21可能无法充分测试EP18R集成
   - 缓解: 优先提升EP18R与EP21相关的覆盖率
   - 优先级: EP21集成的相关类覆盖率≥90%

2. **JavaDoc不完整**:
   - 影响: EP21开发者难以理解EP18R接口
   - 缓解: 补充EP21使用的接口的JavaDoc
   - 优先级: ICodeGenerator、IRegisterAllocator、RegisterVMInterpreter

3. **性能基准缺失**:
   - 影响: 无法量化集成性能提升
   - 缓解: 建立EP21→EP18R的性能基准
   - 优先级: 中

**输出**: EP18R Phase 10-11对EP21联动的影响评估报告

---

#### 行动2.1.2: 定义EP21→EP18R接口契约

**目标**: 明确EP21如何调用EP18R的接口

**关键接口**:

| EP21使用 | EP18R提供 | 状态 |
|----------|-----------|------|
| ICodeGenerator | RegisterAssembler | ⚠️ 待定义 |
| IRegisterAllocator | LinearScanAllocator | ⚠️ 待定义 |
| VirtualMachine | RegisterVMInterpreter | ⚠️ 待定义 |

**接口契约示例**:
```java
// EP21使用的接口
public interface IRegisterAllocator {
    /**
     * 分配寄存器给临时变量
     * @param tempVars 临时变量列表
     * @param usedRegs 已使用的寄存器掩码
     * @return 寄存器分配结果
     */
    RegisterAllocationResult allocate(List<TempVar> tempVars, int usedRegs);
}

// EP18R提供的实现
public class LinearScanAllocator implements IRegisterAllocator {
    @Override
    public RegisterAllocationResult allocate(List<TempVar> tempVars, int usedRegs) {
        // 实现逻辑
    }
}
```

**输出**: EP21→EP18R接口契约文档

---

### 2.2 短期行动（Week 2-3）

#### 行动2.2.1: 集成EP18R的LinearScanAllocator到EP21

**目标**: EP21的RegisterVMGenerator使用EP18R的LinearScanAllocator

**步骤**:
1. **Phase 1: 接口适配** (2天)
   - 识别EP18R的LinearScanAllocator接口
   - 定义EP21的IRegisterAllocator接口
   - 创建适配器（如果接口不兼容）

2. **Phase 2: 集成实现** (3天)
   - 修改EP21的RegisterVMGenerator
   - 替换round-robin分配为LinearScanAllocator
   - 测试寄存器分配质量

3. **Phase 3: 验证和测试** (2天)
   - 运行EP21的563个测试
   - 验证寄存器分配改进
   - 性能基准测试

**预期效果**:
- 寄存器利用率从~50%提升到≥70%
- 减少寄存器溢出
- 代码生成质量提升

**输出**: 集成验证报告

---

#### 行动2.2.2: 创建端到端集成测试

**目标**: 建立EP21→EP18R的端到端测试套件

**测试范围**:
1. **完整编译管道测试** (10个测试)
   - EP21编译Cymbol代码
   - 生成EP18R字节码
   - EP18R执行验证结果

2. **语义等价性测试** (10个测试)
   - 相同源代码，EP18 vs EP18R执行结果对比
   - 验证寄存器VM的正确性

3. **性能对比测试** (5个测试)
   - EP18 vs EP18R执行速度对比
   - 验证性能提升≥10%

**预期测试数量**: 25-30个

**创建文件**: `EP21-EP18RIntegrationTest.java`

---

#### 行动2.2.3: 建立共享测试基础设施

**目标**: 避免重复开发测试工具

**共享组件**:
1. **测试数据集**: EP21的测试用例库
2. **测试工具**: 公共测试基类和断言工具
3. **性能测试工具**: JMH基准测试框架
4. **覆盖率工具**: JaCoCo配置和报告生成

**创建文件**:
- `SharedTestUtils.java` - 公共测试工具
- `IntegrationTestBase.java` - 集成测试基类

---

### 2.3 中期行动（Week 4-6）

#### 行动2.3.1: 优化EP18R Phase 10-11

**目标**: 解决Phase 10-11未完成的问题

**优先任务**:
1. **补充EP21相关接口的JavaDoc** (2天)
   - IRegisterAllocator
   - RegisterAssembler
   - RegisterVMInterpreter

2. **提升EP21相关类的覆盖率** (3天)
   - 目标: EP21使用的类覆盖率≥90%

3. **建立性能基准** (2天)
   - EP21→EP18R编译管道性能基准
   - EP18 vs EP18R执行性能对比

---

#### 行动2.3.2: 代码生成器工厂模式

**目标**: 支持动态选择StackVM或RegisterVM

**实现**:
1. 创建GeneratorFactory
2. 支持配置选择目标VM
3. 便于扩展新的代码生成器

**创建文件**: `GeneratorFactory.java`

---

### 2.4 长期规划（Week 7+）

#### 行动2.4.1: 持续优化和监控

**目标**: 持续改进集成质量

**监控指标**:
- EP21测试通过率: 保持100%
- EP18R测试通过率: 保持100%
- 集成测试通过率: 100%
- 性能提升: 保持≥10%
- 寄存器利用率: ≥70%

---

## 3. 执行时间表

### Week 1: 准备和评估

| 天数 | 任务 | 责任人 | 状态 |
|-----|------|--------|------|
| Day 1-2 | 评估Phase 10-11影响 | Sisyphus | 📝 待执行 |
| Day 3-5 | 定义接口契约 | Sisyphus | 📝 待执行 |

### Week 2-3: 集成和测试

| 天数 | 任务 | 责任人 | 状态 |
|-----|------|--------|------|
| Day 1-2 | 接口适配 | EP21开发者 | 📝 待执行 |
| Day 3-5 | 集成实现 | EP21开发者 | 📝 待执行 |
| Day 6-7 | 验证和测试 | EP21开发者 | 📝 待执行 |
| Day 8-10 | 端到端集成测试 | Sisyphus | 📝 待执行 |
| Day 11-15 | 共享测试基础设施 | Sisyphus | 📝 待执行 |

### Week 4-6: 优化和完善

| 天数 | 任务 | 责任人 | 状态 |
|-----|------|--------|------|
| Day 1-2 | 补充接口JavaDoc | Sisyphus | 📝 待执行 |
| Day 3-5 | 提升覆盖率 | Sisyphus | 📝 待执行 |
| Day 6-7 | 建立性能基准 | Sisyphus | 📝 待执行 |
| Day 8-10 | 代码生成器工厂 | EP21开发者 | 📝 待执行 |
| Day 11-15 | 持续优化监控 | 联合团队 | 📝 待执行 |

---

## 4. 风险与缓解

### 4.1 识别的风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Phase 10-11未完成 | 高 | 高 | 优先解决EP21相关问题 |
| 接口不兼容 | 高 | 中 | 创建适配器 |
| 集成测试失败 | 高 | 中 | 分阶段集成，逐步验证 |
| 性能下降 | 中 | 低 | 建立性能基准，持续监控 |

### 4.2 风险缓解策略

1. **分阶段集成**: 先接口适配，再功能集成，最后端到端测试
2. **向后兼容**: 保留EP21原有实现，作为回退方案
3. **持续监控**: 建立CI/CD流程，每次提交自动测试

---

## 5. 成功标准

### 5.1 量化指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| EP21测试通过率 | 100% | mvn test |
| EP18R测试通过率 | 100% | mvn test |
| 集成测试通过率 | 100% | mvn test |
| 寄存器利用率 | ≥70% | 寄存器分配器测试 |
| 性能提升 | ≥10% | 性能基准测试 |
| 接口文档覆盖率 | 100% | JavaDoc检查 |

### 5.2 质量标准

| 标准 | 要求 |
|------|------|
| 接口契约 | 清晰、完整、可测试 |
| 集成测试 | 覆盖所有关键路径 |
| 文档完整性 | 所有公共接口有JavaDoc |
| 性能 | 无性能下降 |

---

## 6. 资源需求

### 6.1 人力资源

| 角色 | 时间 | 职责 |
|------|------|------|
| Sisyphus (EP18R) | 2-3周 | 接口定义、JavaDoc、覆盖率提升 |
| EP21开发者 | 2-3周 | LinearScanAllocator集成、端到端测试 |
| 联合团队 | 1周 | 集成测试、性能基准 |

### 6.2 工具和环境

| 工具 | 版本 | 用途 |
|------|------|------|
| Maven | 3.8+ | 项目构建和测试 |
| JaCoCo | 0.8.10 | 覆盖率分析 |
| JMH | 1.36 | 性能基准测试 |

---

## 7. 下一步行动

### 立即行动（今天）

1. **评估Phase 10-11影响**:
   - 分析EP21使用的EP18R接口
   - 识别缺少的JavaDoc
   - 评估覆盖率不足的影响

2. **定义接口契约**:
   - IRegisterAllocator接口规范
   - RegisterAssembler接口规范
   - RegisterVMInterpreter接口规范

### 短期行动（本周）

3. **接口适配准备**:
   - 识别接口不兼容点
   - 设计适配器（如果需要）

4. **集成测试设计**:
   - 设计端到端测试用例
   - 准备测试数据集

### 中期行动（下周）

5. **开始集成**:
   - EP21集成LinearScanAllocator
   - 创建端到端集成测试

---

**报告生成时间**: 2026-01-11
**状态**: 📝 协调计划制定中
**预计完成时间**: 2026-02-01
**下一步**: 执行立即行动（评估Phase 10-11影响）
