# EP18R å¯è§†åŒ–æ¨¡å— (vizvmr) è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

**vizvmr** æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯è§†åŒ–æ¨¡å—ï¼Œä¸º EP18R å¯„å­˜å™¨è™šæ‹Ÿæœºæä¾›å®æ—¶çš„å›¾å½¢åŒ–æ‰§è¡Œè¿‡ç¨‹å±•ç¤ºã€‚è¯¥æ¨¡å—é‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼è®¾è®¡ï¼Œé€šè¿‡äº‹ä»¶ç›‘å¬å™¨æ•è·è™šæ‹Ÿæœºæ‰§è¡ŒçŠ¶æ€ï¼Œä½¿ç”¨ Java Swing æ„å»ºäº¤äº’å¼ GUI ç•Œé¢ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **å®æ—¶å¯è§†åŒ–**: æ˜¾ç¤ºå¯„å­˜å™¨æ–‡ä»¶ã€å†…å­˜ã€è°ƒç”¨æ ˆç­‰è™šæ‹Ÿæœºç»„ä»¶çš„å®æ—¶çŠ¶æ€
2. **äº¤äº’å¼æ§åˆ¶**: æä¾›å•æ­¥æ‰§è¡Œã€æ–­ç‚¹è®¾ç½®ã€æš‚åœ/ç»§ç»­ç­‰è°ƒè¯•åŠŸèƒ½
3. **çŠ¶æ€è·Ÿè¸ª**: è®°å½•å’Œå›æ”¾æŒ‡ä»¤æ‰§è¡Œå†å²
4. **æ•™å­¦å‹å¥½**: ç•Œé¢ç›´è§‚ï¼Œé€‚åˆç¼–è¯‘å™¨åŸç†æ•™å­¦æ¼”ç¤º
5. **æ¨¡å—åŒ–è®¾è®¡**: ç‹¬ç«‹æ¨¡å—ï¼Œä¸ EP18R è™šæ‹Ÿæœºæ¾è€¦åˆ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    vizvmr å¯è§†åŒ–æ¨¡å—                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ GUIå±‚   â”‚  â”‚æ§åˆ¶å±‚   â”‚  â”‚æ¨¡å‹å±‚   â”‚  â”‚é›†æˆå±‚   â”‚   â”‚
â”‚  â”‚         â”‚  â”‚         â”‚  â”‚         â”‚  â”‚         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                EP18R å¯„å­˜å™¨è™šæ‹Ÿæœºæ¨¡å—                    â”‚
â”‚                 (RegisterVMInterpreter)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„å±‚æ¬¡
1. **GUIå±‚ (Presentation Layer)**: Java Swing ç»„ä»¶ï¼Œè´Ÿè´£ç•Œé¢æ¸²æŸ“å’Œç”¨æˆ·äº¤äº’
2. **æ§åˆ¶å±‚ (Control Layer)**: æ‰§è¡Œæ§åˆ¶å™¨ã€æ–­ç‚¹ç®¡ç†å™¨ã€å†å²è®°å½•ç®¡ç†å™¨
3. **æ¨¡å‹å±‚ (Model Layer)**: çŠ¶æ€æ¨¡å‹ã€äº‹ä»¶ç³»ç»Ÿã€æ•°æ®ç®¡ç†å±‚
4. **é›†æˆå±‚ (Integration Layer)**: è™šæ‹Ÿæœºæ’æ¡©é€‚é…å™¨ã€æ¡¥æ¥å™¨ã€æ¥å£é€‚é…å™¨

## ğŸ“ æ¨¡å—ç»“æ„

### åŒ…ç»“æ„
```
org.teachfx.antlr4.ep18r.vizvmr/
â”œâ”€â”€ VizVMRLauncher.java            # ç‹¬ç«‹å¯åŠ¨å™¨
â”‚
â”œâ”€â”€ core/                          # æ ¸å¿ƒæ¨¡å‹
â”‚   â”œâ”€â”€ VMRStateModel.java         # çŠ¶æ€æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ VMRExecutionHistory.java   # æ‰§è¡Œå†å²è®°å½•
â”‚
â”œâ”€â”€ event/                         # äº‹ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ VMRStateListener.java      # çŠ¶æ€ç›‘å¬å™¨æ¥å£ (å«vmStateChanged)
â”‚   â”œâ”€â”€ VMRExecutionListener.java  # æ‰§è¡Œç›‘å¬å™¨æ¥å£
â”‚   â”œâ”€â”€ VMRStateEvent.java         # çŠ¶æ€äº‹ä»¶åŸºç±»
â”‚   â”œâ”€â”€ RegisterChangeEvent.java   # å¯„å­˜å™¨å˜åŒ–äº‹ä»¶
â”‚   â”œâ”€â”€ MemoryChangeEvent.java     # å†…å­˜å˜åŒ–äº‹ä»¶
â”‚   â”œâ”€â”€ PCChangeEvent.java         # ç¨‹åºè®¡æ•°å™¨å˜åŒ–äº‹ä»¶
â”‚   â”œâ”€â”€ InstructionExecutionEvent.java # æŒ‡ä»¤æ‰§è¡Œäº‹ä»¶
â”‚   â””â”€â”€ VMStateChangeEvent.java    # è™šæ‹ŸæœºçŠ¶æ€å˜åŒ–äº‹ä»¶
â”‚
â”œâ”€â”€ integration/                   # é›†æˆå±‚
â”‚   â”œâ”€â”€ VMRInstrumentation.java    # è™šæ‹Ÿæœºæ’æ¡©é€‚é…å™¨
â”‚   â””â”€â”€ VMRVisualBridge.java       # å¯è§†åŒ–æ¡¥æ¥å™¨
â”‚
â”œâ”€â”€ controller/                    # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ VMRStepController.java     # å•æ­¥æ‰§è¡Œæ§åˆ¶å™¨
â”‚   â””â”€â”€ VMRBreakpointManager.java  # æ–­ç‚¹ç®¡ç†å™¨
â”‚
â”œâ”€â”€ ui/                            # ç”¨æˆ·ç•Œé¢
â”‚   â”œâ”€â”€ MainFrame.java             # ä¸»çª—å£æ¡†æ¶
â”‚   â”œâ”€â”€ panel/                     # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ RegisterPanel.java     # å¯„å­˜å™¨æ˜¾ç¤ºé¢æ¿
â”‚   â”‚   â”œâ”€â”€ MemoryPanel.java       # å†…å­˜æ˜¾ç¤ºé¢æ¿
â”‚   â”‚   â”œâ”€â”€ CodePanel.java         # ä»£ç æ˜¾ç¤ºé¢æ¿
â”‚   â”‚   â”œâ”€â”€ StackPanel.java        # è°ƒç”¨æ ˆé¢æ¿
â”‚   â”‚   â”œâ”€â”€ ControlPanel.java      # æ§åˆ¶é¢æ¿
â”‚   â”‚   â”œâ”€â”€ StatusPanel.java       # çŠ¶æ€é¢æ¿
â”‚   â”‚   â””â”€â”€ LogPanel.java          # æ—¥å¿—é¢æ¿ (æ–°å¢)
â”‚   â””â”€â”€ dialog/                    # å¯¹è¯æ¡† (é¢„ç•™)
â”‚
â””â”€â”€ util/                          # å·¥å…·ç±»
    â””â”€â”€ ConfigPersistence.java     # é…ç½®æŒä¹…åŒ– (æ–°å¢)
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. äº‹ä»¶ç›‘å¬å™¨ç³»ç»Ÿ (Event Listener System)

#### çŠ¶æ€ç›‘å¬å™¨ (VMRStateListener)
```java
public interface VMRStateListener extends EventListener {
    void registerChanged(RegisterChangeEvent event);
    void memoryChanged(MemoryChangeEvent event);
    void pcChanged(PCChangeEvent event);
    void vmStateChanged(VMStateChangeEvent event);  // æ·»åŠ ï¼šè™šæ‹ŸæœºçŠ¶æ€å˜åŒ–ç›‘å¬
    default void registersUpdated(RegisterChangeEvent[] events);
    default void memoryUpdated(MemoryChangeEvent[] events);
}
```

#### æ‰§è¡Œç›‘å¬å™¨ (VMRExecutionListener)
```java
public interface VMRExecutionListener extends EventListener {
    default void instructionFetched(InstructionExecutionEvent event);
    default void beforeInstructionDecode(InstructionExecutionEvent event);
    default void beforeInstructionExecute(InstructionExecutionEvent event);
    default void afterInstructionExecute(InstructionExecutionEvent event);
    void vmStateChanged(VMStateChangeEvent event);
    default void executionError(Throwable error, int pc);
    default void executionStarted();
    default void executionFinished();
    default void executionPaused();
}
```

### 2. çŠ¶æ€æ¨¡å‹ (VMRStateModel)

#### èŒè´£
- ç®¡ç†è™šæ‹Ÿæœºæ‰€æœ‰çŠ¶æ€ï¼ˆå¯„å­˜å™¨ã€å†…å­˜ã€è°ƒç”¨æ ˆã€PCç­‰ï¼‰
- æä¾›çŠ¶æ€å˜æ›´é€šçŸ¥æœºåˆ¶
- ç»´æŠ¤ä¿®æ”¹è¿½è¸ªå’Œæ€§èƒ½ç»Ÿè®¡
- æ”¯æŒæ‰¹å¤„ç†æ›´æ–°ä»¥æé«˜æ€§èƒ½

#### å…³é”®æ•°æ®ç»“æ„
```java
public class VMRStateModel {
    // çŠ¶æ€å­˜å‚¨
    private final int[] registers;                 // 16ä¸ªå¯„å­˜å™¨å€¼
    private int[] heap;                            // å †å†…å­˜ (éfinalï¼Œæ”¯æŒrestoreSnapshot)
    private int[] globals;                         // å…¨å±€å˜é‡ (éfinalï¼Œæ”¯æŒrestoreSnapshot)
    private final StackFrame[] callStack;          // è°ƒç”¨æ ˆ
    private int framePointer;                      // å½“å‰å¸§æŒ‡é’ˆ
    private int programCounter;                    // ç¨‹åºè®¡æ•°å™¨
    private int heapAllocPointer;                  // å †åˆ†é…æŒ‡é’ˆ

    // ä¿®æ”¹è¿½è¸ª
    private final boolean[] registerModified;      // å¯„å­˜å™¨ä¿®æ”¹æ ‡è®°
    private final Set<Integer> modifiedMemoryAddresses; // å†…å­˜ä¿®æ”¹åœ°å€
    private final Set<Integer> modifiedHeapAddresses;   // å †ä¿®æ”¹åœ°å€

    // ç›‘å¬å™¨ç®¡ç†
    private final List<VMRStateListener> stateListeners;
    private final List<VMRExecutionListener> executionListeners;

    // æ‰§è¡ŒçŠ¶æ€
    private volatile VMStateChangeEvent.State vmState;
    private long executionSteps;
    private long startTime;
    private int eventStepNumber;                   // äº‹ä»¶æ­¥æ•°è®¡æ•°å™¨
}
```

### 3. è™šæ‹Ÿæœºæ’æ¡©é€‚é…å™¨ (VMRInstrumentation)

#### è®¾è®¡æ¨¡å¼ï¼šé€‚é…å™¨æ¨¡å¼ + åå°„
- **ç›®çš„**: åœ¨ä¸ä¿®æ”¹ EP18R æºä»£ç çš„æƒ…å†µä¸‹ç›‘å¬è™šæ‹Ÿæœºå†…éƒ¨çŠ¶æ€
- **å®ç°**: ä½¿ç”¨ Java åå°„è®¿é—®è™šæ‹Ÿæœºç§æœ‰å­—æ®µå’Œæ–¹æ³•
- **å…³é”®æ’æ¡©ç‚¹**:
  - å¯„å­˜å™¨è¯»å†™æ“ä½œ
  - å†…å­˜è®¿é—®æ“ä½œ
  - ç¨‹åºè®¡æ•°å™¨æ›´æ–°
  - è°ƒç”¨æ ˆæ“ä½œ
  - æŒ‡ä»¤æ‰§è¡Œå‰å

#### åå°„å­—æ®µè®¿é—®
```java
public class VMRInstrumentation {
    // åå°„å­—æ®µç¼“å­˜
    private Field registersField;
    private Field programCounterField;
    private Field framePointerField;
    private Field heapField;
    private Field heapAllocPointerField;
    private Field callStackField;
    private Field runningField;
    
    // åŒæ­¥çŠ¶æ€åˆ°æ¨¡å‹
    public void syncState() {
        syncRegisters();
        syncMemory();
        syncCallStack();
        syncProgramCounter();
    }
}
```

### 4. å¯è§†åŒ–æ¡¥æ¥å™¨ (VMRVisualBridge)

#### èŒè´£
- è¿æ¥è™šæ‹Ÿæœºå’Œå¯è§†åŒ–ç•Œé¢
- ç®¡ç†æ‰§è¡Œçº¿ç¨‹å’Œæ§åˆ¶æµ
- æä¾›åæ±‡ç¼–æ”¯æŒ
- å¤„ç†æ‰§è¡Œæ§åˆ¶ï¼ˆå¯åŠ¨ã€æš‚åœã€åœæ­¢ã€å•æ­¥ï¼‰

#### æ‰§è¡Œæ§åˆ¶çŠ¶æ€æœº
```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ç©ºé—²    â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚ loadProgram()
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å·²åŠ è½½  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚ startExecution()
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ‰§è¡Œä¸­   â”‚â—„â”€â”€â”
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
    pause()   â”‚   resume()â”‚
              â–¼          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
         â”‚ å·²æš‚åœ   â”‚â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚ stopExecution()
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å·²åœæ­¢  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. GUIç•Œé¢è®¾è®¡

#### ä¸»çª—å£å¸ƒå±€ (MainFrame)
```
+-------------------------------------------------+
| [èœå•æ ] File View Run Debug Help               |
+-------------------------------------------------+
| [å·¥å…·æ ] â–¶ â¸ â¹ â­  ğŸ” ğŸ’¾ ğŸ“Š                    |
+-------------------------------------------------+
| [ä»£ç é¢æ¿]        | [å¯„å­˜å™¨é¢æ¿]                |
| PC: 0x004 li r1, 100| r0: 0x00000000 (0)       |
| PC: 0x008 add r2, r1, r1 | r1: 0x00000064 (100)|
| PC: 0x00C add r3, r2, r1 | r2: 0x000000c8 (200)|
| ...               | ...                         |
|                   | r15: 0x00000000 (0)        |
+-------------------+-----------------------------+
| [å†…å­˜é¢æ¿]        | [è°ƒç”¨æ ˆé¢æ¿]                |
| 0x0000: 0x12345678| Frame 0: main (PC=0x004)   |
| 0x0004: 0x9abcdef0| Frame 1: func1 (PC=0x024)  |
| 0x0008: 0xdeadbeef| Frame 2: func2 (PC=0x044)  |
| ...               | ...                         |
+-------------------+-----------------------------+
| [çŠ¶æ€æ ] å·²æ‰§è¡Œ: 153 æŒ‡ä»¤ | è€—æ—¶: 0.45s | âœ…è¿è¡Œä¸­|
+-------------------------------------------------+
```

#### ç»„ä»¶è¯¦ç»†è®¾è®¡

##### å¯„å­˜å™¨é¢æ¿ (RegisterPanel)
- **å¸ƒå±€**: 4Ã—4ç½‘æ ¼ï¼Œæ˜¾ç¤º16ä¸ªå¯„å­˜å™¨
- **é¢œè‰²ç¼–ç **:
  - ğŸ”´ çº¢è‰²: æœ€è¿‘ä¿®æ”¹çš„å¯„å­˜å™¨
  - ğŸ”µ è“è‰²: ç‰¹æ®Šå¯„å­˜å™¨ (r13-SP, r14-FP, r15-LR)
  - âšª ç°è‰²: æœªä¿®æ”¹çš„å¯„å­˜å™¨
  - ğŸŸ¢ ç»¿è‰²: é›¶å¯„å­˜å™¨ (r0)
- **æ˜¾ç¤ºæ ¼å¼**: åå…­è¿›åˆ¶ (0x...) + åè¿›åˆ¶ + å­—ç¬¦è¡¨ç¤º
- **äº¤äº’**: åŒå‡»ä¿®æ”¹å€¼ï¼Œå³é”®æŸ¥çœ‹å†å²

##### å†…å­˜é¢æ¿ (MemoryPanel)
- **å¸ƒå±€**: å¯æ»šåŠ¨çš„è¡¨æ ¼ï¼Œæ¯è¡Œæ˜¾ç¤º4ä¸ªå†…å­˜å­—
- **æ˜¾ç¤ºæ¨¡å¼**:
  - åå…­è¿›åˆ¶: `0x12345678`
  - åè¿›åˆ¶: `305419896`
  - ASCII: æ˜¾ç¤ºå¯æ‰“å°å­—ç¬¦ (32-126)
- **åŠŸèƒ½**: åœ°å€æœç´¢ã€è·³è½¬ã€å†…å­˜èŒƒå›´æŸ¥çœ‹

##### ä»£ç é¢æ¿ (CodePanel)
- **åŠŸèƒ½**: æ˜¾ç¤ºåæ±‡ç¼–æŒ‡ä»¤ï¼Œé«˜äº®å½“å‰PC
- **åæ±‡ç¼–å™¨**: ä½¿ç”¨ EP18R çš„ `RegisterDisAssembler`
- **æ ‡è®°**:
  - â— çº¢è‰²åœ†ç‚¹: æ–­ç‚¹
  - ğŸŸ¡ é»„è‰²èƒŒæ™¯: å½“å‰PCä½ç½®
  - ğŸŸ¢ æµ…ç»¿èƒŒæ™¯: å·²æ‰§è¡ŒæŒ‡ä»¤
- **äº¤äº’**: ç‚¹å‡»è®¾ç½®æ–­ç‚¹ï¼Œå³é”®è·³è½¬

##### è°ƒç”¨æ ˆé¢æ¿ (StackPanel)
- **æ˜¾ç¤º**: å‚ç›´åˆ—è¡¨ï¼Œæ˜¾ç¤ºè°ƒç”¨æ ˆå±‚æ¬¡
- **ä¿¡æ¯**: å‡½æ•°åã€è¿”å›åœ°å€ã€å±€éƒ¨å˜é‡æ•°
- **å±•å¼€/æŠ˜å **: æŸ¥çœ‹å±€éƒ¨å˜é‡è¯¦æƒ…
- **å¯¼èˆª**: åŒå‡»è·³è½¬åˆ°è¿”å›åœ°å€

##### æ§åˆ¶é¢æ¿ (ControlPanel)
```java
public class ControlPanel extends JPanel {
    // æ§åˆ¶æŒ‰é’®
    private JButton btnStart;      // â–¶ å¼€å§‹æ‰§è¡Œ
    private JButton btnPause;      // â¸ æš‚åœæ‰§è¡Œ
    private JButton btnStop;       // â¹ åœæ­¢æ‰§è¡Œ
    private JButton btnStep;       // â­ å•æ­¥æ‰§è¡Œ
    private JButton btnStepOver;   // â­â­ å•æ­¥æ­¥è¿‡
    private JButton btnStepOut;    // â­â†— å•æ­¥æ­¥å‡º
    private JButton btnRunToBreak; // â­â— è¿è¡Œåˆ°æ–­ç‚¹
    
    // æ–­ç‚¹ç®¡ç†
    private JButton btnAddBreak;   // +â— æ·»åŠ æ–­ç‚¹
    private JButton btnRemoveBreak;// -â— åˆ é™¤æ–­ç‚¹
    private JButton btnClearBreaks;// Ã—â— æ¸…é™¤æ‰€æœ‰æ–­ç‚¹
}
```

##### çŠ¶æ€é¢æ¿ (StatusPanel)
- **æ‰§è¡Œç»Ÿè®¡**: å·²æ‰§è¡ŒæŒ‡ä»¤æ•°ã€è¿è¡Œæ—¶é—´ã€æŒ‡ä»¤é¢‘ç‡
- **è™šæ‹ŸæœºçŠ¶æ€**: è¿è¡Œä¸­ã€å·²æš‚åœã€å·²åœæ­¢ã€é”™è¯¯
- **æ€§èƒ½æŒ‡æ ‡**: å¹³å‡æŒ‡ä»¤æ—¶é—´ã€å†…å­˜ä½¿ç”¨ç‡
- **é€šçŸ¥åŒºåŸŸ**: æ˜¾ç¤ºè­¦å‘Šã€é”™è¯¯ã€ä¿¡æ¯æ¶ˆæ¯

## ğŸ”Œ ä¸EP18Rçš„é›†æˆæ¥å£

### 1. æ‰©å±• IVirtualMachine æ¥å£
```java
// å»ºè®®åœ¨ EP18R ä¸­æ‰©å±•æ¥å£
public interface IVirtualMachineVisualizable extends IVirtualMachine {
    // ç›‘å¬å™¨ç®¡ç†
    void addStateListener(VMRStateListener listener);
    void removeStateListener(VMRStateListener listener);
    void addExecutionListener(VMRExecutionListener listener);
    void removeExecutionListener(VMRExecutionListener listener);
    
    // çŠ¶æ€è·å–
    int[] getRegisterValues();
    int getProgramCounter();
    StackFrame[] getCallStack();
    byte[] getCodeMemory();
    Object[] getConstantPool();
    
    // æ‰§è¡Œæ§åˆ¶
    void setExecutionMode(ExecutionMode mode);
    void setBreakpoints(Set<Integer> breakpoints);
    void pauseExecution();
    void resumeExecution();
}
```

### 2. å®é™…é›†æˆæ–¹æ¡ˆ
ç”±äºä¸èƒ½ä¿®æ”¹ EP18R æºä»£ç ï¼Œé‡‡ç”¨ **åå°„é€‚é…å™¨æ¨¡å¼**ï¼š

1. **VMRInstrumentation**: é€šè¿‡åå°„è®¿é—®è™šæ‹Ÿæœºå†…éƒ¨çŠ¶æ€
2. **çŠ¶æ€åŒæ­¥**: å®šæœŸåŒæ­¥å¯„å­˜å™¨ã€å†…å­˜ã€è°ƒç”¨æ ˆçŠ¶æ€
3. **äº‹ä»¶è§¦å‘**: åœ¨è™šæ‹Ÿæœºå…³é”®ä½ç½®æ’å…¥äº‹ä»¶è§¦å‘ç‚¹
4. **æ§åˆ¶ä»£ç†**: é€šè¿‡æ¡¥æ¥å™¨æ§åˆ¶è™šæ‹Ÿæœºæ‰§è¡Œæµç¨‹

### 3. æ•°æ®æµ
```
è™šæ‹Ÿæœºæ‰§è¡Œ â†’ çŠ¶æ€å˜åŒ– â†’ äº‹ä»¶è§¦å‘ â†’ ç›‘å¬å™¨é€šçŸ¥ â†’ çŠ¶æ€æ¨¡å‹æ›´æ–° â†’ GUIåˆ·æ–°
    â†‘           â†‘           â†‘           â†‘           â†‘           â†‘
    â”‚           â”‚           â”‚           â”‚           â”‚           â”‚
æ§åˆ¶å‘½ä»¤ â†â”€â”€ ç”¨æˆ·æ“ä½œ â†â”€â”€ GUIäº‹ä»¶ â†â”€â”€ çŠ¶æ€åŒæ­¥ â†â”€â”€ æ¨¡å‹æŸ¥è¯¢ â†â”€â”€ ç•Œé¢æ¸²æŸ“
```

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

### 1. äº‹ä»¶æ•°æ®ç»“æ„
```java
public abstract class VMRStateEvent extends EventObject {
    private final long timestamp;      // äº‹ä»¶æ—¶é—´æˆ³
    private final int stepNumber;      // æ‰§è¡Œæ­¥æ•°
    
    public abstract String getDescription(); // äº‹ä»¶æè¿°
}

public class RegisterChangeEvent extends VMRStateEvent {
    private final int registerIndex;   // å¯„å­˜å™¨ç´¢å¼• (0-15)
    private final int oldValue;        // æ—§å€¼
    private final int newValue;        // æ–°å€¼
    private final String registerName; // å¯„å­˜å™¨åç§° (r0-r15)
}

public class MemoryChangeEvent extends VMRStateEvent {
    private final int address;         // å†…å­˜åœ°å€
    private final int oldValue;        // æ—§å€¼
    private final int newValue;        // æ–°å€¼
    private final MemoryType type;     // å†…å­˜ç±»å‹ (HEAP, GLOBAL, STACK)
}
```

### 2. çŠ¶æ€å¿«ç…§
```java
public class VMRStateSnapshot {
    private final int[] registers;     // å¯„å­˜å™¨å€¼å¿«ç…§
    private final int[] heap;          // å †å†…å­˜å¿«ç…§
    private final int[] globals;       // å…¨å±€å˜é‡å¿«ç…§
    private final StackFrame[] callStack; // è°ƒç”¨æ ˆå¿«ç…§
    private final int programCounter;  // PCå¿«ç…§
    private final long timestamp;      // å¿«ç…§æ—¶é—´
    private final int stepNumber;      // æ‰§è¡Œæ­¥æ•°
    
    // åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ”¯æŒ
    public byte[] serialize() { ... }
    public static VMRStateSnapshot deserialize(byte[] data) { ... }
}
```

## ğŸš€ æ‰§è¡Œæ§åˆ¶è®¾è®¡

### 1. æ‰§è¡Œæ¨¡å¼æšä¸¾
```java
public enum ExecutionMode {
    RUN,                    // è¿ç»­æ‰§è¡Œ
    STEP,                   // å•æ­¥æ‰§è¡Œ
    STEP_OVER,              // å•æ­¥æ­¥è¿‡ï¼ˆé‡åˆ°callæ‰§è¡Œæ•´ä¸ªå‡½æ•°ï¼‰
    STEP_OUT,               // å•æ­¥æ­¥å‡ºï¼ˆæ‰§è¡Œåˆ°å½“å‰å‡½æ•°è¿”å›ï¼‰
    STEP_TO_BREAKPOINT,     // è¿è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹
    PAUSE,                  // æš‚åœæ‰§è¡Œ
    STOP                    // åœæ­¢æ‰§è¡Œ
}
```

### 2. æ–­ç‚¹ç³»ç»Ÿ
```java
public class VMRBreakpointManager {
    private final Set<Integer> breakpoints; // æ–­ç‚¹åœ°å€é›†åˆ
    private final Map<Integer, BreakpointCondition> conditions; // æ¡ä»¶æ–­ç‚¹
    
    public static class BreakpointCondition {
        private final String expression; // æ¡ä»¶è¡¨è¾¾å¼
        private final Predicate<ExecutionContext> predicate; // æ¡ä»¶è°“è¯
        
        public boolean evaluate(ExecutionContext context) {
            return predicate.test(context);
        }
    }
    
    // æ–­ç‚¹å‘½ä¸­æ£€æŸ¥
    public boolean shouldBreak(int pc, ExecutionContext context) {
        return breakpoints.contains(pc) && 
               (conditions.get(pc) == null || conditions.get(pc).evaluate(context));
    }
}
```

### 3. å•æ­¥æ‰§è¡Œæ§åˆ¶å™¨
```java
public class VMRStepController {
    private ExecutionMode currentMode = ExecutionMode.PAUSE;
    private final VMRVisualBridge bridge;
    private final VMRBreakpointManager breakpointManager;
    
    public void step() {
        if (currentMode == ExecutionMode.STEP) {
            bridge.executeSingleInstruction();
        } else if (currentMode == ExecutionMode.STEP_OVER) {
            executeStepOver();
        } else if (currentMode == ExecutionMode.STEP_OUT) {
            executeStepOut();
        }
    }
    
    private void executeStepOver() {
        int currentDepth = bridge.getCallStackDepth();
        do {
            bridge.executeSingleInstruction();
        } while (bridge.getCallStackDepth() > currentDepth);
    }
}
```

## ğŸ¨ ç”¨æˆ·ç•Œé¢è®¾è®¡åŸåˆ™

### 1. å“åº”å¼è®¾è®¡
- **å®æ—¶æ›´æ–°**: çŠ¶æ€å˜åŒ–ç«‹å³åæ˜ åˆ°ç•Œé¢
- **æ€§èƒ½ä¼˜åŒ–**: æ‰¹å¤„ç†æ›´æ–°ï¼Œé¿å…é¢‘ç¹é‡ç»˜
- **çº¿ç¨‹å®‰å…¨**: Swing æ›´æ–°åœ¨ EDT ä¸­æ‰§è¡Œ

### 2. å¯ç”¨æ€§åŸåˆ™
- **ä¸€è‡´æ€§**: éµå¾ª Java Swing è®¾è®¡è§„èŒƒ
- **åé¦ˆ**: ç”¨æˆ·æ“ä½œç«‹å³å¾—åˆ°è§†è§‰åé¦ˆ
- **å®¹é”™**: é”™è¯¯å¤„ç†å’Œä¼˜é›…é™çº§

### 3. å¯è®¿é—®æ€§
- **é”®ç›˜å¯¼èˆª**: æ”¯æŒå¸¸ç”¨å¿«æ·é”®
- **é«˜å¯¹æ¯”åº¦**: æ”¯æŒè‰²ç›²å‹å¥½é…è‰²æ–¹æ¡ˆ
- **ç¼©æ”¾æ”¯æŒ**: ç•Œé¢å…ƒç´ å¯ç¼©æ”¾

### 4. ä¸»é¢˜æ”¯æŒ
```java
public enum VMRTheme {
    LIGHT("Light"),      // äº®è‰²ä¸»é¢˜
    DARK("Dark"),        // æš—è‰²ä¸»é¢˜
    CLASSIC("Classic"),  // ç»å…¸ä¸»é¢˜ï¼ˆç±»ä¼¼IDEï¼‰
    HIGH_CONTRAST("High Contrast"); // é«˜å¯¹æ¯”åº¦ä¸»é¢˜
}
```

## ğŸ”§ é…ç½®ç®¡ç†

### 1. é…ç½®æ–‡ä»¶æ ¼å¼ (JSON)
```json
{
  "window": {
    "width": 1200,
    "height": 800,
    "maximized": false,
    "position": {"x": 100, "y": 100}
  },
  "theme": "CLASSIC",
  "updateInterval": 100,
  "maxHistorySize": 1000,
  "breakpoints": [0x100, 0x200, 0x300],
  "showHexValues": true,
  "showDecimalValues": true,
  "showAsciiValues": false
}
```

### 2. é…ç½®ç®¡ç†ç±»
```java
public class VMRConfig {
    private int windowWidth;
    private int windowHeight;
    private boolean windowMaximized;
    private Point windowPosition;
    private VMRTheme theme;
    private int updateInterval;
    private int maxHistorySize;
    private Set<Integer> breakpoints;
    private boolean showHexValues;
    private boolean showDecimalValues;
    private boolean showAsciiValues;
    
    // é…ç½®åŠ è½½å’Œä¿å­˜
    public void loadFromFile(String path) { ... }
    public void saveToFile(String path) { ... }
    public void applyToUI(MainFrame frame) { ... }
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- **äº‹ä»¶ç³»ç»Ÿ**: æµ‹è¯•äº‹ä»¶åˆ›å»ºã€åˆ†å‘ã€å¤„ç†
- **çŠ¶æ€æ¨¡å‹**: æµ‹è¯•çŠ¶æ€æ›´æ–°ã€é€šçŸ¥ã€åºåˆ—åŒ–
- **å·¥å…·ç±»**: æµ‹è¯•æ ¼å¼åŒ–ã€é¢œè‰²ç®¡ç†ã€èµ„æºåŠ è½½

### 2. é›†æˆæµ‹è¯•
- **è™šæ‹Ÿæœºé›†æˆ**: æµ‹è¯•ä¸ EP18R çš„é›†æˆ
- **GUIé›†æˆ**: æµ‹è¯•ç»„ä»¶ååŒå·¥ä½œ
- **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´å·¥ä½œæµæµ‹è¯•

### 3. UIæµ‹è¯•
- **åŠŸèƒ½æµ‹è¯•**: æµ‹è¯•æŒ‰é’®ç‚¹å‡»ã€èœå•æ“ä½œ
- **å¯è§†åŒ–æµ‹è¯•**: æµ‹è¯•æ¸²æŸ“æ­£ç¡®æ€§
- **äº¤äº’æµ‹è¯•**: æµ‹è¯•ç”¨æˆ·äº¤äº’æµç¨‹

### 4. æ€§èƒ½æµ‹è¯•
- **å†…å­˜ä½¿ç”¨**: ç›‘æ§å†…å­˜æ³„æ¼
- **å“åº”æ—¶é—´**: æµ‹è¯•ç•Œé¢å“åº”é€Ÿåº¦
- **å¹¶å‘æµ‹è¯•**: æµ‹è¯•å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§

## ğŸ”„ éƒ¨ç½²å’Œç»´æŠ¤

### 1. æ„å»ºé…ç½® (Maven)
```xml
<dependencies>
    <dependency>
        <groupId>org.teachfx</groupId>
        <artifactId>ep18r</artifactId>
        <version>1.0.0</version>
    </dependency>
</dependencies>
```

### 2. è¿è¡Œè¦æ±‚
- **Javaç‰ˆæœ¬**: JDK 21+
- **å†…å­˜è¦æ±‚**: æœ€å° 512MBï¼Œæ¨è 1GB
- **å±å¹•åˆ†è¾¨ç‡**: æœ€å° 1024Ã—768ï¼Œæ¨è 1280Ã—1024

### 3. æ‰“åŒ…å‘å¸ƒ
- **JARæ‰“åŒ…**: åŒ…å«æ‰€æœ‰ä¾èµ–
- **å¯åŠ¨è„šæœ¬**: æä¾›è·¨å¹³å°å¯åŠ¨è„šæœ¬
- **å®‰è£…ç¨‹åº**: å¯é€‰å®‰è£…ç¨‹åºï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰

## ğŸ“ˆ æœªæ¥æ‰©å±•

### 1. åŠŸèƒ½æ‰©å±•
- **æ€§èƒ½åˆ†æå™¨**: æŒ‡ä»¤é¢‘ç‡åˆ†æã€çƒ­ç‚¹è¯†åˆ«
- **å†…å­˜åˆ†æå™¨**: å†…å­˜æ³„æ¼æ£€æµ‹ã€ä½¿ç”¨æ¨¡å¼åˆ†æ
- **ä»£ç è¦†ç›–**: æ‰§è¡Œè·¯å¾„è¦†ç›–åˆ†æ
- **åç¼–è¯‘å™¨**: é«˜çº§åæ±‡ç¼–å’Œä»£ç åˆ†æ

### 2. æŠ€æœ¯å‡çº§
- **JavaFXè¿ç§»**: ä» Swing è¿ç§»åˆ° JavaFX
- **Webç‰ˆæœ¬**: åŸºäº Web çš„å¯è§†åŒ–ç•Œé¢
- **æ’ä»¶ç³»ç»Ÿ**: æ”¯æŒç¬¬ä¸‰æ–¹æ’ä»¶æ‰©å±•

### 3. é›†æˆæ‰©å±•
- **IDEé›†æˆ**: ä½œä¸º IDE æ’ä»¶
- **æ•™å­¦å¹³å°**: é›†æˆåˆ°åœ¨çº¿æ•™å­¦å¹³å°
- **CI/CDé›†æˆ**: è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯

## ğŸ“ è®¾è®¡å†³ç­–è®°å½•

### 1. æ¶æ„å†³ç­–
- **é€‰æ‹©Java Swing**: æ ‡å‡†åº“ï¼Œæ— é¢å¤–ä¾èµ–ï¼Œæˆç†Ÿç¨³å®š
- **è§‚å¯Ÿè€…æ¨¡å¼**: æ¾è€¦åˆï¼Œæ˜“äºæ‰©å±•
- **åå°„é€‚é…å™¨**: ä¸ä¿®æ”¹ EP18R æºä»£ç ï¼Œä¿æŒæ¨¡å—ç‹¬ç«‹

### 2. æ€§èƒ½å†³ç­–
- **æ‰¹å¤„ç†æ›´æ–°**: å‡å°‘äº‹ä»¶é€šçŸ¥é¢‘ç‡
- **æ‡’åŠ è½½**: æŒ‰éœ€åŠ è½½åæ±‡ç¼–å’Œæ ¼å¼åŒ–æ•°æ®
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®

### 3. ç”¨æˆ·ä½“éªŒå†³ç­–
- **å¤šä¸»é¢˜æ”¯æŒ**: é€‚åº”ä¸åŒç”¨æˆ·åå¥½
- **å¿«æ·é”®**: æé«˜ä¸“å®¶ç”¨æˆ·æ•ˆç‡
- **æ¸è¿›å¼æŠ«éœ²**: é«˜çº§åŠŸèƒ½é»˜è®¤éšè—

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1
**åˆ›å»ºæ—¥æœŸ**: 2026-01-14
**æœ€åæ›´æ–°**: 2026-01-16
**ç»´æŠ¤è€…**: EP18Rå¼€å‘å›¢é˜Ÿ

### æ›´æ–°è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 1.1 | 2026-01-16 | æ·»åŠ  `vmStateChanged()` åˆ° VMRStateListenerï¼›æ›´æ–° VMRStateModel çš„ heap/globals ä¸ºé finalï¼›æ›´æ–°åŒ…ç»“æ„ä»¥åŒ¹é…å®é™…å®ç° |
| 1.0 | 2026-01-14 | åˆå§‹ç‰ˆæœ¬ |
