# VM目标适配任务分解表

**文档版本**: v1.0
**创建日期**: 2025-12-23
**关联文档**: `VM_TARGET_EVALUATION.md`

---

## 1. 任务总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        VM目标适配任务分解                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  EP21 (调节中心)                                                            │
│  ├── TASK-VM-01: 统一代码生成接口 ICodeGenerator                            │
│  ├── TASK-VM-02: 适配器选择器 VMCodeGeneratorSelector                       │
│  ├── TASK-VM-03: 栈式VM目标生成器 StackVMGenerator (重构CymbolAssembler)    │
│  ├── TASK-VM-04: 寄存器VM目标生成器 RegisterVMGenerator ← [EP18R依赖]       │
│  └── TASK-VM-05: EP21→EP18R集成测试                                         │
│                                                                             │
│  EP18R (高优先级任务)                                                        │
│  ├── TASK-18R-VM-01: 寄存器分配器 IRegisterAllocator ← [EP21依赖]           │
│  ├── TASK-18R-VM-02: 线性扫描寄存器分配器 LinearScanAllocator ← [高优先]    │
│  ├── TASK-18R-VM-03: EP18R代码生成器 RegisterAssembler ← [高优先]           │
│  ├── TASK-18R-VM-04: 32位字节码编码器 ByteCodeEncoder                       │
│  ├── TASK-18R-VM-05: EP18R调用约定实现 RegisterCallingConvention            │
│  └── TASK-18R-VM-06: EP18R→EP21适配器接口 RegisterVMAdapter                 │
│                                                                             │
│  EP18 (基础设施支持)                                                         │
│  ├── TASK-18-VM-01: 字节码定义接口抽象 BytecodeDefinitionInterface          │
│  ├── TASK-18-VM-02: EP18栈帧布局导出 StackFrameLayoutExporter               │
│  └── TASK-18-VM-03: 现有CymbolAssembler作为StackVMGenerator基础             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. EP21 任务详情

### TASK-VM-01: 统一代码生成接口 ICodeGenerator

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-VM-01 |
| **描述** | 定义与VM无关的代码生成器接口 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 高 |
| **负责EP** | EP21 |
| **依赖项** | 无 |
| **预计工时** | 2小时 |
| **验收标准** | 接口定义清晰，支持栈式/寄存器两种目标 |

**子任务**:
- 定义 `ICodeGenerator` 接口
- 定义 `CodeGenerationResult` 结果类
- 定义 `IEmitter` 指令发射器接口

### TASK-VM-02: 适配器选择器 VMCodeGeneratorSelector

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-VM-02 |
| **描述** | 根据配置选择对应的代码生成器 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 高 |
| **负责EP** | EP21 |
| **依赖项** | TASK-VM-01 |
| **预计工时** | 1小时 |
| **验收标准** | 支持STACK_VM和REGISTER_VM两种目标选择 |

### TASK-VM-03: 栈式VM目标生成器 StackVMGenerator

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-VM-03 |
| **描述** | 将现有CymbolAssembler重构为StackVMGenerator |
| **状态** | ⏸️ 未开始 |
| **优先级** | 高 |
| **负责EP** | EP21 |
| **依赖项** | TASK-VM-01 |
| **预计工时** | 4小时 |
| **验收标准** | 重构后接口统一，功能等价于原CymbolAssembler |

### TASK-VM-04: 寄存器VM目标生成器 RegisterVMGenerator

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-VM-04 |
| **描述** | 实现EP18R目标代码生成器 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 高 |
| **负责EP** | EP21 |
| **依赖项** | TASK-VM-01, TASK-18R-VM-02, TASK-18R-VM-03 |
| **预计工时** | 8小时 |
| **验收标准** | 支持寄存器分配，生成有效的EP18R字节码 |

### TASK-VM-05: EP21→EP18R集成测试

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-VM-05 |
| **描述** | 端到端编译测试，验证语义等价性 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 中 |
| **负责EP** | EP21 |
| **依赖项** | TASK-VM-04 |
| **预计工时** | 4小时 |
| **验收标准** | EP18和EP18R执行结果一致 |

---

## 3. EP18R 任务详情 (高优先级)

### TASK-18R-VM-01: 寄存器分配器接口 IRegisterAllocator

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18R-VM-01 |
| **描述** | 定义寄存器分配器接口 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 🔴 **高** |
| **负责EP** | EP18R |
| **依赖项** | 无 |
| **预计工时** | 2小时 |
| **验收标准** | 接口支持简单分配和线性扫描两种实现 |
| **EP21依赖** | TASK-VM-04需要此接口实现 |

### TASK-18R-VM-02: 线性扫描寄存器分配器 LinearScanAllocator

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18R-VM-02 |
| **描述** | 实现线性扫描寄存器分配算法 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 🔴 **高** |
| **负责EP** | EP18R |
| **依赖项** | TASK-18R-VM-01 |
| **预计工时** | 8小时 |
| **验收标准** | 正确处理寄存器溢出，支持16个物理寄存器 |
| **EP21依赖** | TASK-VM-04需要此实现 |

### TASK-18R-VM-03: EP18R代码生成器 RegisterAssembler

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18R-VM-03 |
| **描述** | 实现EP18R字节码生成器 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 🔴 **高** |
| **负责EP** | EP18R |
| **依赖项** | TASK-18R-VM-01, TASK-18R-VM-04 |
| **预计工时** | 8小时 |
| **验收标准** | 生成符合32位固定格式的EP18R字节码 |
| **EP21依赖** | TASK-VM-04需要此生成器 |

### TASK-18R-VM-04: 32位字节码编码器 ByteCodeEncoder

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18R-VM-04 |
| **描述** | 将指令编码为32位固定长度字节码 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 高 |
| **负责EP** | EP18R |
| **依赖项** | BytecodeDefinition |
| **预计工时** | 4小时 |
| **验收标准** | 正确编码R-type、I-type、J-type指令 |

### TASK-18R-VM-05: EP18R调用约定实现 RegisterCallingConvention

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18R-VM-05 |
| **描述** | 实现寄存器VM调用约定工具 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 中 |
| **负责EP** | EP18R |
| **依赖项** | CallingConventionUtils (已有) |
| **预计工时** | 4小时 |
| **验收标准** | 与现有CallingConventionUtils兼容 |

### TASK-18R-VM-06: EP18R→EP21适配器接口 RegisterVMAdapter

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18R-VM-06 |
| **描述** | 定义EP18R与EP21代码生成的接口适配 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 中 |
| **负责EP** | EP18R |
| **依赖项** | TASK-18R-VM-03, TASK-18R-VM-04 |
| **预计工时** | 2小时 |
| **验收标准** | EP21可通过接口调用EP18R代码生成 |

---

## 4. EP18 任务详情

### TASK-18-VM-01: 字节码定义接口抽象 BytecodeDefinitionInterface

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18-VM-01 |
| **描述** | 抽象字节码定义，便于EP21统一访问 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 低 |
| **负责EP** | EP18 |
| **依赖项** | 无 |
| **预计工时** | 2小时 |
| **验收标准** | 提供统一的指令定义查询接口 |

### TASK-18-VM-02: 栈帧布局导出 StackFrameLayoutExporter

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18-VM-02 |
| **描述** | 导出EP18栈帧布局信息供代码生成器使用 |
| **状态** | ⏸️ 未开始 |
| **优先级** | 低 |
| **负责EP** | EP18 |
| **依赖项** | StackFrame |
| **预计工时** | 2小时 |
| **验收标准** | 提供栈帧偏移量计算工具 |

### TASK-18-VM-03: CymbolAssembler重构为StackVMGenerator

| 属性 | 值 |
|------|-----|
| **任务ID** | TASK-18-VM-03 |
| **描述** | EP21重构CymbolAssembler为StackVMGenerator |
| **状态** | ⏸️ 未开始 |
| **优先级** | 高 |
| **负责EP** | EP21 (在EP18代码基础上重构) |
| **依赖项** | 无 |
| **预计工时** | 4小时 |
| **验收标准** | 保持原有功能，实现统一接口 |

---

## 5. 依赖关系图

```
EP18R 高优先级任务依赖链
=========================

TASK-18R-VM-01 (接口定义)
        │
        v
TASK-18R-VM-02 (寄存器分配器) ────────┐
        │                              │
        v                              v
TASK-18R-VM-04 (字节码编码) ←─────────┤
        │                              │
        v                              │
TASK-18R-VM-03 (代码生成器) ──────────┤
        │                              │
        v                              v
TASK-18R-VM-06 (适配器接口) ──────────┤
        │                              │
        +──────────────────────────────┘
                  │
                  v
         TASK-VM-04 (EP21 RegisterVMGenerator)
                  │
                  v
         TASK-VM-05 (集成测试)


EP18 支持任务
=========================

TASK-18-VM-01 (接口抽象)
        │
        v
TASK-18-VM-02 (栈帧导出)
        │
        v
TASK-VM-03 (EP21 StackVMGenerator)
        (基于EP18代码)
```

---

## 6. 执行优先级

### Phase 1: 基础设施 (EP21主导)

| 顺序 | 任务 | EP | 优先级 |
|------|------|-----|--------|
| 1 | TASK-VM-01: 统一代码生成接口 | EP21 | 高 |
| 2 | TASK-18R-VM-01: 寄存器分配器接口 | EP18R | 高 |
| 3 | TASK-VM-02: 适配器选择器 | EP21 | 高 |

### Phase 2: EP18R 高优先级实现

| 顺序 | 任务 | EP | 优先级 |
|------|------|-----|--------|
| 4 | TASK-18R-VM-04: 32位字节码编码器 | EP18R | 高 |
| 5 | TASK-18R-VM-02: 线性扫描寄存器分配器 | EP18R | 高 |
| 6 | TASK-18R-VM-03: EP18R代码生成器 | EP18R | 高 |

### Phase 3: EP21集成

| 顺序 | 任务 | EP | 优先级 |
|------|------|-----|--------|
| 7 | TASK-VM-03: StackVMGenerator | EP21 | 高 |
| 8 | TASK-VM-04: RegisterVMGenerator | EP21 | 高 |
| 9 | TASK-18R-VM-05: 调用约定实现 | EP18R | 中 |
| 10 | TASK-18R-VM-06: 适配器接口 | EP18R | 中 |

### Phase 4: 测试验证

| 顺序 | 任务 | EP | 优先级 |
|------|------|-----|--------|
| 11 | TASK-VM-05: 端到端测试 | EP21 | 中 |
| 12 | TASK-18-VM-01~02: EP18接口抽象 | EP18 | 低 |

---

## 7. 验收标准

### 功能验收

- [ ] EP21可选择编译目标为EP18或EP18R
- [ ] 两种目标的执行结果语义等价
- [ ] 寄存器分配正确处理16个物理寄存器
- [ ] 字节码格式符合各VM规范

### 性能验收

- [ ] 寄存器分配算法复杂度可接受 (O(n))
- [ ] 代码生成时间增加 < 20%

### 测试验收

- [ ] 新增代码生成测试覆盖率 ≥ 90%
- [ ] 端到端语义等价测试通过率 100%
- [ ] 无回归错误

---

## 8. 风险与缓解

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 寄存器分配算法复杂 | 中 | 高 | 从简单分配开始，逐步完善 |
| EP18R字节码格式变更 | 低 | 高 | 抽象接口隔离变化 |
| 语义等价性验证困难 | 中 | 高 | 自动化测试 + 手工验证 |

---

**文档状态**: ✅ 已创建
**下次更新**: 各EP TDD文档同步后
