# EP18R 重构任务上下文摘要

**日期**: 2026-01-10
**会话状态**: 需要在新会话中继续执行

---

## 已完成任务 (9/15)

### Phase 6: 基础设施恢复 ✅
- ✅ TASK-BINFRA-001: 添加代码质量工具配置（CheckStyle、SpotBugs、JaCoCo）
- ✅ TASK-BINFRA-002: 建立基线测试覆盖（48%覆盖率）

### Phase 7: 代码重复消除 ✅
- ✅ TASK-DUPL-001: 创建RegisterOperandExtractor工具类
- ✅ TASK-DUPL-002: 创建AbstractInstructionExecutor模板
- ✅ 新增StackFrameManager类
- ✅ 新增ABIRegisters枚举
- ✅ 新增RegisterSaver类

### Phase 8: 上帝类拆分（进行中）✅
- ✅ TASK-GOD-001 部分完成: CallingConventionUtils核心逻辑已提取
- ✅ Task 8: 重构RegisterVMInterpreter.executeInstruction()降低复杂度
  - extract方法使用RegisterOperandExtractor替代
  - executeInstruction()从102行降低到约45行
  - 圈复杂度从约15降低到6
  - 提取了executeJump、executeJumpIfTrue、executeJumpIfFalse、executeLoadFloat、executeLoadString独立方法
- ✅ Task 9: 引入InstructionFactory统一管理指令执行器
  - 在InstructionMapper中新增registerExecutor()方法（动态注册指令）
  - 新增unregisterExecutor()方法（注销指令）
  - 新增clear()方法（清空所有指令）
  - 新增resetToDefaults()方法（重置为默认集）
  - 所有新增方法包含参数验证（操作码范围0-63）
  - 新增InstructionMapperTest单元测试（12个测试用例）

---

## 待执行任务 (6/15)

### 高优先级
- **TASK-GOD-001: 完成CallingConventionUtils拆分**
  - 创建ParameterPassing类
  - 创建ABIValidator类
  - 重构CallingConventionUtils为外观类

### 中优先级 (Phase 9)
- Task 10: 定义核心接口（IVirtualMachine、IInstructionExecutor、IVMConfig）
- Task 11: 重构包结构，按职责重新组织stackvm包
- Task 12: 实现依赖注入，使用构造器注入替代硬编码依赖

### 中优先级 (Phase 10)
- Task 13: 测试策略升级，提升测试覆盖率≥85%
- Task 14: 新增测试类（RegisterVMInterpreterUnitTest、InstructionExecutorTest等）

### 低优先级 (Phase 11)
- Task 15: 更新架构文档和代码规范Javadoc

---

## 关键文件修改记录

### 新增文件 (6个)
1. `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/RegisterOperandExtractor.java` (280行)
2. `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/AbstractInstructionExecutor.java` (150行)
3. `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/StackFrameManager.java` (150行)
4. `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/ABIRegisters.java` (70行)
5. `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/RegisterSaver.java` (80行)
6. `/ep18r/src/test/java/org/teachfx/antlr4/ep18r/stackvm/InstructionMapperTest.java` (190行)

### 修改文件
- `/ep18r/pom.xml`: 添加JaCoCo、CheckStyle、SpotBugs插件
- `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/RegisterVMInterpreter.java`:
  - extract方法使用RegisterOperandExtractor替代（5个方法重构）
  - executeInstruction()从102行降低到45行
  - 新增executeJump、executeJumpIfTrue、executeJumpIfFalse、validateJumpTarget、executeLoadFloat、executeLoadString方法
  - 总行数从556行增加到584行（新增6个独立方法，但主方法更简洁）
- `/ep18r/src/main/java/org/teachfx/antlr4/ep18r/stackvm/InstructionMapper.java`:
  - 新增registerExecutor(int opcode, InstructionExecutor executor)方法：动态注册指令执行器
  - 新增unregisterExecutor(int opcode)方法：注销指令执行器
  - 新增clear()方法：清空所有指令
  - 新增resetToDefaults()方法：重置为默认指令集
  - 所有新增方法包含参数验证（操作码范围0-63，executor非null）
  - 总行数从123行增加到161行（新增38行）

### 保留未修改文件
- `InstructionMapper.java` - 已有完整的指令映射
- `ControlFlowExecutors.java` - 已有CALL/RET实现
- `ArithmeticExecutors.java` - 已有算术指令执行器
- `MemoryExecutors.java` - 已有内存指令执行器

---

## 技术约束

### 不能删除的方法
- `RegisterVMInterpreter.exec()` - 被15+个测试文件调用
- `RegisterVMInterpreter.setJumpTarget()` - 被ExecutionContext使用
- `RegisterVMInterpreter.getCurrentFrame()` - 被ExecutionContext使用
- `RegisterVMInterpreter.findFunctionByAddress()` - 被ExecutionContext使用
- `RegisterVMInterpreter.getCode()` - 被测试文件使用

### 重要发现
- `InstructionMapper`已存在并映射所有42条指令
- `InstructionMapper`现在支持动态注册新指令（Task 9完成）
- `InstructionMapper`现在支持指令执行器的替换和注销
- `ControlFlowExecutors.CALL`和`RET`已实现完整栈帧管理
- `RegisterOperandExtractor`提供了统一的extract方法，可以直接替换现有的private extract*方法

---

## 下一步行动建议

### 立即执行 (TASK-GOD-001)
TASK-GOD-001: 完成CallingConventionUtils拆分
- 创建ParameterPassing类
- 创建ABIValidator类
- 重构CallingConventionUtils为外观类

### 短期 (Task 10-15)
按照TDD执行计划Phase 9-11顺序执行。

---

## 测试状态
- 总测试数: 131个（新增InstructionMapperTest: 12个测试用例）
- 通过率: 100% (131/131)
- 失败数: 0

---

**文档版本**: 1.2
**生成时间**: 2026-01-10 17:10
**最近更新**: Task 9完成 - InstructionMapper动态注册功能
