# 语法规则

<cite>
**本文档中引用的文件**  
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4)
- [CymbolParser.java](file://ep16/src/main/java/org/teachfx/antlr4/ep16/parser/CymbolParser.java)
- [CymbolLexer.java](file://ep16/src/main/java/org/teachfx/antlr4/ep16/parser/CymbolLexer.java)
- [Compiler.java](file://ep16/src/main/java/org/teachfx/antlr4/ep16/Compiler.java)
</cite>

## 目录
1. [简介](#简介)
2. [词法结构](#词法结构)
3. [程序整体结构](#程序整体结构)
4. [声明语法](#声明语法)
5. [语句语法](#语句语法)
6. [表达式语法](#表达式语法)
7. [语法设计原理](#语法设计原理)

## 简介

Cymbol语言是一种教学用编程语言，其语法规则通过ANTLR4语法文件Cymbol.g4定义。该语言支持基本的变量声明、函数定义、控制流语句和表达式运算。语法规则采用EBNF（扩展巴科斯-诺尔范式）表示，通过递归下降解析器实现。Cymbol语言的设计旨在展示编译器前端的关键技术，包括词法分析、语法分析、作用域管理和解释执行。

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4#L1-L10)
- [Compiler.java](file://ep16/src/main/java/org/teachfx/antlr4/ep16/Compiler.java#L1-L10)

## 词法结构

Cymbol语言的词法结构定义了源代码中基本的词法单元（Token），包括标识符、关键字、字面量和运算符。

### 标识符与关键字
标识符（ID）由字母开头，后跟字母或数字组成。关键字是预定义的保留字，用于表示语言的语法结构。

```ebnf
ID : LETTER (LETTER | [0-9])* ;
LETTER : [a-zA-Z] ;
```

### 字面量
Cymbol支持多种字面量类型，包括整数、浮点数、字符、字符串和布尔值。

```ebnf
INT : [0-9]+ ;
FLOAT : INT? '.' INT ;
CHAR : '\'' . '\'' ;
STRING: '"' ~( '"' | '\r' | '\n' )* '"';
BOOLEAN: 'true' | 'false';
NULL : 'null';
```

### 运算符与分隔符
语言定义了算术、逻辑、关系和赋值运算符，以及括号、分号等分隔符。

```ebnf
'+' | '-' | '*' | '/' | '==' | '!=' | '>' | '>=' | '<' | '<=' | '!' | '='
'(' | ')' | '{' | '}' | ',' | ';'
```

### 空白与注释
空白字符（空格、制表符、换行符）被跳过。支持单行注释。

```ebnf
WS  : [ \t\n\r]+ -> skip ;
SLCOMMENT : '//' .*? '\n' -> skip ;
```

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4#L50-L65)

## 程序整体结构

Cymbol程序由一个或多个声明或语句组成，这些元素可以按任意顺序排列。

```ebnf
file : (functionDecl | varDecl | statetment)+ ;
```

程序的顶层结构是`file`规则，它匹配一个或多个函数声明、变量声明或语句的序列。这种设计允许在全局作用域中定义函数和变量，同时也支持全局语句的执行，这在脚本语言中很常见。

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4#L3)

## 声明语法

### 变量声明
变量声明由类型、标识符和可选的初始化表达式组成。

```ebnf
varDecl : type ID ('=' expr)? ';' ;
```

例如：`int x = 5;` 或 `float y;`。

### 类型系统
Cymbol支持预定义的基本类型和用户定义的类型。

```ebnf
type: primaryType | ID ;
primaryType: 'float' | 'int' | 'void';
```

`primaryType`包含`float`、`int`和`void`三种内置类型。`type`规则还允许使用标识符（ID）作为类型，这为支持结构体或类等用户定义类型提供了扩展性。

### 函数声明
函数声明包含返回类型、函数名、参数列表和函数体。

```ebnf
functionDecl : retType=type funcName=ID '(' params=formalParameters? ')' blockDef=block ;
```

参数列表由零个或多个形式参数组成，每个参数都有自己的类型和名称。

```ebnf
formalParameters : formalParameter (',' formalParameter)* ;
formalParameter : type ID ;
```

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4#L5-L18)

## 语句语法

Cymbol语言支持多种控制流语句。

### 块语句
块语句由一对花括号包围的零个或多个语句组成。

```ebnf
block: '{' statetment* '}' ;
```

### 控制流语句
- **if语句**：支持可选的else分支。
  ```ebnf
  'if' '(' cond=expr ')' then=statetment ('else' elseDo=statetment)?
  ```
- **while循环**：基于条件表达式的循环。
  ```ebnf
  'while' '(' cond=expr ')' then=statetment
  ```
- **return语句**：可选地返回一个表达式的值。
  ```ebnf
  'return' expr? ';'
  ```

### 赋值与表达式语句
- **赋值语句**：将表达式的值赋给另一个表达式（通常是变量）。
  ```ebnf
  expr '=' expr ';'
  ```
- **表达式语句**：执行一个表达式并丢弃其结果，常用于函数调用。
  ```ebnf
  expr ';'
  ```

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4#L20-L33)

## 表达式语法

Cymbol的表达式语法采用递归定义，以正确处理运算符优先级和结合性。

### 表达式分类
表达式规则（expr）是多选规则，根据不同的语法结构派生出不同的上下文类。

```ebnf
expr: ID '(' ( expr (',' expr)* )? ')' #exprFuncCall
    | '-' expr         #exprUnary
    | '!' expr         #exprUnary
    | expr o=('*'|'/') expr    #exprBinary
    | expr o=('+'|'-') expr #exprBinary
    | expr o=('=='|'!='|'>'|'>='|'<'|'<=') expr #exprBinary
    | primary #exprPrimary
    | '(' expr ')'         #exprGroup
    ;
```

### 运算符优先级
通过将表达式规则分层，实现了正确的运算符优先级。乘除法的优先级高于加减法，加减法的优先级高于关系运算，关系运算的优先级高于逻辑非和一元减。

### 原子表达式
`primary`规则定义了表达式的原子单元，包括变量引用、字面量等。

```ebnf
primary: ID #primaryID
    | INT #primaryINT
    | FLOAT #primaryFLOAT
    | CHAR #primaryCHAR
    | STRING #primarySTRING
    | BOOLEAN #primaryBOOL
    ;
```

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4#L35-L50)

## 语法设计原理

### 左递归消除
Cymbol的表达式语法避免了直接左递归，而是通过将二元运算符的左操作数定义为更高优先级的表达式来间接实现。例如，`expr o=('*'|'/') expr`中的第一个`expr`实际上是`unaryExpr`或`primary`，这确保了乘除法的左结合性，同时避免了无限递归。

### 运算符优先级与结合性
通过将不同优先级的运算符分配到不同的语法规则层次，自然地实现了优先级。同一层次的运算符（如`+`和`-`）具有相同的优先级，并通过左递归（在ANTLR中通过`expr op expr`模式）实现左结合性。

### 语法与语义分离
语法规则专注于结构的正确性，而语义分析（如类型检查、作用域解析）在解析后的遍历阶段完成。例如，`varDecl`规则只检查语法结构，而变量是否已声明、类型是否匹配等语义检查由`LocalDefine`和`LocalResolver`等访问者类处理。

### 扩展性
语法设计具有良好的扩展性。例如，`type`规则允许使用`ID`作为类型名，为将来添加结构体、类等复杂类型奠定了基础。`primary`规则中的`ID`可以轻松扩展为支持字段访问（如`obj.field`）。

**本节来源**
- [Cymbol.g4](file://ep16/src/main/antlr4/Cymbol.g4)
- [CymbolParser.java](file://ep16/src/main/java/org/teachfx/antlr4/ep16/parser/CymbolParser.java)
- [Compiler.java](file://ep16/src/main/java/org/teachfx/antlr4/ep16/Compiler.java)